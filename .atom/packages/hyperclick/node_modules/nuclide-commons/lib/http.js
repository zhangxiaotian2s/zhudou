
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var fs = require('fs');
var http = require('http');
var https = require('https');

// Although rfc forbids the usage of white space in content type
// (http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.7), it's still
// a common practice to use that so we need to deal with it in regex.
var contentTypeRe = /\s*\w+\/\w+\s*;\s*charset\s*=\s*([^\s]+)\s*/;

function getProtocolModule(url) {
  var _require$parse = require('url').parse(url);

  var protocol = _require$parse.protocol;

  if (protocol === 'http:') {
    return http;
  } else if (protocol === 'https:') {
    return https;
  } else {
    throw Error('Protocol ' + protocol + ' not supported');
  }
}

function getResponseBodyCharset(response) {
  var contentType = response.headers['content-type'];
  if (!contentType) {
    return null;
  }
  var match = contentTypeRe.exec(contentType);
  return match ? match[1] : null;
}

module.exports = {

  /**
   * Send Http(s) GET request to given url and return the body as string.
   */
  get: function get(url, headers) {
    return new Promise(function (resolve, reject) {
      var body = '';
      var options = require('url').parse(url);
      if (!options.hostname) {
        reject(new Error('Unable to determine the domain name of ' + url));
      }
      if (headers) {
        options.headers = headers;
      }
      getProtocolModule(url).get(options, function (response) {
        if (response.statusCode < 200 || response.statusCode >= 300) {
          reject('Bad status ' + response.statusCode);
        } else {
          var charset = getResponseBodyCharset(response);
          if (charset) {
            response.setEncoding(charset);
          }
          response.on('data', function (data) {
            return body += data;
          });
          response.on('end', function () {
            return resolve(body);
          });
        }
      }).on('error', reject);
    });
  },

  /**
   * Send Http(s) GET request to given url and save the body to dest file.
   */
  download: function download(url, dest) {
    return new Promise(function (resolve, reject) {
      var file = fs.createWriteStream(dest);
      getProtocolModule(url).get(url, function (response) {
        if (response.statusCode < 200 || response.statusCode >= 300) {
          reject('Bad status ' + response.statusCode);
        } else {
          response.on('error', reject);
          response.pipe(file);
          file.on('error', reject);
          file.on('finish', function () {
            return file.close(resolve);
          });
        }
      }).on('error', reject);
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWNvbW1vbnMvbGliL2h0dHAuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFDOzs7Ozs7Ozs7O0FBV1osSUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3pCLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM3QixJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7Ozs7O0FBSy9CLElBQU0sYUFBYSxHQUFHLDZDQUE2QyxDQUFDOztBQUVwRSxTQUFTLGlCQUFpQixDQUFDLEdBQVcsRUFBTzt1QkFDeEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7O01BQXJDLFFBQVEsa0JBQVIsUUFBUTs7QUFDZixNQUFJLFFBQVEsS0FBSyxPQUFPLEVBQUU7QUFDeEIsV0FBTyxJQUFJLENBQUM7R0FDYixNQUFNLElBQUksUUFBUSxLQUFLLFFBQVEsRUFBRTtBQUNoQyxXQUFPLEtBQUssQ0FBQztHQUNkLE1BQU07QUFDTCxVQUFNLEtBQUssZUFBYSxRQUFRLG9CQUFpQixDQUFDO0dBQ25EO0NBQ0Y7O0FBRUQsU0FBUyxzQkFBc0IsQ0FBQyxRQUFhLEVBQVc7QUFDdEQsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUNyRCxNQUFJLENBQUMsV0FBVyxFQUFFO0FBQ2hCLFdBQU8sSUFBSSxDQUFDO0dBQ2I7QUFDRCxNQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQzlDLFNBQU8sS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7Q0FDaEM7O0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRzs7Ozs7QUFLZixLQUFHLEVBQUEsYUFBQyxHQUFXLEVBQUUsT0FBZ0IsRUFBbUI7QUFDbEQsV0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUs7QUFDdEMsVUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQ2QsVUFBTSxPQUFlLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNsRCxVQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRTtBQUNyQixjQUFNLENBQUMsSUFBSSxLQUFLLDZDQUEyQyxHQUFHLENBQUcsQ0FBQyxDQUFDO09BQ3BFO0FBQ0QsVUFBSSxPQUFPLEVBQUU7QUFDWCxlQUFPLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztPQUMzQjtBQUNELHVCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsVUFBQyxRQUFRLEVBQUs7QUFDaEQsWUFBSSxRQUFRLENBQUMsVUFBVSxHQUFHLEdBQUcsSUFBSSxRQUFRLENBQUMsVUFBVSxJQUFJLEdBQUcsRUFBRTtBQUMzRCxnQkFBTSxpQkFBZSxRQUFRLENBQUMsVUFBVSxDQUFHLENBQUM7U0FDN0MsTUFBTTtBQUNMLGNBQU0sT0FBTyxHQUFHLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2pELGNBQUksT0FBTyxFQUFFO0FBQ1gsb0JBQVEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7V0FDL0I7QUFDRCxrQkFBUSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBQSxJQUFJO21CQUFJLElBQUksSUFBSSxJQUFJO1dBQUEsQ0FBQyxDQUFDO0FBQzFDLGtCQUFRLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRTttQkFBTSxPQUFPLENBQUMsSUFBSSxDQUFDO1dBQUEsQ0FBQyxDQUFDO1NBQ3pDO09BQ0YsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDeEIsQ0FBQyxDQUFDO0dBQ0o7Ozs7O0FBS0QsVUFBUSxFQUFBLGtCQUFDLEdBQVcsRUFBRSxJQUFZLEVBQWlCO0FBQ2pELFdBQU8sSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFLO0FBQ3RDLFVBQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN4Qyx1QkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLFVBQUMsUUFBUSxFQUFLO0FBQzVDLFlBQUksUUFBUSxDQUFDLFVBQVUsR0FBRyxHQUFHLElBQUksUUFBUSxDQUFDLFVBQVUsSUFBSSxHQUFHLEVBQUU7QUFDM0QsZ0JBQU0saUJBQWUsUUFBUSxDQUFDLFVBQVUsQ0FBRyxDQUFDO1NBQzdDLE1BQU07QUFDTCxrQkFBUSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDN0Isa0JBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDcEIsY0FBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDekIsY0FBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUU7bUJBQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUM7V0FBQSxDQUFDLENBQUM7U0FDOUM7T0FDRixDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztLQUN4QixDQUFDLENBQUM7R0FDSjtDQUNGLENBQUMiLCJmaWxlIjoiL3Zhci9mb2xkZXJzL3hmL3JzcGg0X2M1NzMxNXJzNTd4eHNkc2tyeG52MzZ0MC9UL3RtcHBmbDUybnB1Ymxpc2hfcGFja2FnZXMvbnBtL251Y2xpZGUtY29tbW9ucy9saWIvaHR0cC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IGh0dHAgPSByZXF1aXJlKCdodHRwJyk7XG5jb25zdCBodHRwcyA9IHJlcXVpcmUoJ2h0dHBzJyk7XG5cbi8vIEFsdGhvdWdoIHJmYyBmb3JiaWRzIHRoZSB1c2FnZSBvZiB3aGl0ZSBzcGFjZSBpbiBjb250ZW50IHR5cGVcbi8vIChodHRwOi8vd3d3LnczLm9yZy9Qcm90b2NvbHMvcmZjMjYxNi9yZmMyNjE2LXNlYzMuaHRtbCNzZWMzLjcpLCBpdCdzIHN0aWxsXG4vLyBhIGNvbW1vbiBwcmFjdGljZSB0byB1c2UgdGhhdCBzbyB3ZSBuZWVkIHRvIGRlYWwgd2l0aCBpdCBpbiByZWdleC5cbmNvbnN0IGNvbnRlbnRUeXBlUmUgPSAvXFxzKlxcdytcXC9cXHcrXFxzKjtcXHMqY2hhcnNldFxccyo9XFxzKihbXlxcc10rKVxccyovO1xuXG5mdW5jdGlvbiBnZXRQcm90b2NvbE1vZHVsZSh1cmw6IHN0cmluZyk6IGFueSB7XG4gIGNvbnN0IHtwcm90b2NvbH0gPSByZXF1aXJlKCd1cmwnKS5wYXJzZSh1cmwpO1xuICBpZiAocHJvdG9jb2wgPT09ICdodHRwOicpIHtcbiAgICByZXR1cm4gaHR0cDtcbiAgfSBlbHNlIGlmIChwcm90b2NvbCA9PT0gJ2h0dHBzOicpIHtcbiAgICByZXR1cm4gaHR0cHM7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgRXJyb3IoYFByb3RvY29sICR7cHJvdG9jb2x9IG5vdCBzdXBwb3J0ZWRgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRSZXNwb25zZUJvZHlDaGFyc2V0KHJlc3BvbnNlOiBhbnkpOiA/c3RyaW5nIHtcbiAgY29uc3QgY29udGVudFR5cGUgPSByZXNwb25zZS5oZWFkZXJzWydjb250ZW50LXR5cGUnXTtcbiAgaWYgKCFjb250ZW50VHlwZSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGNvbnN0IG1hdGNoID0gY29udGVudFR5cGVSZS5leGVjKGNvbnRlbnRUeXBlKTtcbiAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAvKipcbiAgICogU2VuZCBIdHRwKHMpIEdFVCByZXF1ZXN0IHRvIGdpdmVuIHVybCBhbmQgcmV0dXJuIHRoZSBib2R5IGFzIHN0cmluZy5cbiAgICovXG4gIGdldCh1cmw6IHN0cmluZywgaGVhZGVyczogP09iamVjdCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxldCBib2R5ID0gJyc7XG4gICAgICBjb25zdCBvcHRpb25zOiBPYmplY3QgPSByZXF1aXJlKCd1cmwnKS5wYXJzZSh1cmwpO1xuICAgICAgaWYgKCFvcHRpb25zLmhvc3RuYW1lKSB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFVuYWJsZSB0byBkZXRlcm1pbmUgdGhlIGRvbWFpbiBuYW1lIG9mICR7dXJsfWApKTtcbiAgICAgIH1cbiAgICAgIGlmIChoZWFkZXJzKSB7XG4gICAgICAgIG9wdGlvbnMuaGVhZGVycyA9IGhlYWRlcnM7XG4gICAgICB9XG4gICAgICBnZXRQcm90b2NvbE1vZHVsZSh1cmwpLmdldChvcHRpb25zLCAocmVzcG9uc2UpID0+IHtcbiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPCAyMDAgfHwgcmVzcG9uc2Uuc3RhdHVzQ29kZSA+PSAzMDApIHtcbiAgICAgICAgICByZWplY3QoYEJhZCBzdGF0dXMgJHtyZXNwb25zZS5zdGF0dXNDb2RlfWApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGNoYXJzZXQgPSBnZXRSZXNwb25zZUJvZHlDaGFyc2V0KHJlc3BvbnNlKTtcbiAgICAgICAgICBpZiAoY2hhcnNldCkge1xuICAgICAgICAgICAgcmVzcG9uc2Uuc2V0RW5jb2RpbmcoY2hhcnNldCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJlc3BvbnNlLm9uKCdkYXRhJywgZGF0YSA9PiBib2R5ICs9IGRhdGEpO1xuICAgICAgICAgIHJlc3BvbnNlLm9uKCdlbmQnLCAoKSA9PiByZXNvbHZlKGJvZHkpKTtcbiAgICAgICAgfVxuICAgICAgfSkub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICB9KTtcbiAgfSxcblxuICAvKipcbiAgICogU2VuZCBIdHRwKHMpIEdFVCByZXF1ZXN0IHRvIGdpdmVuIHVybCBhbmQgc2F2ZSB0aGUgYm9keSB0byBkZXN0IGZpbGUuXG4gICAqL1xuICBkb3dubG9hZCh1cmw6IHN0cmluZywgZGVzdDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGZpbGUgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShkZXN0KTtcbiAgICAgIGdldFByb3RvY29sTW9kdWxlKHVybCkuZ2V0KHVybCwgKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlIDwgMjAwIHx8IHJlc3BvbnNlLnN0YXR1c0NvZGUgPj0gMzAwKSB7XG4gICAgICAgICAgcmVqZWN0KGBCYWQgc3RhdHVzICR7cmVzcG9uc2Uuc3RhdHVzQ29kZX1gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNwb25zZS5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICAgIHJlc3BvbnNlLnBpcGUoZmlsZSk7XG4gICAgICAgICAgZmlsZS5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICAgIGZpbGUub24oJ2ZpbmlzaCcsICgpID0+IGZpbGUuY2xvc2UocmVzb2x2ZSkpO1xuICAgICAgICB9XG4gICAgICB9KS5vbignZXJyb3InLCByZWplY3QpO1xuICAgIH0pO1xuICB9LFxufTtcbiJdfQ==
