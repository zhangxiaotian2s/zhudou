

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _utils = require('./utils');

var _helpersJs = require('./helpers.js');

var _ObjectId = require('./ObjectId');

/**
 * Converts a dbgp value to a Chrome RemoteObject.
 */
'use babel';
function convertValue(contextId, dbgpProperty) {
  switch (dbgpProperty.$.type) {
    case 'string':
      return convertStringValue(dbgpProperty);
    case 'int':
      return convertIntValue(dbgpProperty);
    case 'float':
      return convertFloatValue(dbgpProperty);
    case 'bool':
      return convertBoolValue(dbgpProperty);
    case 'null':
      return convertNullValue(dbgpProperty);
    case 'array':
      return convertArrayValue(contextId, dbgpProperty);
    case 'object':
      return convertObjectValue(contextId, dbgpProperty);
    default:
      // TODO: Remaining property types - closure, hashmap, ...
      return convertUnknownValue(dbgpProperty);
  }
}

function convertStringValue(dbgpProperty) {
  var value = undefined;
  if (dbgpProperty.hasOwnProperty('_')) {
    value = dbgpProperty.$.encoding === 'base64' ? (0, _helpersJs.base64Decode)(dbgpProperty._) : 'TODO: Non-base64 encoded string: ' + JSON.stringify(dbgpProperty);
  } else {
    // zero length strings have no dbgpProperty._ property
    value = '';
  }

  return {
    type: 'string',
    value: value
  };
}

function convertIntValue(dbgpProperty) {
  var value = dbgpProperty.$.encoding === 'base64' ? 'TODO: Base64 encoded int: ' + JSON.stringify(dbgpProperty) : dbgpProperty._;
  return {
    type: 'number',
    value: value
  };
}

function convertFloatValue(dbgpProperty) {
  var value = dbgpProperty.$.encoding === 'base64' ? 'TODO: Base64 encoded float: ' + JSON.stringify(dbgpProperty) : dbgpProperty._;
  return {
    type: 'number',
    value: value
  };
}

function convertBoolValue(dbgpProperty) {
  var value = dbgpProperty.$.encoding === 'base64' ? 'TODO: Base64 encoded bool: ' + JSON.stringify(dbgpProperty) : toBool(dbgpProperty._);
  return {
    type: 'boolean',
    value: value
  };
}

function convertNullValue(dbgpProperty) {
  return {
    type: 'undefined',
    subtype: 'null',
    value: null
  };
}

function convertArrayValue(contextId, dbgpProperty) {
  var remoteId = getAggregateRemoteObjectId(contextId, dbgpProperty);
  return {
    description: 'Array[' + dbgpProperty.$.numchildren + ']',
    type: 'object',
    subtype: 'array',
    objectId: remoteId
  };
}

function convertObjectValue(contextId, dbgpProperty) {
  var remoteId = getAggregateRemoteObjectId(contextId, dbgpProperty);
  return {
    description: dbgpProperty.$.classname,
    type: 'object',
    objectId: remoteId
  };
}

function getAggregateRemoteObjectId(contextId, dbgpProperty) {
  var numchildren = Number(dbgpProperty.$.numchildren);
  var pagesize = Number(dbgpProperty.$.pagesize);
  var pageCount = Math.trunc((numchildren + pagesize - 1) / pagesize);
  (0, _utils.log)('numchildren: ' + numchildren + ' pagesize: ' + pagesize + ' pageCount ' + pageCount);
  if (pageCount > 1) {
    var elementRange = {
      pagesize: pagesize,
      startIndex: 0,
      count: numchildren
    };
    return (0, _ObjectId.remoteObjectIdOfObjectId)((0, _ObjectId.pagedObjectId)(contextId, dbgpProperty.$.fullname, elementRange));
  } else {
    return (0, _ObjectId.remoteObjectIdOfObjectId)((0, _ObjectId.singlePageObjectId)(contextId, dbgpProperty.$.fullname, 0));
  }
}

function convertUnknownValue(dbgpProperty) {
  return {
    type: 'string',
    value: 'TODO: unknown: ' + JSON.stringify(dbgpProperty)
  };
}

function toBool(value) {
  switch (value) {
    case '0':
      return false;
    case '1':
      return true;
    default:
      return 'Unexpected bool value: ' + value;
  }
}

module.exports = { convertValue: convertValue };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL3ZhbHVlcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O3FCQVlrQixTQUFTOzt5QkFDQSxjQUFjOzt3QkFLbEMsWUFBWTs7Ozs7QUFsQm5CLFdBQVcsQ0FBQztBQXVCWixTQUFTLFlBQVksQ0FBQyxTQUFtQixFQUFFLFlBQTBCLEVBQWdCO0FBQ25GLFVBQVEsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJO0FBQ3pCLFNBQUssUUFBUTtBQUNYLGFBQU8sa0JBQWtCLENBQUMsWUFBWSxDQUFDLENBQUM7QUFBQSxBQUMxQyxTQUFLLEtBQUs7QUFDUixhQUFPLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUFBLEFBQ3ZDLFNBQUssT0FBTztBQUNWLGFBQU8saUJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUM7QUFBQSxBQUN6QyxTQUFLLE1BQU07QUFDVCxhQUFPLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQUEsQUFDeEMsU0FBSyxNQUFNO0FBQ1QsYUFBTyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUFBLEFBQ3hDLFNBQUssT0FBTztBQUNWLGFBQU8saUJBQWlCLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQUEsQUFDcEQsU0FBSyxRQUFRO0FBQ1gsYUFBTyxrQkFBa0IsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7QUFBQSxBQUNyRDs7QUFFRSxhQUFPLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQUEsR0FDNUM7Q0FDRjs7QUFFRCxTQUFTLGtCQUFrQixDQUFDLFlBQTBCLEVBQWdCO0FBQ3BFLE1BQUksS0FBSyxZQUFBLENBQUM7QUFDVixNQUFJLFlBQVksQ0FBQyxjQUFjLENBQUMsR0FBRyxD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VyxXQUFXLG1CQUFjLFFBQVEsbUJBQWMsU0FBUyxDQUFHLENBQUE7QUFDL0UsTUFBSSxTQUFTLEdBQUcsQ0FBQyxFQUFFO0FBQ2pCLFFBQU0sWUFBWSxHQUFHO0FBQ25CLGNBQVEsRUFBUixRQUFRO0FBQ1IsZ0JBQVUsRUFBRSxDQUFDO0FBQ2IsV0FBSyxFQUFFLFdBQVc7S0FDbkIsQ0FBQztBQUNGLFdBQU8sY0FqSFQsd0JBQXdCLEVBaUhVLGNBaEhsQyxhQUFhLEVBZ0htQyxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQztHQUNsRyxNQUFNO0FBQ0wsV0FBTyxjQW5IVCx3QkFBd0IsRUFtSFUsY0FqSGxDLGtCQUFrQixFQWlIbUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7R0FDNUY7Q0FDRjs7QUFFRCxTQUFTLG1CQUFtQixDQUFDLFlBQTBCLEVBQWdCO0FBQ3JFLFNBQU87QUFDTCxRQUFJLEVBQUUsUUFBUTtBQUNkLFNBQUssRUFBRSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQztHQUN4RCxDQUFDO0NBQ0g7O0FBRUQsU0FBUyxNQUFNLENBQUMsS0FBYSxFQUFTO0FBQ3BDLFVBQVEsS0FBSztBQUNYLFNBQUssR0FBRztBQUFFLGFBQU8sS0FBSyxDQUFDO0FBQUEsQUFDdkIsU0FBSyxHQUFHO0FBQUUsYUFBTyxJQUFJLENBQUM7QUFBQSxBQUN0QjtBQUFTLGFBQU8seUJBQXlCLEdBQUcsS0FBSyxDQUFDO0FBQUEsR0FDbkQ7Q0FDRjs7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLEVBQUMsWUFBWSxFQUFaLFlBQVksRUFBQyxDQUFDIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL3ZhbHVlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cblxuaW1wb3J0IHtsb2d9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHtiYXNlNjREZWNvZGV9IGZyb20gJy4vaGVscGVycy5qcyc7XG5pbXBvcnQge1xuICByZW1vdGVPYmplY3RJZE9mT2JqZWN0SWQsXG4gIHBhZ2VkT2JqZWN0SWQsXG4gIHNpbmdsZVBhZ2VPYmplY3RJZCxcbn0gZnJvbSAnLi9PYmplY3RJZCc7XG5cbi8qKlxuICogQ29udmVydHMgYSBkYmdwIHZhbHVlIHRvIGEgQ2hyb21lIFJlbW90ZU9iamVjdC5cbiAqL1xuZnVuY3Rpb24gY29udmVydFZhbHVlKGNvbnRleHRJZDogT2JqZWN0SWQsIGRiZ3BQcm9wZXJ0eTogRGJncFByb3BlcnR5KTogUmVtb3RlT2JqZWN0IHtcbiAgc3dpdGNoIChkYmdwUHJvcGVydHkuJC50eXBlKSB7XG4gICAgY2FzZSAnc3RyaW5nJzpcbiAgICAgIHJldHVybiBjb252ZXJ0U3RyaW5nVmFsdWUoZGJncFByb3BlcnR5KTtcbiAgICBjYXNlICdpbnQnOlxuICAgICAgcmV0dXJuIGNvbnZlcnRJbnRWYWx1ZShkYmdwUHJvcGVydHkpO1xuICAgIGNhc2UgJ2Zsb2F0JzpcbiAgICAgIHJldHVybiBjb252ZXJ0RmxvYXRWYWx1ZShkYmdwUHJvcGVydHkpO1xuICAgIGNhc2UgJ2Jvb2wnOlxuICAgICAgcmV0dXJuIGNvbnZlcnRCb29sVmFsdWUoZGJncFByb3BlcnR5KTtcbiAgICBjYXNlICdudWxsJzpcbiAgICAgIHJldHVybiBjb252ZXJ0TnVsbFZhbHVlKGRiZ3BQcm9wZXJ0eSk7XG4gICAgY2FzZSAnYXJyYXknOlxuICAgICAgcmV0dXJuIGNvbnZlcnRBcnJheVZhbHVlKGNvbnRleHRJZCwgZGJncFByb3BlcnR5KTtcbiAgICBjYXNlICdvYmplY3QnOlxuICAgICAgcmV0dXJuIGNvbnZlcnRPYmplY3RWYWx1ZShjb250ZXh0SWQsIGRiZ3BQcm9wZXJ0eSk7XG4gICAgZGVmYXVsdDpcbiAgICAgIC8vIFRPRE86IFJlbWFpbmluZyBwcm9wZXJ0eSB0eXBlcyAtIGNsb3N1cmUsIGhhc2htYXAsIC4uLlxuICAgICAgcmV0dXJuIGNvbnZlcnRVbmtub3duVmFsdWUoZGJncFByb3BlcnR5KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjb252ZXJ0U3RyaW5nVmFsdWUoZGJncFByb3BlcnR5OiBEYmdwUHJvcGVydHkpOiBSZW1vdGVPYmplY3Qge1xuICBsZXQgdmFsdWU7XG4gIGlmIChkYmdwUHJvcGVydHkuaGFzT3duUHJvcGVydHkoJ18nKSkge1xuICAgIHZhbHVlID0gZGJncFByb3BlcnR5LiQuZW5jb2RpbmcgPT09ICdiYXNlNjQnID8gYmFzZTY0RGVjb2RlKGRiZ3BQcm9wZXJ0eS5fKSA6XG4gICAgICBgVE9ETzogTm9uLWJhc2U2NCBlbmNvZGVkIHN0cmluZzogJHtKU09OLnN0cmluZ2lmeShkYmdwUHJvcGVydHkpfWA7XG4gIH0gZWxzZSB7XG4gICAgLy8gemVybyBsZW5ndGggc3RyaW5ncyBoYXZlIG5vIGRiZ3BQcm9wZXJ0eS5fIHByb3BlcnR5XG4gICAgdmFsdWUgPSAnJztcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgdHlwZTogJ3N0cmluZycsXG4gICAgdmFsdWUsXG4gIH07XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRJbnRWYWx1ZShkYmdwUHJvcGVydHk6IERiZ3BQcm9wZXJ0eSk6IFJlbW90ZU9iamVjdCB7XG4gIGNvbnN0IHZhbHVlID0gZGJncFByb3BlcnR5LiQuZW5jb2RpbmcgPT09ICdiYXNlNjQnID9cbiAgICBgVE9ETzogQmFzZTY0IGVuY29kZWQgaW50OiAke0pTT04uc3RyaW5naWZ5KGRiZ3BQcm9wZXJ0eSl9YFxuICAgIDogZGJncFByb3BlcnR5Ll87XG4gIHJldHVybiB7XG4gICAgdHlwZTogJ251bWJlcicsXG4gICAgdmFsdWUsXG4gIH07XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRGbG9hdFZhbHVlKGRiZ3BQcm9wZXJ0eTogRGJncFByb3BlcnR5KTogUmVtb3RlT2JqZWN0IHtcbiAgY29uc3QgdmFsdWUgPSBkYmdwUHJvcGVydHkuJC5lbmNvZGluZyA9PT0gJ2Jhc2U2NCcgP1xuICAgIGBUT0RPOiBCYXNlNjQgZW5jb2RlZCBmbG9hdDogJHtKU09OLnN0cmluZ2lmeShkYmdwUHJvcGVydHkpfWBcbiAgICA6IGRiZ3BQcm9wZXJ0eS5fO1xuICByZXR1cm4ge1xuICAgIHR5cGU6ICdudW1iZXInLFxuICAgIHZhbHVlLFxuICB9O1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0Qm9vbFZhbHVlKGRiZ3BQcm9wZXJ0eTogRGJncFByb3BlcnR5KTogUmVtb3RlT2JqZWN0IHtcbiAgY29uc3QgdmFsdWUgPSBkYmdwUHJvcGVydHkuJC5lbmNvZGluZyA9PT0gJ2Jhc2U2NCcgPyBgVE9ETzogQmFzZTY0IGVuY29kZWQgYm9vbDogJHtKU09OLnN0cmluZ2lmeShkYmdwUHJvcGVydHkpfWBcbiAgICA6IHRvQm9vbChkYmdwUHJvcGVydHkuXyk7XG4gIHJldHVybiB7XG4gICAgdHlwZTogJ2Jvb2xlYW4nLFxuICAgIHZhbHVlLFxuICB9O1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0TnVsbFZhbHVlKGRiZ3BQcm9wZXJ0eTogRGJncFByb3BlcnR5KTogUmVtb3RlT2JqZWN0IHtcbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAndW5kZWZpbmVkJyxcbiAgICBzdWJ0eXBlOiAnbnVsbCcsXG4gICAgdmFsdWU6IG51bGwsXG4gIH07XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRBcnJheVZhbHVlKGNvbnRleHRJZDogT2JqZWN0SWQsIGRiZ3BQcm9wZXJ0eTogRGJncFByb3BlcnR5KTogUmVtb3RlT2JqZWN0IHtcbiAgY29uc3QgcmVtb3RlSWQgPSBnZXRBZ2dyZWdhdGVSZW1vdGVPYmplY3RJZChjb250ZXh0SWQsIGRiZ3BQcm9wZXJ0eSk7XG4gIHJldHVybiB7XG4gICAgZGVzY3JpcHRpb246IGBBcnJheVske2RiZ3BQcm9wZXJ0eS4kLm51bWNoaWxkcmVufV1gLFxuICAgIHR5cGU6ICdvYmplY3QnLFxuICAgIHN1YnR5cGU6ICdhcnJheScsXG4gICAgb2JqZWN0SWQ6IHJlbW90ZUlkLFxuICB9O1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0T2JqZWN0VmFsdWUoY29udGV4dElkOiBPYmplY3RJZCwgZGJncFByb3BlcnR5OiBEYmdwUHJvcGVydHkpOiBSZW1vdGVPYmplY3Qge1xuICBjb25zdCByZW1vdGVJZCA9IGdldEFnZ3JlZ2F0ZVJlbW90ZU9iamVjdElkKGNvbnRleHRJZCwgZGJncFByb3BlcnR5KTtcbiAgcmV0dXJuIHtcbiAgICBkZXNjcmlwdGlvbjogZGJncFByb3BlcnR5LiQuY2xhc3NuYW1lLFxuICAgIHR5cGU6ICdvYmplY3QnLFxuICAgIG9iamVjdElkOiByZW1vdGVJZCxcbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0QWdncmVnYXRlUmVtb3RlT2JqZWN0SWQoY29udGV4dElkOiBPYmplY3RJZCwgZGJncFByb3BlcnR5OiBEYmdwUHJvcGVydHkpOiBSZW1vdGVPYmplY3RJZCB7XG4gIGNvbnN0IG51bWNoaWxkcmVuID0gTnVtYmVyKGRiZ3BQcm9wZXJ0eS4kLm51bWNoaWxkcmVuKTtcbiAgY29uc3QgcGFnZXNpemUgPSBOdW1iZXIoZGJncFByb3BlcnR5LiQucGFnZXNpemUpO1xuICBjb25zdCBwYWdlQ291bnQgPSBNYXRoLnRydW5jKChudW1jaGlsZHJlbiArIHBhZ2VzaXplIC0gMSkgLyBwYWdlc2l6ZSk7XG4gIGxvZyhgbnVtY2hpbGRyZW46ICR7bnVtY2hpbGRyZW59IHBhZ2VzaXplOiAke3BhZ2VzaXplfSBwYWdlQ291bnQgJHtwYWdlQ291bnR9YClcbiAgaWYgKHBhZ2VDb3VudCA+IDEpIHtcbiAgICBjb25zdCBlbGVtZW50UmFuZ2UgPSB7XG4gICAgICBwYWdlc2l6ZSxcbiAgICAgIHN0YXJ0SW5kZXg6IDAsXG4gICAgICBjb3VudDogbnVtY2hpbGRyZW4sXG4gICAgfTtcbiAgICByZXR1cm4gcmVtb3RlT2JqZWN0SWRPZk9iamVjdElkKHBhZ2VkT2JqZWN0SWQoY29udGV4dElkLCBkYmdwUHJvcGVydHkuJC5mdWxsbmFtZSwgZWxlbWVudFJhbmdlKSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHJlbW90ZU9iamVjdElkT2ZPYmplY3RJZChzaW5nbGVQYWdlT2JqZWN0SWQoY29udGV4dElkLCBkYmdwUHJvcGVydHkuJC5mdWxsbmFtZSwgMCkpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRVbmtub3duVmFsdWUoZGJncFByb3BlcnR5OiBEYmdwUHJvcGVydHkpOiBSZW1vdGVPYmplY3Qge1xuICByZXR1cm4ge1xuICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgIHZhbHVlOiAnVE9ETzogdW5rbm93bjogJyArIEpTT04uc3RyaW5naWZ5KGRiZ3BQcm9wZXJ0eSksXG4gIH07XG59XG5cbmZ1bmN0aW9uIHRvQm9vbCh2YWx1ZTogc3RyaW5nKTogbWl4ZWQge1xuICBzd2l0Y2ggKHZhbHVlKSB7XG4gICAgY2FzZSAnMCc6IHJldHVybiBmYWxzZTtcbiAgICBjYXNlICcxJzogcmV0dXJuIHRydWU7XG4gICAgZGVmYXVsdDogcmV0dXJuICdVbmV4cGVjdGVkIGJvb2wgdmFsdWU6ICcgKyB2YWx1ZTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtjb252ZXJ0VmFsdWV9O1xuIl19
