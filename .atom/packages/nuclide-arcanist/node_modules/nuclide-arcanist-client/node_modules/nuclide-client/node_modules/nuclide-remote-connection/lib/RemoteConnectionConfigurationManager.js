Object.defineProperty(exports, '__esModule', {
  value: true
});

var _slicedToArray = (function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i['return']) _i['return'](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError('Invalid attempt to destructure non-iterable instance'); } }; })();

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.getConnectionConfig = getConnectionConfig;
exports.setConnectionConfig = setConnectionConfig;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

var _nuclideLogging = require('nuclide-logging');

'use babel';

var logger = (0, _nuclideLogging.getLogger)();

/**
 * Version of RemoteConnectionConfiguration that uses string instead of Buffer for fields so it can
 * be translated directly to/from JSON.
 */

var CONFIG_KEY_PREFIX = 'nuclide.nuclide-connection.config';

function getConnectionConfig(host) {
  // $FlowIssue
  var storedConfig = atom.config.get(getAtomConfigKey(host));
  if (!storedConfig) {
    return null;
  }
  try {
    return decryptConfig(storedConfig);
  } catch (e) {
    logger.error('The configuration file for ' + host + ' is corrupted.', e);
    return null;
  }
}

function setConnectionConfig(config) {
  try {
    atom.config.set(getAtomConfigKey(config.host), encryptConfig(config));
  } catch (e) {
    logger.error('Failed to store configuration file for ' + config.host + '.', e);
  }
}

function getAtomConfigKey(host) {
  return CONFIG_KEY_PREFIX + '.' + host;
}

/**
 * Encrypts the clientKey of a ConnectionConfig.
 * @param remoteProjectConfig - The config with the clientKey we want encrypted.
 * @return returns the passed in config with the clientKey encrypted.
 */
function encryptConfig(remoteProjectConfig) {
  var _require = require('nuclide-keytar-wrapper');

  var replacePassword = _require.replacePassword;

  var crypto = require('crypto');

  var sha1 = crypto.createHash('sha1');
  sha1.update(remoteProjectConfig.host + ':' + remoteProjectConfig.port);
  var sha1sum = sha1.digest('hex');

  var certificateAuthorityCertificate = remoteProjectConfig.certificateAuthorityCertificate;
  var clientCertificate = remoteProjectConfig.clientCertificate;
  var clientKey = remoteProjectConfig.clientKey;

  (0, _assert2['default'])(clientKey);
  var realClientKey = clientKey.toString(); // Convert from Buffer to string.

  var _encryptString = encryptString(realClientKey);

  var salt = _encryptString.salt;
  var password = _encryptString.password;
  var encryptedString = _encryptString.encryptedString;

  replacePassword('nuclide.remoteProjectConfig', sha1sum, password);

  var clientKeyWithSalt = encryptedString + '.' + salt;

  (0, _assert2['default'])(certificateAuthorityCertificate);
  (0, _assert2['default'])(clientCertificate);
  var buffersAsStrings = {
    certificateAuthorityCertificate: certificateAuthorityCertificate.toString(),
    clientCertificate: clientCertificate.toString(),
    clientKey: clientKeyWithSalt
  };

  return _extends({}, remoteProjectConfig, buffersAsStrings);
}

/**
 * Decrypts the clientKey of a SerializableRemoteConnectionConfiguration.
 * @param remoteProjectConfig - The config with the clientKey we want encrypted.
 * @return returns the passed in config with the clientKey encrypted.
 */
function decryptConfig(remoteProjectConfig) {
  var _require2 = require('nuclide-keytar-wrapper');

  var getPassword = _require2.getPassword;

  var crypto = require('crypto');

  var sha1 = crypto.createHash('sha1');
  sha1.update(remoteProjectConfig.host + ':' + remoteProjectConfig.port);
  var sha1sum = sha1.digest('hex');

  var password = getPassword('nuclide.remoteProjectConfig', sha1sum);

  if (!password) {
    throw new Error('Cannot find password for encrypted client key');
  }

  var certificateAuthorityCertificate = remoteProjectConfig.certificateAuthorityCertificate;
  var clientCertificate = remoteProjectConfig.clientCertificate;
  var clientKey = remoteProjectConfig.clientKey;

  (0, _assert2['default'])(clientKey);

  var _clientKey$split = clientKey.split('.');

  var _clientKey$split2 = _slicedToArray(_clientKey$split, 2);

  var encryptedString = _clientKey$split2[0];
  var salt = _clientKey$split2[1];

  if (!encryptedString || !salt) {
    throw new Error('Cannot decrypt client key');
  }

  var restoredClientKey = decryptString(encryptedString, password, salt);
  if (!restoredClientKey.startsWith('-----BEGIN RSA PRIVATE KEY-----')) {
    (0, _nuclideLogging.getLogger)().error('decrypted client key did not start with expected header: ' + restoredClientKey);
  }

  (0, _assert2['default'])(certificateAuthorityCertificate);
  (0, _assert2['default'])(clientCertificate);
  var stringsAsBuffers = {
    certificateAuthorityCertificate: new Buffer(certificateAuthorityCertificate),
    clientCertificate: new Buffer(clientCertificate),
    clientKey: new Buffer(restoredClientKey)
  };

  return _extends({}, remoteProjectConfig, stringsAsBuffers);
}

function decryptString(text, password, salt) {
  var crypto = require('crypto');

  var decipher = crypto.createDecipheriv('aes-128-cbc', new Buffer(password, 'base64'), new Buffer(salt, 'base64'));

  var decryptedString = decipher.update(text, 'base64', 'utf8');
  decryptedString += decipher.final('utf8');

  return decryptedString;
}

function encryptString(text) {
  var crypto = require('crypto');
  // $FlowIssue
  var password = crypto.randomBytes(16).toString('base64');
  // $FlowIssue
  var salt = crypto.randomBytes(16).toString('base64');

  var cipher = crypto.createCipheriv('aes-128-cbc', new Buffer(password, 'base64'), new Buffer(salt, 'base64'));

  var encryptedString = cipher.update(text,
  /* input_encoding */'utf8',
  /* output_encoding */'base64');
  encryptedString += cipher.final('base64');

  return {
    password: password,
    salt: salt,
    encryptedString: encryptedString
  };
}

var __test__ = {
  decryptString: decryptString,
  encryptString: encryptString
};
exports.__test__ = __test__;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXJlbW90ZS1jb25uZWN0aW9uL2xpYi9SZW1vdGVDb25uZWN0aW9uQ29uZmlndXJhdGlvbk1hbmFnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O3NCQVdzQixRQUFROzs7OzhCQUNOLGlCQUFpQjs7QUFaekMsV0FBVyxDQUFDOztBQWVaLElBQU0sTUFBTSxHQUFHLG9CQUhQLFNBQVMsR0FHUyxDQUFDOzs7Ozs7O0FBZTNCLElBQU0saUJBQWlCLEdBQUcsbUNBQW1DLENBQUM7O0FBRXZELFNBQVMsbUJBQW1CLENBQUMsSUFBWSxFQUFrQzs7QUFFaEYsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUM3RCxNQUFJLENBQUMsWUFBWSxFQUFFO0FBQ2pCLFdBQU8sSUFBSSxDQUFDO0dBQ2I7QUFDRCxNQUFJO0FBQ0YsV0FBTyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7R0FDcEMsQ0FBQyxPQUFPLENBQUMsRUFBRTtBQUNWLFVBQU0sQ0FBQyxLQUFLLGlDQUErQixJQUFJLHFCQUFrQixDQUFDLENBQUMsQ0FBQztBQUNwRSxXQUFPLElBQUksQ0FBQztHQUNiO0NBQ0Y7O0FBRU0sU0FBUyxtQkFBbUIsQ0FBQyxNQUFxQyxFQUFRO0FBQy9FLE1BQUk7QUFDRixRQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7R0FDdkUsQ0FBQyxPQUFPLENBQUMsRUFBRTtBQUNWLFVBQU0sQ0FBQyxLQUFLLDZDQUEyQyxNQUFNLENBQUMsSUFBSSxRQUFLLENBQUMs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QyxRQUFRLENBQUMsQ0FBQzs7QUFFakMsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7O0FBRTNELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDOztBQUV2RCxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsY0FBYyxDQUNsQyxhQUFhLEVBQ2IsSUFBSSxNQUFNLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxFQUM5QixJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQzs7QUFFOUIsTUFBSSxlQUFlLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FDakMsSUFBSTtzQkFDaUIsTUFBTTt1QkFDTCxRQUFRLENBQy9CLENBQUM7QUFDRixpQkFBZSxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7O0FBRTFDLFNBQU87QUFDTCxZQUFRLEVBQVIsUUFBUTtBQUNSLFFBQUksRUFBSixJQUFJO0FBQ0osbUJBQWUsRUFBZixlQUFlO0dBQ2hCLENBQUM7Q0FDSDs7QUFFTSxJQUFNLFFBQVEsR0FBRztBQUN0QixlQUFhLEVBQWIsYUFBYTtBQUNiLGVBQWEsRUFBYixhQUFhO0NBQ2QsQ0FBQyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wcGZsNTJucHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1yZW1vdGUtY29ubmVjdGlvbi9saWIvUmVtb3RlQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb25NYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuaW1wb3J0IGludmFyaWFudCBmcm9tICdhc3NlcnQnO1xuaW1wb3J0IHtnZXRMb2dnZXJ9IGZyb20gJ251Y2xpZGUtbG9nZ2luZyc7XG5pbXBvcnQgdHlwZSB7UmVtb3RlQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb259IGZyb20gJy4vUmVtb3RlQ29ubmVjdGlvbic7XG5cbmNvbnN0IGxvZ2dlciA9IGdldExvZ2dlcigpO1xuXG4vKipcbiAqIFZlcnNpb24gb2YgUmVtb3RlQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb24gdGhhdCB1c2VzIHN0cmluZyBpbnN0ZWFkIG9mIEJ1ZmZlciBmb3IgZmllbGRzIHNvIGl0IGNhblxuICogYmUgdHJhbnNsYXRlZCBkaXJlY3RseSB0by9mcm9tIEpTT04uXG4gKi9cbnR5cGUgU2VyaWFsaXphYmxlUmVtb3RlQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb24gPSB7XG4gIGhvc3Q6IHN0cmluZztcbiAgcG9ydDogbnVtYmVyO1xuICBjd2Q6IHN0cmluZztcbiAgY2VydGlmaWNhdGVBdXRob3JpdHlDZXJ0aWZpY2F0ZT86IHN0cmluZztcbiAgY2xpZW50Q2VydGlmaWNhdGU/OiBzdHJpbmc7XG4gIGNsaWVudEtleT86IHN0cmluZztcbn1cblxuY29uc3QgQ09ORklHX0tFWV9QUkVGSVggPSAnbnVjbGlkZS5udWNsaWRlLWNvbm5lY3Rpb24uY29uZmlnJztcblxuZXhwb3J0IGZ1bmN0aW9uIGdldENvbm5lY3Rpb25Db25maWcoaG9zdDogc3RyaW5nKTogP1JlbW90ZUNvbm5lY3Rpb25Db25maWd1cmF0aW9uIHtcbiAgLy8gJEZsb3dJc3N1ZVxuICBjb25zdCBzdG9yZWRDb25maWcgPSBhdG9tLmNvbmZpZy5nZXQoZ2V0QXRvbUNvbmZpZ0tleShob3N0KSk7XG4gIGlmICghc3RvcmVkQ29uZmlnKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgdHJ5IHtcbiAgICByZXR1cm4gZGVjcnlwdENvbmZpZyhzdG9yZWRDb25maWcpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nZ2VyLmVycm9yKGBUaGUgY29uZmlndXJhdGlvbiBmaWxlIGZvciAke2hvc3R9IGlzIGNvcnJ1cHRlZC5gLCBlKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0Q29ubmVjdGlvbkNvbmZpZyhjb25maWc6IFJlbW90ZUNvbm5lY3Rpb25Db25maWd1cmF0aW9uKTogdm9pZCB7XG4gIHRyeSB7XG4gICAgYXRvbS5jb25maWcuc2V0KGdldEF0b21Db25maWdLZXkoY29uZmlnLmhvc3QpLCBlbmNyeXB0Q29uZmlnKGNvbmZpZykpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gc3RvcmUgY29uZmlndXJhdGlvbiBmaWxlIGZvciAke2NvbmZpZy5ob3N0fS5gLCBlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRBdG9tQ29uZmlnS2V5KGhvc3Q6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBgJHtDT05GSUdfS0VZX1BSRUZJWH0uJHtob3N0fWA7XG59XG5cbi8qKlxuICogRW5jcnlwdHMgdGhlIGNsaWVudEtleSBvZiBhIENvbm5lY3Rpb25Db25maWcuXG4gKiBAcGFyYW0gcmVtb3RlUHJvamVjdENvbmZpZyAtIFRoZSBjb25maWcgd2l0aCB0aGUgY2xpZW50S2V5IHdlIHdhbnQgZW5jcnlwdGVkLlxuICogQHJldHVybiByZXR1cm5zIHRoZSBwYXNzZWQgaW4gY29uZmlnIHdpdGggdGhlIGNsaWVudEtleSBlbmNyeXB0ZWQuXG4gKi9cbmZ1bmN0aW9uIGVuY3J5cHRDb25maWcoXG4gIHJlbW90ZVByb2plY3RDb25maWc6IFJlbW90ZUNvbm5lY3Rpb25Db25maWd1cmF0aW9uLFxuKTogU2VyaWFsaXphYmxlUmVtb3RlQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb24ge1xuICBjb25zdCB7cmVwbGFjZVBhc3N3b3JkfSA9IHJlcXVpcmUoJ251Y2xpZGUta2V5dGFyLXdyYXBwZXInKTtcbiAgY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5cbiAgY29uc3Qgc2hhMSA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGExJyk7XG4gIHNoYTEudXBkYXRlKGAke3JlbW90ZVByb2plY3RDb25maWcuaG9zdH06JHtyZW1vdGVQcm9qZWN0Q29uZmlnLnBvcnR9YCk7XG4gIGNvbnN0IHNoYTFzdW0gPSBzaGExLmRpZ2VzdCgnaGV4Jyk7XG5cbiAgY29uc3Qge2NlcnRpZmljYXRlQXV0aG9yaXR5Q2VydGlmaWNhdGUsIGNsaWVudENlcnRpZmljYXRlLCBjbGllbnRLZXl9ID0gcmVtb3RlUHJvamVjdENvbmZpZztcbiAgaW52YXJpYW50KGNsaWVudEtleSk7XG4gIGNvbnN0IHJlYWxDbGllbnRLZXkgPSBjbGllbnRLZXkudG9TdHJpbmcoKTsgLy8gQ29udmVydCBmcm9tIEJ1ZmZlciB0byBzdHJpbmcuXG4gIGNvbnN0IHtzYWx0LCBwYXNzd29yZCwgZW5jcnlwdGVkU3RyaW5nfSA9IGVuY3J5cHRTdHJpbmcocmVhbENsaWVudEtleSk7XG4gIHJlcGxhY2VQYXNzd29yZCgnbnVjbGlkZS5yZW1vdGVQcm9qZWN0Q29uZmlnJywgc2hhMXN1bSwgcGFzc3dvcmQpO1xuXG4gIGNvbnN0IGNsaWVudEtleVdpdGhTYWx0ID0gZW5jcnlwdGVkU3RyaW5nICsgJy4nICsgc2FsdDtcblxuICBpbnZhcmlhbnQoY2VydGlmaWNhdGVBdXRob3JpdHlDZXJ0aWZpY2F0ZSk7XG4gIGludmFyaWFudChjbGllbnRDZXJ0aWZpY2F0ZSk7XG4gIGNvbnN0IGJ1ZmZlcnNBc1N0cmluZ3MgPSB7XG4gICAgY2VydGlmaWNhdGVBdXRob3JpdHlDZXJ0aWZpY2F0ZTogY2VydGlmaWNhdGVBdXRob3JpdHlDZXJ0aWZpY2F0ZS50b1N0cmluZygpLFxuICAgIGNsaWVudENlcnRpZmljYXRlOiBjbGllbnRDZXJ0aWZpY2F0ZS50b1N0cmluZygpLFxuICAgIGNsaWVudEtleTogY2xpZW50S2V5V2l0aFNhbHQsXG4gIH07XG5cbiAgcmV0dXJuIHsuLi5yZW1vdGVQcm9qZWN0Q29uZmlnLCAuLi5idWZmZXJzQXNTdHJpbmdzfTtcbn1cblxuLyoqXG4gKiBEZWNyeXB0cyB0aGUgY2xpZW50S2V5IG9mIGEgU2VyaWFsaXphYmxlUmVtb3RlQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb24uXG4gKiBAcGFyYW0gcmVtb3RlUHJvamVjdENvbmZpZyAtIFRoZSBjb25maWcgd2l0aCB0aGUgY2xpZW50S2V5IHdlIHdhbnQgZW5jcnlwdGVkLlxuICogQHJldHVybiByZXR1cm5zIHRoZSBwYXNzZWQgaW4gY29uZmlnIHdpdGggdGhlIGNsaWVudEtleSBlbmNyeXB0ZWQuXG4gKi9cbmZ1bmN0aW9uIGRlY3J5cHRDb25maWcoXG4gIHJlbW90ZVByb2plY3RDb25maWc6IFNlcmlhbGl6YWJsZVJlbW90ZUNvbm5lY3Rpb25Db25maWd1cmF0aW9uLFxuKTogUmVtb3RlQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb24ge1xuICBjb25zdCB7Z2V0UGFzc3dvcmR9ID0gcmVxdWlyZSgnbnVjbGlkZS1rZXl0YXItd3JhcHBlcicpO1xuICBjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKTtcblxuICBjb25zdCBzaGExID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTEnKTtcbiAgc2hhMS51cGRhdGUoYCR7cmVtb3RlUHJvamVjdENvbmZpZy5ob3N0fToke3JlbW90ZVByb2plY3RDb25maWcucG9ydH1gKTtcbiAgY29uc3Qgc2hhMXN1bSA9IHNoYTEuZGlnZXN0KCdoZXgnKTtcblxuICBjb25zdCBwYXNzd29yZCA9IGdldFBhc3N3b3JkKCdudWNsaWRlLnJlbW90ZVByb2plY3RDb25maWcnLCBzaGExc3VtKTtcblxuICBpZiAoIXBhc3N3b3JkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCBwYXNzd29yZCBmb3IgZW5jcnlwdGVkIGNsaWVudCBrZXknKTtcbiAgfVxuXG4gIGNvbnN0IHtjZXJ0aWZpY2F0ZUF1dGhvcml0eUNlcnRpZmljYXRlLCBjbGllbnRDZXJ0aWZpY2F0ZSwgY2xpZW50S2V5fSA9IHJlbW90ZVByb2plY3RDb25maWc7XG4gIGludmFyaWFudChjbGllbnRLZXkpO1xuICBjb25zdCBbZW5jcnlwdGVkU3RyaW5nLCBzYWx0XSA9IGNsaWVudEtleS5zcGxpdCgnLicpO1xuXG4gIGlmICghZW5jcnlwdGVkU3RyaW5nIHx8ICFzYWx0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZGVjcnlwdCBjbGllbnQga2V5Jyk7XG4gIH1cblxuICBjb25zdCByZXN0b3JlZENsaWVudEtleSA9IGRlY3J5cHRTdHJpbmcoZW5jcnlwdGVkU3RyaW5nLCBwYXNzd29yZCwgc2FsdCk7XG4gIGlmICghcmVzdG9yZWRDbGllbnRLZXkuc3RhcnRzV2l0aCgnLS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLScpKSB7XG4gICAgZ2V0TG9nZ2VyKCkuZXJyb3IoXG4gICAgICBgZGVjcnlwdGVkIGNsaWVudCBrZXkgZGlkIG5vdCBzdGFydCB3aXRoIGV4cGVjdGVkIGhlYWRlcjogJHtyZXN0b3JlZENsaWVudEtleX1gKTtcbiAgfVxuXG4gIGludmFyaWFudChjZXJ0aWZpY2F0ZUF1dGhvcml0eUNlcnRpZmljYXRlKTtcbiAgaW52YXJpYW50KGNsaWVudENlcnRpZmljYXRlKTtcbiAgY29uc3Qgc3RyaW5nc0FzQnVmZmVycyA9IHtcbiAgICBjZXJ0aWZpY2F0ZUF1dGhvcml0eUNlcnRpZmljYXRlOiBuZXcgQnVmZmVyKGNlcnRpZmljYXRlQXV0aG9yaXR5Q2VydGlmaWNhdGUpLFxuICAgIGNsaWVudENlcnRpZmljYXRlOiBuZXcgQnVmZmVyKGNsaWVudENlcnRpZmljYXRlKSxcbiAgICBjbGllbnRLZXk6IG5ldyBCdWZmZXIocmVzdG9yZWRDbGllbnRLZXkpLFxuICB9O1xuXG4gIHJldHVybiB7Li4ucmVtb3RlUHJvamVjdENvbmZpZywgLi4uc3RyaW5nc0FzQnVmZmVyc307XG59XG5cbmZ1bmN0aW9uIGRlY3J5cHRTdHJpbmcodGV4dDogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCBzYWx0OiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKTtcblxuICBjb25zdCBkZWNpcGhlciA9IGNyeXB0by5jcmVhdGVEZWNpcGhlcml2KFxuICAgICAgJ2Flcy0xMjgtY2JjJyxcbiAgICAgIG5ldyBCdWZmZXIocGFzc3dvcmQsICdiYXNlNjQnKSxcbiAgICAgIG5ldyBCdWZmZXIoc2FsdCwgJ2Jhc2U2NCcpKTtcblxuICBsZXQgZGVjcnlwdGVkU3RyaW5nID0gZGVjaXBoZXIudXBkYXRlKHRleHQsICdiYXNlNjQnLCAndXRmOCcpO1xuICBkZWNyeXB0ZWRTdHJpbmcgKz0gZGVjaXBoZXIuZmluYWwoJ3V0ZjgnKTtcblxuICByZXR1cm4gZGVjcnlwdGVkU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBlbmNyeXB0U3RyaW5nKHRleHQ6IHN0cmluZyk6IHtwYXNzd29yZDogc3RyaW5nLCBzYWx0OiBzdHJpbmcsIGVuY3J5cHRlZFN0cmluZzogc3RyaW5nfSB7XG4gIGNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuICAvLyAkRmxvd0lzc3VlXG4gIGNvbnN0IHBhc3N3b3JkID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDE2KS50b1N0cmluZygnYmFzZTY0Jyk7XG4gIC8vICRGbG93SXNzdWVcbiAgY29uc3Qgc2FsdCA9IGNyeXB0by5yYW5kb21CeXRlcygxNikudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuXG4gIGNvbnN0IGNpcGhlciA9IGNyeXB0by5jcmVhdGVDaXBoZXJpdihcbiAgICAnYWVzLTEyOC1jYmMnLFxuICAgIG5ldyBCdWZmZXIocGFzc3dvcmQsICdiYXNlNjQnKSxcbiAgICBuZXcgQnVmZmVyKHNhbHQsICdiYXNlNjQnKSk7XG5cbiAgbGV0IGVuY3J5cHRlZFN0cmluZyA9IGNpcGhlci51cGRhdGUoXG4gICAgdGV4dCxcbiAgICAvKiBpbnB1dF9lbmNvZGluZyAqLyAndXRmOCcsXG4gICAgLyogb3V0cHV0X2VuY29kaW5nICovICdiYXNlNjQnLFxuICApO1xuICBlbmNyeXB0ZWRTdHJpbmcgKz0gY2lwaGVyLmZpbmFsKCdiYXNlNjQnKTtcblxuICByZXR1cm4ge1xuICAgIHBhc3N3b3JkLFxuICAgIHNhbHQsXG4gICAgZW5jcnlwdGVkU3RyaW5nLFxuICB9O1xufVxuXG5leHBvcnQgY29uc3QgX190ZXN0X18gPSB7XG4gIGRlY3J5cHRTdHJpbmcsXG4gIGVuY3J5cHRTdHJpbmcsXG59O1xuIl19
