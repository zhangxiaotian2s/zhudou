
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

/*
 * An ElementRange identifies a range of child elements of a data value.
 * startIndex represents the index of the first element in the range.
 * count the number of elements in the range.
 * pagesize is always the debuggee pagesize which currently defaults to 32.
 *
 * Note that the children of an ElementRange may be aggregated into ranges whose size
 * is larger than the debuggeee pagesize. For example given a range with pagesize
 * of 32, and count of 32^5, the children of the range will have a pagesize of 32
 * and count of 32^4.
 */

/*
 * ObjectIds identify data values with children.
 *
 * Initially when data with children is returned to the Chrome
 * debugger only the ObjectId is returned. Subsequent calls by the debugger can request
 * the child properties of an ObjectId.
 *
 * There are 3 valid forms of ObjectId.
 *
 * ObjectIds for stack frame contexts just have the 3 required fields.
 * Contexts are never paged - even with large numbers of variables.
 *
 * Array and Object children may be paged.
 *
 * SinglePageObjectIds have fullname and page set. They represent a single page of
 * children of the value represented by fullname.
 *
 * PagedObjectIds have fullname and elementRange set. They represent multiple pages
 * of children of the value represented by fullname. Note that the children of
 * PagedObjectIds may be a combination of SinglePageObjectIds and PagedObjectIds.
 */

var WATCH_CONTEXT_ID = 'Watch Context Id';

function getWatchContextObjectId(enableCount, frameIndex) {
  return createContextObjectId(enableCount, frameIndex, WATCH_CONTEXT_ID);
}

function remoteObjectIdOfObjectId(id) {
  return JSON.stringify(id);
}

function createContextObjectId(enableCount, frameIndex, contextId) {
  return {
    enableCount: enableCount,
    frameIndex: frameIndex,
    contextId: contextId
  };
}

function pagedObjectId(objectId, fullname, elementRange) {
  var result = copyObjectId(objectId);
  result.fullname = fullname;
  result.elementRange = elementRange;
  return result;
}

function singlePageObjectId(objectId, fullname, page) {
  var result = copyObjectId(objectId);
  result.fullname = fullname;
  result.page = page;
  return result;
}

function isWatchContextObjectId(id) {
  return id.contextId === WATCH_CONTEXT_ID;
}

function isContextObjectId(id) {
  return !id.hasOwnProperty('fullname');
}

function isSinglePageObjectId(id) {
  return id.hasOwnProperty('page');
}

function isPagedObjectId(id) {
  return id.hasOwnProperty('elementRange');
}

/**
 * Extracts just the shared parts from an ObjectId. Does not use object.assign as objectId
 * may have fields which we must not copy.
 */
function copyObjectId(id) {
  return createContextObjectId(id.enableCount, id.frameIndex, id.contextId);
}

function endIndexOfElementRange(elementRange) {
  return elementRange.startIndex + elementRange.count;
}

function endIndexOfObjectId(id) {
  return endIndexOfElementRange(id.elementRange);
}

function startIndexOfObjectId(id, pagesize) {
  if (isSinglePageObjectId(id)) {
    return id.page * pagesize;
  } else {
    return id.elementRange.startIndex;
  }
}

function countOfObjectId(id, pagesize, parentEndIndex) {
  if (isSinglePageObjectId(id)) {
    return Math.min(pagesize, parentEndIndex - startIndexOfObjectId(id, pagesize));
  } else {
    return id.elementRange.count;
  }
}

/*
 * Given a PagedObjectId, return an array of ObjectIds for its children.
 * Note that the children may be a combination of PagedObjectIds and SinglePageObjectIds.
 */
function getChildIds(id) {
  var pagesize = id.elementRange.pagesize;

  // Handle a page of pages (... of pages)
  var childSize = pagesize;
  while (childSize * pagesize < id.elementRange.count) {
    childSize *= pagesize;
  }

  var result = [];
  var childStartIndex = id.elementRange.startIndex;
  var endIndex = endIndexOfObjectId(id);
  while (childStartIndex < endIndex) {
    var childCount = Math.min(childSize, endIndex - childStartIndex);

    var childId = undefined;
    if (childCount <= pagesize) {
      childId = singlePageObjectId(id, id.fullname, Math.trunc(childStartIndex / pagesize));
    } else {
      childId = pagedObjectId(id, id.fullname, { pagesize: pagesize, startIndex: childStartIndex, count: childCount });
    }

    result.push(childId);

    childStartIndex += childCount;
  }

  return result;
}

module.exports = {
  remoteObjectIdOfObjectId: remoteObjectIdOfObjectId,
  createContextObjectId: createContextObjectId,
  pagedObjectId: pagedObjectId,
  singlePageObjectId: singlePageObjectId,
  isContextObjectId: isContextObjectId,
  isSinglePageObjectId: isSinglePageObjectId,
  isPagedObjectId: isPagedObjectId,
  copyObjectId: copyObjectId,
  endIndexOfElementRange: endIndexOfElementRange,
  endIndexOfObjectId: endIndexOfObjectId,
  startIndexOfObjectId: startIndexOfObjectId,
  countOfObjectId: countOfObjectId,
  getChildIds: getChildIds,
  getWatchContextObjectId: getWatchContextObjectId,
  isWatchContextObjectId: isWatchContextObjectId
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL09iamVjdElkLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUEyRFosSUFBTSxnQkFBZ0IsR0FBRyxrQkFBa0IsQ0FBQzs7QUFFNUMsU0FBUyx1QkFBdUIsQ0FBQyxXQUFtQixFQUFFLFVBQWtCLEVBQVk7QUFDbEYsU0FBTyxxQkFBcUIsQ0FBQyxXQUFXLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixDQUFDLENBQUM7Q0FDekU7O0FBRUQsU0FBUyx3QkFBd0IsQ0FBQyxFQUFZLEVBQWtCO0FBQzlELFNBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztDQUMzQjs7QUFFRCxTQUFTLHFCQUFxQixDQUFDLFdBQW1CLEVBQUUsVUFBa0IsRUFBRSxTQUFpQixFQUFZO0FBQ25HLFNBQU87QUFDTCxlQUFXLEVBQVgsV0FBVztBQUNYLGNBQVUsRUFBVixVQUFVO0FBQ1YsYUFBUyxFQUFULFNBQVM7R0FDVixDQUFDO0NBQ0g7O0FBRUQsU0FBUyxhQUFhLENBQUMsUUFBa0IsRUFBRSxRQUFnQixFQUFFLFlBQTBCLEVBQVk7QUFDakcsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3RDLFFBQU0sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0FBQzNCLFFBQU0sQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO0FBQ25DLFNBQU8sTUFBTSxDQUFDO0NBQ2Y7O0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxRQUFrQixFQUFFLFFBQWdCLEVBQUUsSUFBWSxFQUFZO0FBQ3hGLE1BQU0sTUFBTSxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUMs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O0tBQ3ZGLE1BQU07QUFDTCxhQUFPLEdBQUcsYUFBYSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsUUFBUSxFQUFFLEVBQUMsUUFBUSxFQUFSLFFBQVEsRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUMsQ0FBQyxDQUFDO0tBQ3RHOztBQUVELFVBQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7O0FBRXJCLG1CQUFlLElBQUksVUFBVSxDQUFDO0dBQy9COztBQUVELFNBQU8sTUFBTSxDQUFDO0NBQ2Y7O0FBR0QsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNmLDBCQUF3QixFQUF4Qix3QkFBd0I7QUFDeEIsdUJBQXFCLEVBQXJCLHFCQUFxQjtBQUNyQixlQUFhLEVBQWIsYUFBYTtBQUNiLG9CQUFrQixFQUFsQixrQkFBa0I7QUFDbEIsbUJBQWlCLEVBQWpCLGlCQUFpQjtBQUNqQixzQkFBb0IsRUFBcEIsb0JBQW9CO0FBQ3BCLGlCQUFlLEVBQWYsZUFBZTtBQUNmLGNBQVksRUFBWixZQUFZO0FBQ1osd0JBQXNCLEVBQXRCLHNCQUFzQjtBQUN0QixvQkFBa0IsRUFBbEIsa0JBQWtCO0FBQ2xCLHNCQUFvQixFQUFwQixvQkFBb0I7QUFDcEIsaUJBQWUsRUFBZixlQUFlO0FBQ2YsYUFBVyxFQUFYLFdBQVc7QUFDWCx5QkFBdUIsRUFBdkIsdUJBQXVCO0FBQ3ZCLHdCQUFzQixFQUF0QixzQkFBc0I7Q0FDdkIsQ0FBQyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wcGZsNTJucHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1kZWJ1Z2dlci1oaHZtLXByb3h5L2xpYi9PYmplY3RJZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cblxuLypcbiAqIEFuIEVsZW1lbnRSYW5nZSBpZGVudGlmaWVzIGEgcmFuZ2Ugb2YgY2hpbGQgZWxlbWVudHMgb2YgYSBkYXRhIHZhbHVlLlxuICogc3RhcnRJbmRleCByZXByZXNlbnRzIHRoZSBpbmRleCBvZiB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgcmFuZ2UuXG4gKiBjb3VudCB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIHRoZSByYW5nZS5cbiAqIHBhZ2VzaXplIGlzIGFsd2F5cyB0aGUgZGVidWdnZWUgcGFnZXNpemUgd2hpY2ggY3VycmVudGx5IGRlZmF1bHRzIHRvIDMyLlxuICpcbiAqIE5vdGUgdGhhdCB0aGUgY2hpbGRyZW4gb2YgYW4gRWxlbWVudFJhbmdlIG1heSBiZSBhZ2dyZWdhdGVkIGludG8gcmFuZ2VzIHdob3NlIHNpemVcbiAqIGlzIGxhcmdlciB0aGFuIHRoZSBkZWJ1Z2dlZWUgcGFnZXNpemUuIEZvciBleGFtcGxlIGdpdmVuIGEgcmFuZ2Ugd2l0aCBwYWdlc2l6ZVxuICogb2YgMzIsIGFuZCBjb3VudCBvZiAzMl41LCB0aGUgY2hpbGRyZW4gb2YgdGhlIHJhbmdlIHdpbGwgaGF2ZSBhIHBhZ2VzaXplIG9mIDMyXG4gKiBhbmQgY291bnQgb2YgMzJeNC5cbiAqL1xudHlwZSBFbGVtZW50UmFuZ2UgPSB7XG4gIHBhZ2VzaXplOiBudW1iZXI7XG4gIHN0YXJ0SW5kZXg6IG51bWJlcjtcbiAgY291bnQ6IG51bWJlcjtcbn07XG5cbi8qXG4gKiBPYmplY3RJZHMgaWRlbnRpZnkgZGF0YSB2YWx1ZXMgd2l0aCBjaGlsZHJlbi5cbiAqXG4gKiBJbml0aWFsbHkgd2hlbiBkYXRhIHdpdGggY2hpbGRyZW4gaXMgcmV0dXJuZWQgdG8gdGhlIENocm9tZVxuICogZGVidWdnZXIgb25seSB0aGUgT2JqZWN0SWQgaXMgcmV0dXJuZWQuIFN1YnNlcXVlbnQgY2FsbHMgYnkgdGhlIGRlYnVnZ2VyIGNhbiByZXF1ZXN0XG4gKiB0aGUgY2hpbGQgcHJvcGVydGllcyBvZiBhbiBPYmplY3RJZC5cbiAqXG4gKiBUaGVyZSBhcmUgMyB2YWxpZCBmb3JtcyBvZiBPYmplY3RJZC5cbiAqXG4gKiBPYmplY3RJZHMgZm9yIHN0YWNrIGZyYW1lIGNvbnRleHRzIGp1c3QgaGF2ZSB0aGUgMyByZXF1aXJlZCBmaWVsZHMuXG4gKiBDb250ZXh0cyBhcmUgbmV2ZXIgcGFnZWQgLSBldmVuIHdpdGggbGFyZ2UgbnVtYmVycyBvZiB2YXJpYWJsZXMuXG4gKlxuICogQXJyYXkgYW5kIE9iamVjdCBjaGlsZHJlbiBtYXkgYmUgcGFnZWQuXG4gKlxuICogU2luZ2xlUGFnZU9iamVjdElkcyBoYXZlIGZ1bGxuYW1lIGFuZCBwYWdlIHNldC4gVGhleSByZXByZXNlbnQgYSBzaW5nbGUgcGFnZSBvZlxuICogY2hpbGRyZW4gb2YgdGhlIHZhbHVlIHJlcHJlc2VudGVkIGJ5IGZ1bGxuYW1lLlxuICpcbiAqIFBhZ2VkT2JqZWN0SWRzIGhhdmUgZnVsbG5hbWUgYW5kIGVsZW1lbnRSYW5nZSBzZXQuIFRoZXkgcmVwcmVzZW50IG11bHRpcGxlIHBhZ2VzXG4gKiBvZiBjaGlsZHJlbiBvZiB0aGUgdmFsdWUgcmVwcmVzZW50ZWQgYnkgZnVsbG5hbWUuIE5vdGUgdGhhdCB0aGUgY2hpbGRyZW4gb2ZcbiAqIFBhZ2VkT2JqZWN0SWRzIG1heSBiZSBhIGNvbWJpbmF0aW9uIG9mIFNpbmdsZVBhZ2VPYmplY3RJZHMgYW5kIFBhZ2VkT2JqZWN0SWRzLlxuICovXG50eXBlIE9iamVjdElkID0ge1xuICBlbmFibGVDb3VudDogbnVtYmVyO1xuICBmcmFtZUluZGV4OiBudW1iZXI7XG4gIGNvbnRleHRJZDogc3RyaW5nO1xuICBmdWxsbmFtZT86IHN0cmluZztcbiAgcGFnZT86IG51bWJlcjtcbiAgZWxlbWVudFJhbmdlPzogRWxlbWVudFJhbmdlO1xufTtcblxuY29uc3QgV0FUQ0hfQ09OVEVYVF9JRCA9ICdXYXRjaCBDb250ZXh0IElkJztcblxuZnVuY3Rpb24gZ2V0V2F0Y2hDb250ZXh0T2JqZWN0SWQoZW5hYmxlQ291bnQ6IG51bWJlciwgZnJhbWVJbmRleDogbnVtYmVyKTogT2JqZWN0SWQge1xuICByZXR1cm4gY3JlYXRlQ29udGV4dE9iamVjdElkKGVuYWJsZUNvdW50LCBmcmFtZUluZGV4LCBXQVRDSF9DT05URVhUX0lEKTtcbn1cblxuZnVuY3Rpb24gcmVtb3RlT2JqZWN0SWRPZk9iamVjdElkKGlkOiBPYmplY3RJZCk6IFJlbW90ZU9iamVjdElkIHtcbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGlkKTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlQ29udGV4dE9iamVjdElkKGVuYWJsZUNvdW50OiBudW1iZXIsIGZyYW1lSW5kZXg6IG51bWJlciwgY29udGV4dElkOiBzdHJpbmcpOiBPYmplY3RJZCB7XG4gIHJldHVybiB7XG4gICAgZW5hYmxlQ291bnQsXG4gICAgZnJhbWVJbmRleCxcbiAgICBjb250ZXh0SWQsXG4gIH07XG59XG5cbmZ1bmN0aW9uIHBhZ2VkT2JqZWN0SWQob2JqZWN0SWQ6IE9iamVjdElkLCBmdWxsbmFtZTogc3RyaW5nLCBlbGVtZW50UmFuZ2U6IEVsZW1lbnRSYW5nZSk6IE9iamVjdElkIHtcbiAgY29uc3QgcmVzdWx0ID0gY29weU9iamVjdElkKG9iamVjdElkKTtcbiAgcmVzdWx0LmZ1bGxuYW1lID0gZnVsbG5hbWU7XG4gIHJlc3VsdC5lbGVtZW50UmFuZ2UgPSBlbGVtZW50UmFuZ2U7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIHNpbmdsZVBhZ2VPYmplY3RJZChvYmplY3RJZDogT2JqZWN0SWQsIGZ1bGxuYW1lOiBzdHJpbmcsIHBhZ2U6IG51bWJlcik6IE9iamVjdElkIHtcbiAgY29uc3QgcmVzdWx0ID0gY29weU9iamVjdElkKG9iamVjdElkKTtcbiAgcmVzdWx0LmZ1bGxuYW1lID0gZnVsbG5hbWU7XG4gIHJlc3VsdC5wYWdlID0gcGFnZTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gaXNXYXRjaENvbnRleHRPYmplY3RJZChpZDogT2JqZWN0SWQpOiBib29sZWFuIHtcbiAgcmV0dXJuIGlkLmNvbnRleHRJZCA9PT0gV0FUQ0hfQ09OVEVYVF9JRDtcbn1cblxuZnVuY3Rpb24gaXNDb250ZXh0T2JqZWN0SWQoaWQ6IE9iamVjdElkKTogYm9vbGVhbiB7XG4gIHJldHVybiAhaWQuaGFzT3duUHJvcGVydHkoJ2Z1bGxuYW1lJyk7XG59XG5cbmZ1bmN0aW9uIGlzU2luZ2xlUGFnZU9iamVjdElkKGlkOiBPYmplY3RJZCk6IGJvb2xlYW4ge1xuICByZXR1cm4gaWQuaGFzT3duUHJvcGVydHkoJ3BhZ2UnKTtcbn1cblxuZnVuY3Rpb24gaXNQYWdlZE9iamVjdElkKGlkOiBPYmplY3RJZCk6IGJvb2xlYW4ge1xuICByZXR1cm4gaWQuaGFzT3duUHJvcGVydHkoJ2VsZW1lbnRSYW5nZScpO1xufVxuXG4vKipcbiAqIEV4dHJhY3RzIGp1c3QgdGhlIHNoYXJlZCBwYXJ0cyBmcm9tIGFuIE9iamVjdElkLiBEb2VzIG5vdCB1c2Ugb2JqZWN0LmFzc2lnbiBhcyBvYmplY3RJZFxuICogbWF5IGhhdmUgZmllbGRzIHdoaWNoIHdlIG11c3Qgbm90IGNvcHkuXG4gKi9cbmZ1bmN0aW9uIGNvcHlPYmplY3RJZChpZDogT2JqZWN0SWQpOiBPYmplY3RJZCB7XG4gIHJldHVybiBjcmVhdGVDb250ZXh0T2JqZWN0SWQoaWQuZW5hYmxlQ291bnQsIGlkLmZyYW1lSW5kZXgsIGlkLmNvbnRleHRJZCk7XG59XG5cbmZ1bmN0aW9uIGVuZEluZGV4T2ZFbGVtZW50UmFuZ2UoZWxlbWVudFJhbmdlOiBFbGVtZW50UmFuZ2UpOiBudW1iZXIge1xuICByZXR1cm4gZWxlbWVudFJhbmdlLnN0YXJ0SW5kZXggKyBlbGVtZW50UmFuZ2UuY291bnQ7XG59XG5cbmZ1bmN0aW9uIGVuZEluZGV4T2ZPYmplY3RJZChpZDogT2JqZWN0SWQpOiBPYmplY3RJZCB7XG4gIHJldHVybiBlbmRJbmRleE9mRWxlbWVudFJhbmdlKGlkLmVsZW1lbnRSYW5nZSk7XG59XG5cbmZ1bmN0aW9uIHN0YXJ0SW5kZXhPZk9iamVjdElkKGlkOiBPYmplY3RJZCwgcGFnZXNpemU6IG51bWJlcik6IG51bWJlciB7XG4gIGlmIChpc1NpbmdsZVBhZ2VPYmplY3RJZChpZCkpIHtcbiAgICByZXR1cm4gaWQucGFnZSAqIHBhZ2VzaXplO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBpZC5lbGVtZW50UmFuZ2Uuc3RhcnRJbmRleDtcbiAgfVxufVxuXG5mdW5jdGlvbiBjb3VudE9mT2JqZWN0SWQoaWQ6IE9iamVjdElkLCBwYWdlc2l6ZTogbnVtYmVyLCBwYXJlbnRFbmRJbmRleDogbnVtYmVyKTogbnVtYmVyIHtcbiAgaWYgKGlzU2luZ2xlUGFnZU9iamVjdElkKGlkKSkge1xuICAgIHJldHVybiBNYXRoLm1pbihwYWdlc2l6ZSwgcGFyZW50RW5kSW5kZXggLSBzdGFydEluZGV4T2ZPYmplY3RJZChpZCwgcGFnZXNpemUpKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaWQuZWxlbWVudFJhbmdlLmNvdW50O1xuICB9XG59XG5cbi8qXG4gKiBHaXZlbiBhIFBhZ2VkT2JqZWN0SWQsIHJldHVybiBhbiBhcnJheSBvZiBPYmplY3RJZHMgZm9yIGl0cyBjaGlsZHJlbi5cbiAqIE5vdGUgdGhhdCB0aGUgY2hpbGRyZW4gbWF5IGJlIGEgY29tYmluYXRpb24gb2YgUGFnZWRPYmplY3RJZHMgYW5kIFNpbmdsZVBhZ2VPYmplY3RJZHMuXG4gKi9cbmZ1bmN0aW9uIGdldENoaWxkSWRzKGlkOiBPYmplY3RJZCk6IEFycmF5PFByb3BlcnR5RGVzY3JpcHRvcj4ge1xuICBjb25zdCBwYWdlc2l6ZSA9IGlkLmVsZW1lbnRSYW5nZS5wYWdlc2l6ZTtcblxuICAvLyBIYW5kbGUgYSBwYWdlIG9mIHBhZ2VzICguLi4gb2YgcGFnZXMpXG4gIGxldCBjaGlsZFNpemUgPSBwYWdlc2l6ZTtcbiAgd2hpbGUgKChjaGlsZFNpemUgKiBwYWdlc2l6ZSkgPCBpZC5lbGVtZW50UmFuZ2UuY291bnQpIHtcbiAgICBjaGlsZFNpemUgKj0gcGFnZXNpemU7XG4gIH1cblxuICBjb25zdCByZXN1bHQgPSBbXTtcbiAgbGV0IGNoaWxkU3RhcnRJbmRleCA9IGlkLmVsZW1lbnRSYW5nZS5zdGFydEluZGV4O1xuICBjb25zdCBlbmRJbmRleCA9IGVuZEluZGV4T2ZPYmplY3RJZChpZCk7XG4gIHdoaWxlIChjaGlsZFN0YXJ0SW5kZXggPCBlbmRJbmRleCkge1xuICAgIGNvbnN0IGNoaWxkQ291bnQgPSBNYXRoLm1pbihjaGlsZFNpemUsIGVuZEluZGV4IC0gY2hpbGRTdGFydEluZGV4KTtcblxuICAgIGxldCBjaGlsZElkO1xuICAgIGlmIChjaGlsZENvdW50IDw9IHBhZ2VzaXplKSB7XG4gICAgICBjaGlsZElkID0gc2luZ2xlUGFnZU9iamVjdElkKGlkLCBpZC5mdWxsbmFtZSwgTWF0aC50cnVuYyhjaGlsZFN0YXJ0SW5kZXggLyBwYWdlc2l6ZSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjaGlsZElkID0gcGFnZWRPYmplY3RJZChpZCwgaWQuZnVsbG5hbWUsIHtwYWdlc2l6ZSwgc3RhcnRJbmRleDogY2hpbGRTdGFydEluZGV4LCBjb3VudDogY2hpbGRDb3VudH0pO1xuICAgIH1cblxuICAgIHJlc3VsdC5wdXNoKGNoaWxkSWQpO1xuXG4gICAgY2hpbGRTdGFydEluZGV4ICs9IGNoaWxkQ291bnQ7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICByZW1vdGVPYmplY3RJZE9mT2JqZWN0SWQsXG4gIGNyZWF0ZUNvbnRleHRPYmplY3RJZCxcbiAgcGFnZWRPYmplY3RJZCxcbiAgc2luZ2xlUGFnZU9iamVjdElkLFxuICBpc0NvbnRleHRPYmplY3RJZCxcbiAgaXNTaW5nbGVQYWdlT2JqZWN0SWQsXG4gIGlzUGFnZWRPYmplY3RJZCxcbiAgY29weU9iamVjdElkLFxuICBlbmRJbmRleE9mRWxlbWVudFJhbmdlLFxuICBlbmRJbmRleE9mT2JqZWN0SWQsXG4gIHN0YXJ0SW5kZXhPZk9iamVjdElkLFxuICBjb3VudE9mT2JqZWN0SWQsXG4gIGdldENoaWxkSWRzLFxuICBnZXRXYXRjaENvbnRleHRPYmplY3RJZCxcbiAgaXNXYXRjaENvbnRleHRPYmplY3RJZCxcbn07XG4iXX0=
