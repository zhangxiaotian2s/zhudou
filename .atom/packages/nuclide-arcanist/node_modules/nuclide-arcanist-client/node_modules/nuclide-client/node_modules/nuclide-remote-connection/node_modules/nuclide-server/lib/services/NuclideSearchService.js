
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

// TODO (mikeo): Make this another search provider

var doSearchDirectory = _asyncToGenerator(function* (directoryUri, query) {
  var search = fileSearchers[directoryUri];
  if (search === undefined) {
    var directory = remoteUri.parse(directoryUri).path;

    var exists = yield fsPromise.exists(directory);
    if (!exists) {
      throw new Error('Could not find directory to search : ' + directory);
    }

    var stat = yield fsPromise.stat(directory);
    if (!stat.isDirectory()) {
      throw new Error('Provided path is not a directory : ' + directory);
    }

    search = yield fileSearchForDirectory(directoryUri);
    fileSearchers[directoryUri] = search;
  }

  return yield search.query(query);
});

var getSearchProviders = _asyncToGenerator(function* (cwd) {
  var checkAvailability = _asyncToGenerator(function* (providerName) {
    var isAvailable = yield providers[providerName].isAvailable(cwd);
    return isAvailable ? { name: providerName } : null;
  });

  var validPromises = [];

  for (var _name in providers) {
    validPromises.push(checkAvailability(_name));
  }

  var results = yield Promise.all(validPromises);
  return results.filter(function (provider) {
    return !!provider;
  });
});

var doSearchQuery = _asyncToGenerator(function* (cwd, provider, query) {
  var currentProvider = providers[provider];
  if (!currentProvider) {
    throw new Error('Invalid provider: ' + provider);
  }
  var results = yield currentProvider.query(cwd, query);
  return { results: results };
});

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

var _require = require('nuclide-commons');

var fsPromise = _require.fsPromise;

var _require2 = require('nuclide-path-search');

var fileSearchForDirectory = _require2.fileSearchForDirectory;

var remoteUri = require('nuclide-remote-uri');

var providers = undefined;

/*
 * TODO(williamsc): This needs to have some better
 *                  managment tools (Adding/removing query sets).
 */

// Cache of previously indexed folders for later use.
var fileSearchers = Object.create(null);

function addProvider(name, provider) {
  providers = providers || {};
  if (providers[name]) {
    throw new Error(name + ' has already been added as a provider.');
  }
  providers[name] = provider;
}

function clearProviders() {
  providers = undefined;
}

function initialize(server) {}

function shutdown(server) {
  clearProviders();
  for (var k in fileSearchers) {
    fileSearchers[k].dispose();
  }
  fileSearchers = Object.create(null);
}

module.exports = {
  initialize: initialize,
  shutdown: shutdown,
  addProvider: addProvider,
  clearProviders: clearProviders,
  services: {
    '/search/query': { handler: doSearchQuery, method: 'post' },
    '/search/listProviders': { handler: getSearchProviders, method: 'post' },
    '/search/directory': { handler: doSearchDirectory }
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXNlcnZlci9saWIvc2VydmljZXMvTnVjbGlkZVNlYXJjaFNlcnZpY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFDOzs7Ozs7Ozs7Ozs7SUFrREcsaUJBQWlCLHFCQUFoQyxXQUFpQyxZQUFvQixFQUFFLEtBQWEsRUFBb0M7QUFDdEcsTUFBSSxNQUFNLEdBQUcsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3pDLE1BQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtBQUN4QixRQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQzs7QUFFckQsUUFBTSxNQUFNLEdBQUcsTUFBTSxTQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2pELFFBQUksQ0FBQyxNQUFNLEVBQUU7QUFDWCxZQUFNLElBQUksS0FBSyxDQUFDLHVDQUF1QyxHQUFHLFNBQVMsQ0FBQyxDQUFDO0tBQ3RFOztBQUVELFFBQU0sSUFBSSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUM3QyxRQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFO0FBQ3ZCLFlBQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLEdBQUcsU0FBUyxDQUFDLENBQUM7S0FDcEU7O0FBRUQsVUFBTSxHQUFHLE1BQU0sc0JBQXNCLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDcEQsaUJBQWEsQ0FBQyxZQUFZLENBQUMsR0FBRyxNQUFNLENBQUM7R0FDdEM7O0FBRUQsU0FBTyxNQUFNLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Q0FDbEM7O0lBRWMsa0JBQWtCLHFCQUFqQyxXQUFrQyxHQUFXLEVBQWdDO01BRzVE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IiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXNlcnZlci9saWIvc2VydmljZXMvTnVjbGlkZVNlYXJjaFNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG50eXBlIFNlYXJjaFF1ZXJ5ID0ge1xuICBwcm92aWRlcjogc3RyaW5nO1xuICBxdWVyeTogc3RyaW5nO1xufVxuXG50eXBlIFByb3ZpZGVySW5mbyA9IHtcbiAgbmFtZTogc3RyaW5nO1xufVxuXG50eXBlIFNlYXJjaFF1ZXJ5UmVzdWx0ID0ge1xuICBsaW5lOiBudW1iZXI7XG4gIGNvbHVtbjogbnVtYmVyO1xuICBuYW1lOiBzdHJpbmc7XG4gIHBhdGg6IHN0cmluZztcbiAgbGVuZ3RoOiBudW1iZXI7XG4gIHNjb3BlOiBzdHJpbmc7XG4gIGFkZGl0aW9uYWxJbmZvOiBzdHJpbmc7XG4gIGFjdGlvbjogc3RyaW5nO1xufVxuXG50eXBlIFNlYXJjaFJlc3BvbnNlID0ge1xuICByZXN1bHRzOiBBcnJheTxTZWFyY2hRdWVyeVJlc3VsdD47XG59XG5cbmNvbnN0IHtmc1Byb21pc2V9ID0gcmVxdWlyZSgnbnVjbGlkZS1jb21tb25zJyk7XG5jb25zdCB7ZmlsZVNlYXJjaEZvckRpcmVjdG9yeX0gPSByZXF1aXJlKCdudWNsaWRlLXBhdGgtc2VhcmNoJyk7XG5jb25zdCByZW1vdGVVcmkgPSByZXF1aXJlKCdudWNsaWRlLXJlbW90ZS11cmknKTtcblxubGV0IHByb3ZpZGVycztcblxuLypcbiAqIFRPRE8od2lsbGlhbXNjKTogVGhpcyBuZWVkcyB0byBoYXZlIHNvbWUgYmV0dGVyXG4gKiAgICAgICAgICAgICAgICAgIG1hbmFnbWVudCB0b29scyAoQWRkaW5nL3JlbW92aW5nIHF1ZXJ5IHNldHMpLlxuICovXG5cbi8vIENhY2hlIG9mIHByZXZpb3VzbHkgaW5kZXhlZCBmb2xkZXJzIGZvciBsYXRlciB1c2UuXG5sZXQgZmlsZVNlYXJjaGVyczogYW55ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuLy8gVE9ETyAobWlrZW8pOiBNYWtlIHRoaXMgYW5vdGhlciBzZWFyY2ggcHJvdmlkZXJcbmFzeW5jIGZ1bmN0aW9uIGRvU2VhcmNoRGlyZWN0b3J5KGRpcmVjdG9yeVVyaTogc3RyaW5nLCBxdWVyeTogc3RyaW5nKTogUHJvbWlzZTxBcnJheTxGaWxlU2VhcmNoUmVzdWx0Pj4ge1xuICBsZXQgc2VhcmNoID0gZmlsZVNlYXJjaGVyc1tkaXJlY3RvcnlVcmldO1xuICBpZiAoc2VhcmNoID09PSB1bmRlZmluZWQpIHtcbiAgICBjb25zdCBkaXJlY3RvcnkgPSByZW1vdGVVcmkucGFyc2UoZGlyZWN0b3J5VXJpKS5wYXRoO1xuXG4gICAgY29uc3QgZXhpc3RzID0gYXdhaXQgZnNQcm9taXNlLmV4aXN0cyhkaXJlY3RvcnkpO1xuICAgIGlmICghZXhpc3RzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIGRpcmVjdG9yeSB0byBzZWFyY2ggOiAnICsgZGlyZWN0b3J5KTtcbiAgICB9XG5cbiAgICBjb25zdCBzdGF0ID0gYXdhaXQgZnNQcm9taXNlLnN0YXQoZGlyZWN0b3J5KTtcbiAgICBpZiAoIXN0YXQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm92aWRlZCBwYXRoIGlzIG5vdCBhIGRpcmVjdG9yeSA6ICcgKyBkaXJlY3RvcnkpO1xuICAgIH1cblxuICAgIHNlYXJjaCA9IGF3YWl0IGZpbGVTZWFyY2hGb3JEaXJlY3RvcnkoZGlyZWN0b3J5VXJpKTtcbiAgICBmaWxlU2VhcmNoZXJzW2RpcmVjdG9yeVVyaV0gPSBzZWFyY2g7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgc2VhcmNoLnF1ZXJ5KHF1ZXJ5KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U2VhcmNoUHJvdmlkZXJzKGN3ZDogc3RyaW5nKTogUHJvbWlzZTxBcnJheTxQcm92aWRlckluZm8+PiB7XG4gIGNvbnN0IHZhbGlkUHJvbWlzZXMgPSBbXTtcblxuICBhc3luYyBmdW5jdGlvbiBjaGVja0F2YWlsYWJpbGl0eShwcm92aWRlck5hbWUpIHtcbiAgICBjb25zdCBpc0F2YWlsYWJsZSA9IGF3YWl0IHByb3ZpZGVyc1twcm92aWRlck5hbWVdLmlzQXZhaWxhYmxlKGN3ZCk7XG4gICAgcmV0dXJuIGlzQXZhaWxhYmxlID8ge25hbWU6IHByb3ZpZGVyTmFtZX0gOiBudWxsO1xuICB9XG5cbiAgZm9yIChjb25zdCBuYW1lIGluIHByb3ZpZGVycykge1xuICAgIHZhbGlkUHJvbWlzZXMucHVzaChjaGVja0F2YWlsYWJpbGl0eShuYW1lKSk7XG4gIH1cblxuICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwodmFsaWRQcm9taXNlcyk7XG4gIHJldHVybiByZXN1bHRzLmZpbHRlcigocHJvdmlkZXIpID0+ICEhcHJvdmlkZXIpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkb1NlYXJjaFF1ZXJ5KGN3ZDogc3RyaW5nLCBwcm92aWRlcjogc3RyaW5nLCBxdWVyeTogc3RyaW5nKTogUHJvbWlzZTxTZWFyY2hSZXNwb25zZT4ge1xuICBjb25zdCBjdXJyZW50UHJvdmlkZXIgPSBwcm92aWRlcnNbcHJvdmlkZXJdO1xuICBpZiAoIWN1cnJlbnRQcm92aWRlcikge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwcm92aWRlcjogJHtwcm92aWRlcn1gKTtcbiAgfVxuICBjb25zdCByZXN1bHRzID0gYXdhaXQgY3VycmVudFByb3ZpZGVyLnF1ZXJ5KGN3ZCwgcXVlcnkpO1xuICByZXR1cm4ge3Jlc3VsdHN9O1xufVxuXG5mdW5jdGlvbiBhZGRQcm92aWRlcihuYW1lOiBzdHJpbmcsIHByb3ZpZGVyKSB7XG4gIHByb3ZpZGVycyA9IHByb3ZpZGVycyB8fCB7fTtcbiAgaWYgKHByb3ZpZGVyc1tuYW1lXSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJHtuYW1lfSBoYXMgYWxyZWFkeSBiZWVuIGFkZGVkIGFzIGEgcHJvdmlkZXIuYCk7XG4gIH1cbiAgcHJvdmlkZXJzW25hbWVdID0gcHJvdmlkZXI7XG59XG5cbmZ1bmN0aW9uIGNsZWFyUHJvdmlkZXJzKCkge1xuICBwcm92aWRlcnMgPSB1bmRlZmluZWQ7XG59XG5cbmZ1bmN0aW9uIGluaXRpYWxpemUoc2VydmVyKSB7XG59XG5cbmZ1bmN0aW9uIHNodXRkb3duKHNlcnZlcikge1xuICBjbGVhclByb3ZpZGVycygpO1xuICBmb3IgKGNvbnN0IGsgaW4gZmlsZVNlYXJjaGVycykge1xuICAgIGZpbGVTZWFyY2hlcnNba10uZGlzcG9zZSgpO1xuICB9XG4gIGZpbGVTZWFyY2hlcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgaW5pdGlhbGl6ZSxcbiAgc2h1dGRvd24sXG4gIGFkZFByb3ZpZGVyLFxuICBjbGVhclByb3ZpZGVycyxcbiAgc2VydmljZXM6IHtcbiAgICAnL3NlYXJjaC9xdWVyeSc6IHtoYW5kbGVyOiBkb1NlYXJjaFF1ZXJ5LCBtZXRob2Q6ICdwb3N0J30sXG4gICAgJy9zZWFyY2gvbGlzdFByb3ZpZGVycyc6IHtoYW5kbGVyOiBnZXRTZWFyY2hQcm92aWRlcnMsIG1ldGhvZDogJ3Bvc3QnfSxcbiAgICAnL3NlYXJjaC9kaXJlY3RvcnknOiB7aGFuZGxlcjogZG9TZWFyY2hEaXJlY3Rvcnl9LFxuICB9LFxufTtcbiJdfQ==
