Object.defineProperty(exports, '__esModule', {
  value: true
});

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var _WatchmanSubscription = require('./WatchmanSubscription');

var _WatchmanSubscription2 = _interopRequireDefault(_WatchmanSubscription);

'use babel';

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var watchman = require('fb-watchman');

var isEmpty = require('nuclide-commons').object.isEmpty;

var logger = require('nuclide-logging').getLogger();

var _require = require('./main');

var getWatchmanBinaryPath = _require.getWatchmanBinaryPath;

var path = require('path');

var WatchmanClient = (function () {
  function WatchmanClient() {
    _classCallCheck(this, WatchmanClient);

    this._initWatchmanClient();
    this._subscriptions = Object.create(null);
    this._watchmanVersionPromise = this.version();
  }

  _createClass(WatchmanClient, [{
    key: 'dispose',
    value: function dispose() {
      var _this = this;

      return new Promise(function (resolve, reject) {
        if (_this._clientPromise) {
          _this._clientPromise.then(function (client) {
            client.once('end', function () {
              resolve();
            });
            client.end();
          });
        } else {
          reject();
        }
      });
    }
  }, {
    key: '_initWatchmanClient',
    value: function _initWatchmanClient() {
      var _this2 = this;

      this._clientPromise = this._createClientPromise();
      this._clientPromise.then(function (client) {
        client.on('end', function () {
          return _this2._onClientEnd();
        });
        client.on('error', function (error) {
          return logger.error('Error while talking to watchman: ', error);
        });
        client.on('subscription', function (response) {
          return _this2._onSubscriptionResult(response);
        });
      });
    }
  }, {
    key: '_createClientPromise',
    value: _asyncToGenerator(function* () {
      return new watchman.Client({
        watchmanBinaryPath: yield getWatchmanBinaryPath()
      });
    })
  }, {
    key: '_onClientEnd',
    value: function _onClientEnd() {
      logger.warn('Watchman client ended, creating a new client!');
      this._clientPromise.then(function (client) {
        client.removeAllListeners('end');
        client.removeAllListeners('error');
        client.removeAllListeners('subscription');
      });
      this._initWatchmanClient();
      this._restoreSubscriptions();
    }
  }, {
    key: '_restoreSubscriptions',
    value: _asyncToGenerator(function* () {
      var _this3 = this;

      var watchSubscriptions = [];
      for (var _key in this._subscriptions) {
        watchSubscriptions.push(this._subscriptions[_key]);
      }
      yield Promise.all(watchSubscriptions.map(_asyncToGenerator(function* (subscription) {
        subscription.options.since = yield _this3._clock(subscription.root);
        yield _this3._watchProject(subscription.path);
        yield _this3._subscribe(subscription.root, subscription.name, subscription.options);
      })));
    })
  }, {
    key: '_getSubscription',
    value: function _getSubscription(entryPath) {
      return this._subscriptions[path.normalize(entryPath)];
    }
  }, {
    key: '_setSubscription',
    value: function _setSubscription(entryPath, subscription) {
      this._subscriptions[path.normalize(entryPath)] = subscription;
      return subscription;
    }
  }, {
    key: '_deleteSubscription',
    value: function _deleteSubscription(entryPath) {
      delete this._subscriptions[path.normalize(entryPath)];
    }
  }, {
    key: '_onSubscriptionResult',
    value: function _onSubscriptionResult(response) {
      var subscription = this._getSubscription(response.subscription);
      if (!subscription) {
        return logger.error('Subscription not found for response:!', response);
      }
      subscription.emit('change', response.files);
    }
  }, {
    key: 'watchDirectoryRecursive',
    value: _asyncToGenerator(function* (localDirectoryPath) {
      var existingSubscription = this._getSubscription(localDirectoryPath);
      if (existingSubscription) {
        existingSubscription.subscriptionCount++;
        return existingSubscription;
      } else {
        var _ref = yield this._watchProject(localDirectoryPath);

        var watchRoot = _ref.watch;
        var relativePath = _ref.relative_path;

        var clock = yield this._clock(watchRoot);
        var options = {
          fields: ['name', 'new', 'exists', 'mode'],
          since: clock
        };
        if (relativePath) {
          // Passing an 'undefined' expression causes an exception in fb-watchman.
          options.expression = ['dirname', relativePath];
        }
        // relativePath is undefined if watchRoot is the same as directoryPath.
        var _subscription = this._setSubscription(localDirectoryPath, new _WatchmanSubscription2['default'](
        /*subscriptionRoot*/watchRoot,
        /*pathFromSubscriptionRootToSubscriptionPath*/relativePath,
        /*subscriptionPath*/localDirectoryPath,
        /*subscriptionCount*/1,
        /*subscriptionOptions*/options));
        yield this._subscribe(watchRoot, localDirectoryPath, options);
        return _subscription;
      }
    })
  }, {
    key: 'hasSubscription',
    value: function hasSubscription(entryPath) {
      return !!this._getSubscription(entryPath);
    }
  }, {
    key: 'unwatch',
    value: _asyncToGenerator(function* (entryPath) {
      var subscription = this._getSubscription(entryPath);

      if (!subscription) {
        return logger.error('No watcher entity found with path:', entryPath);
      }

      if (--subscription.subscriptionCount === 0) {

        yield this._unsubscribe(subscription.path, subscription.name);
        // Don't delete the watcher if there are other users for it.
        if (!subscription.pathFromSubscriptionRootToSubscriptionPath) {
          yield this._deleteWatcher(entryPath);
        }
        this._deleteSubscription(entryPath);

        if (isEmpty(this._subscriptions)) {
          yield this.dispose();
        }
      }
    })
  }, {
    key: '_watchList',
    value: _asyncToGenerator(function* () {
      var _ref2 = yield this._command('watch-list');

      var roots = _ref2.roots;

      return roots;
    })
  }, {
    key: '_deleteWatcher',
    value: function _deleteWatcher(entryPath) {
      return this._command('watch-del', entryPath);
    }
  }, {
    key: '_unsubscribe',
    value: function _unsubscribe(subscriptionPath, subscriptionName) {
      return this._command('unsubscribe', subscriptionPath, subscriptionName);
    }
  }, {
    key: '_watch',
    value: _asyncToGenerator(function* (directoryPath) {
      var response = yield this._command('watch', directoryPath);
      if (response.warning) {
        logger.warn('watchman warning: ', response.warning);
      }
    })
  }, {
    key: '_watchProject',
    value: _asyncToGenerator(function* (directoryPath) {
      var watchmanVersion = yield this._watchmanVersionPromise;
      if (!watchmanVersion || watchmanVersion < '3.1.0') {
        throw new Error('Watchman version: ' + watchmanVersion + ' does not support watch-project');
      }
      var response = yield this._command('watch-project', directoryPath);
      if (response.warning) {
        logger.warn('watchman warning: ', response.warning);
      }
      return response;
    })
  }, {
    key: '_clock',
    value: _asyncToGenerator(function* (directoryPath) {
      var _ref3 = yield this._command('clock', directoryPath);

      var clock = _ref3.clock;

      return clock;
    })
  }, {
    key: 'version',
    value: _asyncToGenerator(function* () {
      var _ref4 = yield this._command('version');

      var version = _ref4.version;

      return version;
    })
  }, {
    key: '_subscribe',
    value: function _subscribe(watchRoot, subscriptionName, options) {
      return this._command('subscribe', watchRoot, subscriptionName, options);
    }

    /*
     * Promisify calls to watchman client.
     */
  }, {
    key: '_command',
    value: function _command() {
      var _this4 = this;

      for (var _len = arguments.length, args = Array(_len), _key2 = 0; _key2 < _len; _key2++) {
        args[_key2] = arguments[_key2];
      }

      return new Promise(function (resolve, reject) {
        _this4._clientPromise.then(function (client) {
          client.command(args, function (error, response) {
            return error ? reject(error) : resolve(response);
          });
        })['catch'](reject);
      });
    }
  }]);

  return WatchmanClient;
})();

module.exports = WatchmanClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXdhdGNobWFuLWhlbHBlcnMvbGliL1dhdGNobWFuQ2xpZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztvQ0FrQmlDLHdCQUF3Qjs7OztBQWxCekQsV0FBVyxDQUFDOzs7Ozs7Ozs7O0FBV1osSUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDOztJQUVqQyxPQUFPLEdBQUksT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsTUFBTSxDQUE1QyxPQUFPOztBQUNkLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDOztlQUN0QixPQUFPLENBQUMsUUFBUSxDQUFDOztJQUExQyxxQkFBcUIsWUFBckIscUJBQXFCOztBQUM1QixJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7O0lBa0J2QixjQUFjO0FBSVAsV0FKUCxjQUFjLEdBSUo7MEJBSlYsY0FBYzs7QUFLaEIsUUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7QUFDM0IsUUFBSSxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzFDLFFBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7R0FDL0M7O2VBUkcsY0FBYzs7V0FVWCxtQkFBWTs7O0FBQ2pCLGFBQU8sSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFLO0FBQ3RDLFlBQUksTUFBSyxjQUFjLEVBQUU7QUFDdkIsZ0JBQUssY0FBYyxDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU0sRUFBSTtBQUNqQyxrQkFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsWUFBTTtBQUN2QixxQkFB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QVMsQ0FBQzs7VUFBekMsT0FBTyxTQUFQLE9BQU87O0FBQ2QsYUFBTyxPQUFPLENBQUM7S0FDaEI7OztXQUVTLG9CQUNKLFNBQWlCLEVBQ2pCLGdCQUF5QixFQUN6QixPQUFvQyxFQUNMO0FBQ25DLGFBQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ3pFOzs7Ozs7O1dBS08sb0JBQW9DOzs7d0NBQWhDLElBQUk7QUFBSixZQUFJOzs7QUFDZCxhQUFPLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU0sRUFBSztBQUN0QyxlQUFLLGNBQWMsQ0FBQyxJQUFJLENBQUMsVUFBQSxNQUFNLEVBQUk7QUFDakMsZ0JBQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLFVBQUMsS0FBSyxFQUFFLFFBQVE7bUJBQ2pDLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztXQUFBLENBQUMsQ0FBQztTQUNoRCxDQUFDLFNBQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztPQUNsQixDQUFDLENBQUM7S0FDSjs7O1NBeE1HLGNBQWM7OztBQTJNcEIsTUFBTSxDQUFDLE9BQU8sR0FBRyxjQUFjLENBQUMiLCJmaWxlIjoiL3Zhci9mb2xkZXJzL3hmL3JzcGg0X2M1NzMxNXJzNTd4eHNkc2tyeG52MzZ0MC9UL3RtcHBmbDUybnB1Ymxpc2hfcGFja2FnZXMvbnBtL251Y2xpZGUtd2F0Y2htYW4taGVscGVycy9saWIvV2F0Y2htYW5DbGllbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG5jb25zdCB3YXRjaG1hbiA9IHJlcXVpcmUoJ2ZiLXdhdGNobWFuJyk7XG5cbmNvbnN0IHtpc0VtcHR5fSA9IHJlcXVpcmUoJ251Y2xpZGUtY29tbW9ucycpLm9iamVjdDtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJ251Y2xpZGUtbG9nZ2luZycpLmdldExvZ2dlcigpO1xuY29uc3Qge2dldFdhdGNobWFuQmluYXJ5UGF0aH0gPSByZXF1aXJlKCcuL21haW4nKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbmltcG9ydCBXYXRjaG1hblN1YnNjcmlwdGlvbiBmcm9tICcuL1dhdGNobWFuU3Vic2NyaXB0aW9uJztcbmltcG9ydCB0eXBlIHtXYXRjaG1hblN1YnNjcmlwdGlvbk9wdGlvbnN9IGZyb20gJy4vV2F0Y2htYW5TdWJzY3JpcHRpb24nO1xuXG50eXBlIFdhdGNobWFuU3Vic2NyaXB0aW9uUmVzcG9uc2UgPSB7XG4gIHJvb3Q6IHN0cmluZztcbiAgc3Vic2NyaXB0aW9uOiBzdHJpbmc7XG4gIGZpbGVzOiBBcnJheTxGaWxlQ2hhbmdlPjtcbn07XG5cbmV4cG9ydCB0eXBlIEZpbGVDaGFuZ2UgPSB7XG4gIG5hbWU6IHN0cmluZztcbiAgbmV3OiBib29sZWFuO1xuICBleGlzdHM6IGJvb2xlYW47XG4gIG1vZGU6IG51bWJlcjtcbn07XG5cbmNsYXNzIFdhdGNobWFuQ2xpZW50IHtcbiAgX3N1YnNjcmlwdGlvbnM6IHtba2V5OiBzdHJpbmddOiBXYXRjaG1hblN1YnNjcmlwdGlvbn07XG4gIF9jbGllbnRQcm9taXNlOiBQcm9taXNlPHdhdGNobWFuLkNsaWVudD47XG4gIF93YXRjaG1hblZlcnNpb25Qcm9taXNlOiBQcm9taXNlPHN0cmluZz47XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuX2luaXRXYXRjaG1hbkNsaWVudCgpO1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgIHRoaXMuX3dhdGNobWFuVmVyc2lvblByb21pc2UgPSB0aGlzLnZlcnNpb24oKTtcbiAgfVxuXG4gIGRpc3Bvc2UoKTogUHJvbWlzZSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh0aGlzLl9jbGllbnRQcm9taXNlKSB7XG4gICAgICAgIHRoaXMuX2NsaWVudFByb21pc2UudGhlbihjbGllbnQgPT4ge1xuICAgICAgICAgIGNsaWVudC5vbmNlKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY2xpZW50LmVuZCgpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlamVjdCgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgX2luaXRXYXRjaG1hbkNsaWVudCgpIHtcbiAgICB0aGlzLl9jbGllbnRQcm9taXNlID0gdGhpcy5fY3JlYXRlQ2xpZW50UHJvbWlzZSgpO1xuICAgIHRoaXMuX2NsaWVudFByb21pc2UudGhlbihjbGllbnQgPT4ge1xuICAgICAgY2xpZW50Lm9uKCdlbmQnLCAoKSA9PiB0aGlzLl9vbkNsaWVudEVuZCgpKTtcbiAgICAgIGNsaWVudC5vbignZXJyb3InLCBlcnJvciA9PiBsb2dnZXIuZXJyb3IoJ0Vycm9yIHdoaWxlIHRhbGtpbmcgdG8gd2F0Y2htYW46ICcsIGVycm9yKSk7XG4gICAgICBjbGllbnQub24oJ3N1YnNjcmlwdGlvbicsIHJlc3BvbnNlID0+IHRoaXMuX29uU3Vic2NyaXB0aW9uUmVzdWx0KHJlc3BvbnNlKSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBfY3JlYXRlQ2xpZW50UHJvbWlzZSgpOiBQcm9taXNlPHdhdGNobWFuLkNsaWVudD4ge1xuICAgIHJldHVybiBuZXcgd2F0Y2htYW4uQ2xpZW50KHtcbiAgICAgIHdhdGNobWFuQmluYXJ5UGF0aDogYXdhaXQgZ2V0V2F0Y2htYW5CaW5hcnlQYXRoKCksXG4gICAgfSk7XG4gIH1cblxuICBfb25DbGllbnRFbmQoKSB7XG4gICAgbG9nZ2VyLndhcm4oJ1dhdGNobWFuIGNsaWVudCBlbmRlZCwgY3JlYXRpbmcgYSBuZXcgY2xpZW50IScpO1xuICAgIHRoaXMuX2NsaWVudFByb21pc2UudGhlbihjbGllbnQgPT4ge1xuICAgICAgY2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygnZW5kJyk7XG4gICAgICBjbGllbnQucmVtb3ZlQWxsTGlzdGVuZXJzKCdlcnJvcicpO1xuICAgICAgY2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygnc3Vic2NyaXB0aW9uJyk7XG4gICAgfSk7XG4gICAgdGhpcy5faW5pdFdhdGNobWFuQ2xpZW50KCk7XG4gICAgdGhpcy5fcmVzdG9yZVN1YnNjcmlwdGlvbnMoKTtcbiAgfVxuXG4gIGFzeW5jIF9yZXN0b3JlU3Vic2NyaXB0aW9ucygpOiBQcm9taXNlIHtcbiAgICBjb25zdCB3YXRjaFN1YnNjcmlwdGlvbnM6IEFycmF5PFdhdGNobWFuU3Vic2NyaXB0aW9uPiA9IFtdO1xuICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMuX3N1YnNjcmlwdGlvbnMpIHtcbiAgICAgIHdhdGNoU3Vic2NyaXB0aW9ucy5wdXNoKHRoaXMuX3N1YnNjcmlwdGlvbnNba2V5XSk7XG4gICAgfVxuICAgIGF3YWl0IFByb21pc2UuYWxsKHdhdGNoU3Vic2NyaXB0aW9ucy5tYXAoYXN5bmMgKHN1YnNjcmlwdGlvbjogV2F0Y2htYW5TdWJzY3JpcHRpb24pID0+IHtcbiAgICAgIHN1YnNjcmlwdGlvbi5vcHRpb25zLnNpbmNlID0gYXdhaXQgdGhpcy5fY2xvY2soc3Vic2NyaXB0aW9uLnJvb3QpO1xuICAgICAgYXdhaXQgdGhpcy5fd2F0Y2hQcm9qZWN0KHN1YnNjcmlwdGlvbi5wYXRoKTtcbiAgICAgIGF3YWl0IHRoaXMuX3N1YnNjcmliZShzdWJzY3JpcHRpb24ucm9vdCwgc3Vic2NyaXB0aW9uLm5hbWUsIHN1YnNjcmlwdGlvbi5vcHRpb25zKTtcbiAgICB9KSk7XG4gIH1cblxuICBfZ2V0U3Vic2NyaXB0aW9uKGVudHJ5UGF0aDogc3RyaW5nKTogP1dhdGNobWFuU3Vic2NyaXB0aW9uIHtcbiAgICByZXR1cm4gdGhpcy5fc3Vic2NyaXB0aW9uc1twYXRoLm5vcm1hbGl6ZShlbnRyeVBhdGgpXTtcbiAgfVxuXG4gIF9zZXRTdWJzY3JpcHRpb24oZW50cnlQYXRoOiBzdHJpbmcsIHN1YnNjcmlwdGlvbjogV2F0Y2htYW5TdWJzY3JpcHRpb24pOiBXYXRjaG1hblN1YnNjcmlwdGlvbiB7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9uc1twYXRoLm5vcm1hbGl6ZShlbnRyeVBhdGgpXSA9IHN1YnNjcmlwdGlvbjtcbiAgICByZXR1cm4gc3Vic2NyaXB0aW9uO1xuICB9XG5cbiAgX2RlbGV0ZVN1YnNjcmlwdGlvbihlbnRyeVBhdGg6IHN0cmluZyk6IHZvaWQge1xuICAgIGRlbGV0ZSB0aGlzLl9zdWJzY3JpcHRpb25zW3BhdGgubm9ybWFsaXplKGVudHJ5UGF0aCldO1xuICB9XG5cbiAgX29uU3Vic2NyaXB0aW9uUmVzdWx0KHJlc3BvbnNlOiBXYXRjaG1hblN1YnNjcmlwdGlvblJlc3BvbnNlKSB7XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5fZ2V0U3Vic2NyaXB0aW9uKHJlc3BvbnNlLnN1YnNjcmlwdGlvbik7XG4gICAgaWYgKCFzdWJzY3JpcHRpb24pIHtcbiAgICAgIHJldHVybiBsb2dnZXIuZXJyb3IoJ1N1YnNjcmlwdGlvbiBub3QgZm91bmQgZm9yIHJlc3BvbnNlOiEnLCByZXNwb25zZSk7XG4gICAgfVxuICAgIHN1YnNjcmlwdGlvbi5lbWl0KCdjaGFuZ2UnLCByZXNwb25zZS5maWxlcyk7XG4gIH1cblxuICBhc3luYyB3YXRjaERpcmVjdG9yeVJlY3Vyc2l2ZShsb2NhbERpcmVjdG9yeVBhdGg6IHN0cmluZykgOiBQcm9taXNlPFdhdGNobWFuU3Vic2NyaXB0aW9uPiB7XG4gICAgY29uc3QgZXhpc3RpbmdTdWJzY3JpcHRpb24gPSB0aGlzLl9nZXRTdWJzY3JpcHRpb24obG9jYWxEaXJlY3RvcnlQYXRoKTtcbiAgICBpZiAoZXhpc3RpbmdTdWJzY3JpcHRpb24pIHtcbiAgICAgIGV4aXN0aW5nU3Vic2NyaXB0aW9uLnN1YnNjcmlwdGlvbkNvdW50Kys7XG4gICAgICByZXR1cm4gZXhpc3RpbmdTdWJzY3JpcHRpb247XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHt3YXRjaDogd2F0Y2hSb290LCByZWxhdGl2ZV9wYXRoOiByZWxhdGl2ZVBhdGh9ID0gYXdhaXQgdGhpcy5fd2F0Y2hQcm9qZWN0KGxvY2FsRGlyZWN0b3J5UGF0aCk7XG4gICAgICBjb25zdCBjbG9jayA9IGF3YWl0IHRoaXMuX2Nsb2NrKHdhdGNoUm9vdCk7XG4gICAgICBjb25zdCBvcHRpb25zOiBXYXRjaG1hblN1YnNjcmlwdGlvbk9wdGlvbnMgPSB7XG4gICAgICAgIGZpZWxkczogWyduYW1lJywgJ25ldycsICdleGlzdHMnLCAnbW9kZSddLFxuICAgICAgICBzaW5jZTogY2xvY2ssXG4gICAgICB9O1xuICAgICAgaWYgKHJlbGF0aXZlUGF0aCkge1xuICAgICAgICAvLyBQYXNzaW5nIGFuICd1bmRlZmluZWQnIGV4cHJlc3Npb24gY2F1c2VzIGFuIGV4Y2VwdGlvbiBpbiBmYi13YXRjaG1hbi5cbiAgICAgICAgb3B0aW9ucy5leHByZXNzaW9uID0gWydkaXJuYW1lJywgcmVsYXRpdmVQYXRoXTtcbiAgICAgIH1cbiAgICAgIC8vIHJlbGF0aXZlUGF0aCBpcyB1bmRlZmluZWQgaWYgd2F0Y2hSb290IGlzIHRoZSBzYW1lIGFzIGRpcmVjdG9yeVBhdGguXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLl9zZXRTdWJzY3JpcHRpb24obG9jYWxEaXJlY3RvcnlQYXRoLFxuICAgICAgICAgIG5ldyBXYXRjaG1hblN1YnNjcmlwdGlvbihcbiAgICAgICAgICAgIC8qc3Vic2NyaXB0aW9uUm9vdCovIHdhdGNoUm9vdCxcbiAgICAgICAgICAgIC8qcGF0aEZyb21TdWJzY3JpcHRpb25Sb290VG9TdWJzY3JpcHRpb25QYXRoKi8gcmVsYXRpdmVQYXRoLFxuICAgICAgICAgICAgLypzdWJzY3JpcHRpb25QYXRoKi8gbG9jYWxEaXJlY3RvcnlQYXRoLFxuICAgICAgICAgICAgLypzdWJzY3JpcHRpb25Db3VudCovIDEsXG4gICAgICAgICAgICAvKnN1YnNjcmlwdGlvbk9wdGlvbnMqLyBvcHRpb25zXG4gICAgICAgICAgKSk7XG4gICAgICBhd2FpdCB0aGlzLl9zdWJzY3JpYmUod2F0Y2hSb290LCBsb2NhbERpcmVjdG9yeVBhdGgsIG9wdGlvbnMpO1xuICAgICAgcmV0dXJuIHN1YnNjcmlwdGlvbjtcbiAgICB9XG4gIH1cblxuICBoYXNTdWJzY3JpcHRpb24oZW50cnlQYXRoOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLl9nZXRTdWJzY3JpcHRpb24oZW50cnlQYXRoKTtcbiAgfVxuXG4gIGFzeW5jIHVud2F0Y2goZW50cnlQYXRoOiBzdHJpbmcpOiBQcm9taXNlIHtcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLl9nZXRTdWJzY3JpcHRpb24oZW50cnlQYXRoKTtcblxuICAgIGlmICghc3Vic2NyaXB0aW9uKSB7XG4gICAgICByZXR1cm4gbG9nZ2VyLmVycm9yKCdObyB3YXRjaGVyIGVudGl0eSBmb3VuZCB3aXRoIHBhdGg6JywgZW50cnlQYXRoKTtcbiAgICB9XG5cbiAgICBpZiAoLS1zdWJzY3JpcHRpb24uc3Vic2NyaXB0aW9uQ291bnQgPT09IDApIHtcblxuICAgICAgYXdhaXQgdGhpcy5fdW5zdWJzY3JpYmUoc3Vic2NyaXB0aW9uLnBhdGgsIHN1YnNjcmlwdGlvbi5uYW1lKTtcbiAgICAgIC8vIERvbid0IGRlbGV0ZSB0aGUgd2F0Y2hlciBpZiB0aGVyZSBhcmUgb3RoZXIgdXNlcnMgZm9yIGl0LlxuICAgICAgaWYgKCFzdWJzY3JpcHRpb24ucGF0aEZyb21TdWJzY3JpcHRpb25Sb290VG9TdWJzY3JpcHRpb25QYXRoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2RlbGV0ZVdhdGNoZXIoZW50cnlQYXRoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2RlbGV0ZVN1YnNjcmlwdGlvbihlbnRyeVBhdGgpO1xuXG4gICAgICBpZiAoaXNFbXB0eSh0aGlzLl9zdWJzY3JpcHRpb25zKSkge1xuICAgICAgICBhd2FpdCB0aGlzLmRpc3Bvc2UoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBfd2F0Y2hMaXN0KCk6IFByb21pc2U8QXJyYXk8c3RyaW5nPj4ge1xuICAgIGNvbnN0IHtyb290c30gPSBhd2FpdCB0aGlzLl9jb21tYW5kKCd3YXRjaC1saXN0Jyk7XG4gICAgcmV0dXJuIHJvb3RzO1xuICB9XG5cbiAgX2RlbGV0ZVdhdGNoZXIoZW50cnlQYXRoOiBzdHJpbmcpOiBQcm9taXNlIHtcbiAgICByZXR1cm4gdGhpcy5fY29tbWFuZCgnd2F0Y2gtZGVsJywgZW50cnlQYXRoKTtcbiAgfVxuXG4gIF91bnN1YnNjcmliZShzdWJzY3JpcHRpb25QYXRoOiBzdHJpbmcsIHN1YnNjcmlwdGlvbk5hbWU6IHN0cmluZyk6IFByb21pc2Uge1xuICAgIHJldHVybiB0aGlzLl9jb21tYW5kKCd1bnN1YnNjcmliZScsIHN1YnNjcmlwdGlvblBhdGgsIHN1YnNjcmlwdGlvbk5hbWUpO1xuICB9XG5cbiAgYXN5bmMgX3dhdGNoKGRpcmVjdG9yeVBhdGg6IHN0cmluZyk6IFByb21pc2Uge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5fY29tbWFuZCgnd2F0Y2gnLCBkaXJlY3RvcnlQYXRoKTtcbiAgICBpZiAocmVzcG9uc2Uud2FybmluZykge1xuICAgICAgbG9nZ2VyLndhcm4oJ3dhdGNobWFuIHdhcm5pbmc6ICcsIHJlc3BvbnNlLndhcm5pbmcpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIF93YXRjaFByb2plY3QoZGlyZWN0b3J5UGF0aDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCB3YXRjaG1hblZlcnNpb24gPSBhd2FpdCB0aGlzLl93YXRjaG1hblZlcnNpb25Qcm9taXNlO1xuICAgIGlmICghd2F0Y2htYW5WZXJzaW9uIHx8IHdhdGNobWFuVmVyc2lvbiA8ICczLjEuMCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignV2F0Y2htYW4gdmVyc2lvbjogJyArIHdhdGNobWFuVmVyc2lvbiArICcgZG9lcyBub3Qgc3VwcG9ydCB3YXRjaC1wcm9qZWN0Jyk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5fY29tbWFuZCgnd2F0Y2gtcHJvamVjdCcsIGRpcmVjdG9yeVBhdGgpO1xuICAgIGlmIChyZXNwb25zZS53YXJuaW5nKSB7XG4gICAgICBsb2dnZXIud2Fybignd2F0Y2htYW4gd2FybmluZzogJywgcmVzcG9uc2Uud2FybmluZyk7XG4gICAgfVxuICAgIHJldHVybiByZXNwb25zZTtcbiAgfVxuXG4gIGFzeW5jIF9jbG9jayhkaXJlY3RvcnlQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHtjbG9ja30gPSBhd2FpdCB0aGlzLl9jb21tYW5kKCdjbG9jaycsIGRpcmVjdG9yeVBhdGgpO1xuICAgIHJldHVybiBjbG9jaztcbiAgfVxuXG4gIGFzeW5jIHZlcnNpb24oKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCB7dmVyc2lvbn0gPSBhd2FpdCB0aGlzLl9jb21tYW5kKCd2ZXJzaW9uJyk7XG4gICAgcmV0dXJuIHZlcnNpb247XG4gIH1cblxuICBfc3Vic2NyaWJlKFxuICAgICAgICB3YXRjaFJvb3Q6IHN0cmluZyxcbiAgICAgICAgc3Vic2NyaXB0aW9uTmFtZTogP3N0cmluZyxcbiAgICAgICAgb3B0aW9uczogV2F0Y2htYW5TdWJzY3JpcHRpb25PcHRpb25zXG4gICAgICApOiBQcm9taXNlPFdhdGNobWFuU3Vic2NyaXB0aW9uPiB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbW1hbmQoJ3N1YnNjcmliZScsIHdhdGNoUm9vdCwgc3Vic2NyaXB0aW9uTmFtZSwgb3B0aW9ucyk7XG4gIH1cblxuICAvKlxuICAgKiBQcm9taXNpZnkgY2FsbHMgdG8gd2F0Y2htYW4gY2xpZW50LlxuICAgKi9cbiAgX2NvbW1hbmQoLi4uYXJnczogQXJyYXk8YW55Pik6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuX2NsaWVudFByb21pc2UudGhlbihjbGllbnQgPT4ge1xuICAgICAgICBjbGllbnQuY29tbWFuZChhcmdzLCAoZXJyb3IsIHJlc3BvbnNlKSA9PlxuICAgICAgICAgICAgZXJyb3IgPyByZWplY3QoZXJyb3IpIDogcmVzb2x2ZShyZXNwb25zZSkpO1xuICAgICAgfSkuY2F0Y2gocmVqZWN0KTtcbiAgICB9KTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFdhdGNobWFuQ2xpZW50O1xuIl19
