Object.defineProperty(exports, '__esModule', {
  value: true
});

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _slicedToArray = (function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i['return']) _i['return'](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError('Invalid attempt to destructure non-iterable instance'); } }; })();

exports.watchFile = watchFile;
exports.watchDirectory = watchDirectory;

var getRealPath = _asyncToGenerator(function* (entityPath) {
  var exists = yield _nuclideCommons.fsPromise.exists(entityPath);
  if (!exists) {
    // Atom watcher behavior compatability.
    throw new Error('Can\'t watch a non-existing entity: ' + entityPath);
  }
  return yield _nuclideCommons.fsPromise.realpath(entityPath);
});

var unwatchEntity = _asyncToGenerator(function* (watchedEntities, realPath) {
  var watchEntry = watchedEntities.get(realPath);
  if (watchEntry && --watchEntry.subscriptionCount === 0) {
    watchedEntities['delete'](realPath);
  }
});

exports.watchDirectoryRecursive = watchDirectoryRecursive;

var unwatchDirectoryRecursive = _asyncToGenerator(function* (directoryPath) {
  yield getWatchmanClient().unwatch(directoryPath);
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _rx = require('rx');

var _events = require('events');

var _nuclideCommons = require('nuclide-commons');

var _nuclideWatchmanHelpers = require('nuclide-watchman-helpers');

'use babel';

var watchedFiles = new Map();
var watchedDirectories = new Map();

var CHANGE_EVENT_NAME = 'change';
var DELETE_EVENT_NAME = 'delete';

var watchmanClient = null;
function getWatchmanClient() {
  if (watchmanClient == null) {
    watchmanClient = new _nuclideWatchmanHelpers.WatchmanClient();
  }
  return watchmanClient;
}

function watchFile(filePath) {
  return watchEntity(watchedFiles, filePath, [CHANGE_EVENT_NAME, DELETE_EVENT_NAME]);
}

function watchDirectory(directoryPath) {
  return watchEntity(watchedDirectories, directoryPath, [CHANGE_EVENT_NAME]);
}

function watchEntity(watchedEntities, entityPath, watchEvents) {
  return _rx.Observable.fromPromise(getRealPath(entityPath)).flatMap(function (realPath) {
    if (!watchedEntities.has(realPath)) {
      watchedEntities.set(realPath, {
        eventEmitter: new _events.EventEmitter(),
        subscriptionCount: 0
      });
    }
    var watchEntry = watchedEntities.get(realPath);
    watchEntry.subscriptionCount++;

    var eventEmitter = watchEntry.eventEmitter;

    var watcherObservable = _rx.Observable.merge(watchEvents.map(function (watchEvent) {
      return _rx.Observable.fromEvent(eventEmitter, watchEvent, function () {
        return { path: entityPath, type: watchEvent };
      });
    }));

    watcherObservable.subscribeOnCompleted(function () {
      unwatchEntity(watchedEntities, realPath);
    });

    return watcherObservable;
  });
}

function watchDirectoryRecursive(directoryPath) {
  var client = getWatchmanClient();
  if (client.hasSubscription(directoryPath)) {
    return _rx.Observable.of('EXISTING');
  }
  return _rx.Observable.fromPromise(client.watchDirectoryRecursive(directoryPath)).flatMap(function (watcher) {

    // Listen for watcher changes to route them to watched files and directories.
    watcher.on('change', function (entries) {
      onWatcherChange(watcher, entries);
    });

    return _rx.Observable.create(function (observer) {
      // Notify success watcher setup.
      observer.onNext('SUCCESS');

      return function () {
        return unwatchDirectoryRecursive(directoryPath);
      };
    });
  });
}

function onWatcherChange(subscription, entries) {
  var directoryChanges = new Map();
  for (var entry of entries) {
    var entryPath = _path2['default'].join(subscription.root, entry.name);
    if (watchedFiles.has(entryPath)) {
      var _watchedFiles$get = watchedFiles.get(entryPath);

      var _eventEmitter = _watchedFiles$get.eventEmitter;

      // TODO(most): handle `rename`, if needed.
      if (!entry.exists) {
        _eventEmitter.emit(DELETE_EVENT_NAME);
      } else {
        _eventEmitter.emit(CHANGE_EVENT_NAME);
      }
    }
    // A file watch event can also be considered a directry change
    // for the parent directory if a file was created or deleted.
    if (entry['new'] || !entry.exists) {
      var entryDirectoryPath = _path2['default'].dirname(entryPath);
      if (watchedDirectories.has(entryDirectoryPath)) {
        if (!directoryChanges.has(entryDirectoryPath)) {
          directoryChanges.set(entryDirectoryPath, []);
        }
        directoryChanges.get(entryDirectoryPath).push(entry);
      }
    }
  }

  for (var _ref3 of directoryChanges) {
    var _ref2 = _slicedToArray(_ref3, 2);

    var watchedDirectoryPath = _ref2[0];
    var changes = _ref2[1];

    var _watchedDirectories$get = watchedDirectories.get(watchedDirectoryPath);

    var _eventEmitter2 = _watchedDirectories$get.eventEmitter;

    _eventEmitter2.emit(CHANGE_EVENT_NAME, changes);
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWZpbGV3YXRjaGVyLWJhc2UvbGliL0ZpbGVXYXRjaGVyU2VydmljZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztJQXFGZSxXQUFXLHFCQUExQixXQUEyQixVQUFrQixFQUFtQjtBQUM5RCxNQUFNLE1BQU0sR0FBRyxNQUFNLGdCQW5FZixTQUFTLENBbUVnQixNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDbEQsTUFBSSxDQUFDLE1BQU0sRUFBRTs7QUFFWCxVQUFNLElBQUksS0FBSywwQ0FBdUMsVUFBVSxDQUFHLENBQUM7R0FDckU7QUFDRCxTQUFPLE1BQU0sZ0JBeEVQLFNBQVMsQ0F3RVEsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0NBQzdDOztJQUVjLGFBQWEscUJBQTVCLFdBQ0UsZUFBZ0QsRUFDaEQsUUFBZ0IsRUFDRDtBQUNmLE1BQU0sVUFBVSxHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDakQsTUFBSSxVQUFVLElBQUksRUFBRSxVQUFVLENBQUMsaUJBQWlCLEtBQUssQ0FBQyxFQUFFO0FBQ3RELG1CQUFlLFVBQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztHQUNsQztDQUNGOzs7O0lBMkRjLHlCQUF5QixxQkFBeEMsV0FBeUMsYUFBcUIsRUFBaUI7QUFDN0UsUUFBTSxpQkFBaUIsRUFBRSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztDQUNsRDs7Ozs7O29CQW5KZ0IsTUFBTTs7OztrQkFDRSxJQUFJOztzQkFDRixRQUFROzs4QkFDWCxpQkFBaUI7O3NDQUNaLDBCQUEwQjs7QUFwQnZELFdBQVcsQ0FBQzs7QUEyQlosSUFBTSxZQUE2QyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFDaEUsSUFBTSxrQkFBbUQs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RUFBRTs7O1FBQXBELG9CQUFvQjtRQUFFLE9BQU87O2tDQUNoQixrQkFBa0IsQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUM7O1FBQTVELGNBQVksMkJBQVosWUFBWTs7QUFDbkIsa0JBQVksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLENBQUM7R0FDL0M7Q0FDRiIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wcGZsNTJucHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1maWxld2F0Y2hlci1iYXNlL2xpYi9GaWxlV2F0Y2hlclNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7TnVjbGlkZVVyaX0gZnJvbSAnbnVjbGlkZS1yZW1vdGUtdXJpJztcbmltcG9ydCB0eXBlIFdhdGNobWFuU3Vic2NyaXB0aW9uIGZyb20gJ251Y2xpZGUtd2F0Y2htYW4taGVscGVycy9saWIvV2F0Y2htYW5TdWJzY3JpcHRpb24nO1xuaW1wb3J0IHR5cGUge0ZpbGVDaGFuZ2V9IGZyb20gJ251Y2xpZGUtd2F0Y2htYW4taGVscGVycy9saWIvV2F0Y2htYW5DbGllbnQnO1xuaW1wb3J0IHR5cGUge3dhdGNoZXIkV2F0Y2hSZXN1bHR9IGZyb20gJy4vdHlwZXMnO1xuXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncngnO1xuaW1wb3J0IHtFdmVudEVtaXR0ZXJ9IGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQge2ZzUHJvbWlzZX0gZnJvbSAnbnVjbGlkZS1jb21tb25zJztcbmltcG9ydCB7V2F0Y2htYW5DbGllbnR9IGZyb20gJ251Y2xpZGUtd2F0Y2htYW4taGVscGVycyc7XG5cbnR5cGUgd2F0Y2hlciRXYXRjaEVudHJ5ID0ge1xuICBldmVudEVtaXR0ZXI6IEV2ZW50RW1pdHRlcjtcbiAgc3Vic2NyaXB0aW9uQ291bnQ6IG51bWJlcjtcbn07XG5cbmNvbnN0IHdhdGNoZWRGaWxlczogTWFwPHN0cmluZywgd2F0Y2hlciRXYXRjaEVudHJ5PiA9IG5ldyBNYXAoKTtcbmNvbnN0IHdhdGNoZWREaXJlY3RvcmllczogTWFwPHN0cmluZywgd2F0Y2hlciRXYXRjaEVudHJ5PiA9IG5ldyBNYXAoKTtcblxuY29uc3QgQ0hBTkdFX0VWRU5UX05BTUUgPSAnY2hhbmdlJztcbmNvbnN0IERFTEVURV9FVkVOVF9OQU1FID0gJ2RlbGV0ZSc7XG5cbmxldCB3YXRjaG1hbkNsaWVudDogP1dhdGNobWFuQ2xpZW50ID0gbnVsbDtcbmZ1bmN0aW9uIGdldFdhdGNobWFuQ2xpZW50KCk6IFdhdGNobWFuQ2xpZW50IHtcbiAgaWYgKHdhdGNobWFuQ2xpZW50ID09IG51bGwpIHtcbiAgICB3YXRjaG1hbkNsaWVudCA9IG5ldyBXYXRjaG1hbkNsaWVudCgpO1xuICB9XG4gIHJldHVybiB3YXRjaG1hbkNsaWVudDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdhdGNoRmlsZShmaWxlUGF0aDogTnVjbGlkZVVyaSk6IE9ic2VydmFibGU8d2F0Y2hlciRXYXRjaFJlc3VsdD4ge1xuICByZXR1cm4gd2F0Y2hFbnRpdHkod2F0Y2hlZEZpbGVzLCBmaWxlUGF0aCwgW0NIQU5HRV9FVkVOVF9OQU1FLCBERUxFVEVfRVZFTlRfTkFNRV0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gd2F0Y2hEaXJlY3RvcnkoZGlyZWN0b3J5UGF0aDogTnVjbGlkZVVyaSk6IE9ic2VydmFibGU8d2F0Y2hlciRXYXRjaFJlc3VsdD4ge1xuICByZXR1cm4gd2F0Y2hFbnRpdHkod2F0Y2hlZERpcmVjdG9yaWVzLCBkaXJlY3RvcnlQYXRoLCBbQ0hBTkdFX0VWRU5UX05BTUVdKTtcbn1cblxuZnVuY3Rpb24gd2F0Y2hFbnRpdHkoXG4gIHdhdGNoZWRFbnRpdGllczogTWFwPHN0cmluZywgd2F0Y2hlciRXYXRjaEVudHJ5PixcbiAgZW50aXR5UGF0aDogc3RyaW5nLFxuICB3YXRjaEV2ZW50czogQXJyYXk8c3RyaW5nPixcbik6IE9ic2VydmFibGU8d2F0Y2hlciRXYXRjaFJlc3VsdD4ge1xuICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShcbiAgICBnZXRSZWFsUGF0aChlbnRpdHlQYXRoKVxuICApLmZsYXRNYXAocmVhbFBhdGggPT4ge1xuICAgIGlmICghd2F0Y2hlZEVudGl0aWVzLmhhcyhyZWFsUGF0aCkpIHtcbiAgICAgIHdhdGNoZWRFbnRpdGllcy5zZXQocmVhbFBhdGgsIHtcbiAgICAgICAgZXZlbnRFbWl0dGVyOiBuZXcgRXZlbnRFbWl0dGVyKCksXG4gICAgICAgIHN1YnNjcmlwdGlvbkNvdW50OiAwLFxuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IHdhdGNoRW50cnkgPSB3YXRjaGVkRW50aXRpZXMuZ2V0KHJlYWxQYXRoKTtcbiAgICB3YXRjaEVudHJ5LnN1YnNjcmlwdGlvbkNvdW50Kys7XG5cbiAgICBjb25zdCB7ZXZlbnRFbWl0dGVyfSA9IHdhdGNoRW50cnk7XG4gICAgY29uc3Qgd2F0Y2hlck9ic2VydmFibGUgPSBPYnNlcnZhYmxlLm1lcmdlKHdhdGNoRXZlbnRzLm1hcCh3YXRjaEV2ZW50ID0+XG4gICAgICBPYnNlcnZhYmxlLmZyb21FdmVudChcbiAgICAgICAgZXZlbnRFbWl0dGVyLFxuICAgICAgICB3YXRjaEV2ZW50LFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtwYXRoOiBlbnRpdHlQYXRoLCB0eXBlOiB3YXRjaEV2ZW50fTtcbiAgICAgICAgfSxcbiAgICAgIClcbiAgICApKTtcblxuICAgIHdhdGNoZXJPYnNlcnZhYmxlLnN1YnNjcmliZU9uQ29tcGxldGVkKCgpID0+IHtcbiAgICAgIHVud2F0Y2hFbnRpdHkod2F0Y2hlZEVudGl0aWVzLCByZWFsUGF0aCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gd2F0Y2hlck9ic2VydmFibGU7XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRSZWFsUGF0aChlbnRpdHlQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCBleGlzdHMgPSBhd2FpdCBmc1Byb21pc2UuZXhpc3RzKGVudGl0eVBhdGgpO1xuICBpZiAoIWV4aXN0cykge1xuICAgIC8vIEF0b20gd2F0Y2hlciBiZWhhdmlvciBjb21wYXRhYmlsaXR5LlxuICAgIHRocm93IG5ldyBFcnJvcihgQ2FuJ3Qgd2F0Y2ggYSBub24tZXhpc3RpbmcgZW50aXR5OiAke2VudGl0eVBhdGh9YCk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IGZzUHJvbWlzZS5yZWFscGF0aChlbnRpdHlQYXRoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdW53YXRjaEVudGl0eShcbiAgd2F0Y2hlZEVudGl0aWVzOiBNYXA8c3RyaW5nLCB3YXRjaGVyJFdhdGNoRW50cnk+LFxuICByZWFsUGF0aDogc3RyaW5nLFxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHdhdGNoRW50cnkgPSB3YXRjaGVkRW50aXRpZXMuZ2V0KHJlYWxQYXRoKTtcbiAgaWYgKHdhdGNoRW50cnkgJiYgLS13YXRjaEVudHJ5LnN1YnNjcmlwdGlvbkNvdW50ID09PSAwKSB7XG4gICAgd2F0Y2hlZEVudGl0aWVzLmRlbGV0ZShyZWFsUGF0aCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdhdGNoRGlyZWN0b3J5UmVjdXJzaXZlKFxuICBkaXJlY3RvcnlQYXRoOiBOdWNsaWRlVXJpXG4pOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICBjb25zdCBjbGllbnQgPSBnZXRXYXRjaG1hbkNsaWVudCgpO1xuICBpZiAoY2xpZW50Lmhhc1N1YnNjcmlwdGlvbihkaXJlY3RvcnlQYXRoKSkge1xuICAgIHJldHVybiBPYnNlcnZhYmxlLm9mKCdFWElTVElORycpO1xuICB9XG4gIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKFxuICAgIGNsaWVudC53YXRjaERpcmVjdG9yeVJlY3Vyc2l2ZShkaXJlY3RvcnlQYXRoKVxuICApLmZsYXRNYXAod2F0Y2hlciA9PiB7XG5cbiAgICAvLyBMaXN0ZW4gZm9yIHdhdGNoZXIgY2hhbmdlcyB0byByb3V0ZSB0aGVtIHRvIHdhdGNoZWQgZmlsZXMgYW5kIGRpcmVjdG9yaWVzLlxuICAgIHdhdGNoZXIub24oJ2NoYW5nZScsIGVudHJpZXMgPT4ge1xuICAgICAgb25XYXRjaGVyQ2hhbmdlKHdhdGNoZXIsIGVudHJpZXMpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKG9ic2VydmVyID0+IHtcbiAgICAgIC8vIE5vdGlmeSBzdWNjZXNzIHdhdGNoZXIgc2V0dXAuXG4gICAgICBvYnNlcnZlci5vbk5leHQoJ1NVQ0NFU1MnKTtcblxuICAgICAgcmV0dXJuICgpID0+IHVud2F0Y2hEaXJlY3RvcnlSZWN1cnNpdmUoZGlyZWN0b3J5UGF0aCk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBvbldhdGNoZXJDaGFuZ2Uoc3Vic2NyaXB0aW9uOiBXYXRjaG1hblN1YnNjcmlwdGlvbiwgZW50cmllczogQXJyYXk8RmlsZUNoYW5nZT4pOiB2b2lkIHtcbiAgY29uc3QgZGlyZWN0b3J5Q2hhbmdlcyA9IG5ldyBNYXAoKTtcbiAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7XG4gICAgY29uc3QgZW50cnlQYXRoID0gcGF0aC5qb2luKHN1YnNjcmlwdGlvbi5yb290LCBlbnRyeS5uYW1lKTtcbiAgICBpZiAod2F0Y2hlZEZpbGVzLmhhcyhlbnRyeVBhdGgpKSB7XG4gICAgICBjb25zdCB7ZXZlbnRFbWl0dGVyfSA9IHdhdGNoZWRGaWxlcy5nZXQoZW50cnlQYXRoKTtcbiAgICAgIC8vIFRPRE8obW9zdCk6IGhhbmRsZSBgcmVuYW1lYCwgaWYgbmVlZGVkLlxuICAgICAgaWYgKCFlbnRyeS5leGlzdHMpIHtcbiAgICAgICAgZXZlbnRFbWl0dGVyLmVtaXQoREVMRVRFX0VWRU5UX05BTUUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXZlbnRFbWl0dGVyLmVtaXQoQ0hBTkdFX0VWRU5UX05BTUUpO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBBIGZpbGUgd2F0Y2ggZXZlbnQgY2FuIGFsc28gYmUgY29uc2lkZXJlZCBhIGRpcmVjdHJ5IGNoYW5nZVxuICAgIC8vIGZvciB0aGUgcGFyZW50IGRpcmVjdG9yeSBpZiBhIGZpbGUgd2FzIGNyZWF0ZWQgb3IgZGVsZXRlZC5cbiAgICBpZiAoZW50cnkubmV3IHx8ICFlbnRyeS5leGlzdHMpIHtcbiAgICAgIGNvbnN0IGVudHJ5RGlyZWN0b3J5UGF0aCA9IHBhdGguZGlybmFtZShlbnRyeVBhdGgpO1xuICAgICAgaWYgKHdhdGNoZWREaXJlY3Rvcmllcy5oYXMoZW50cnlEaXJlY3RvcnlQYXRoKSkge1xuICAgICAgICBpZiAoIWRpcmVjdG9yeUNoYW5nZXMuaGFzKGVudHJ5RGlyZWN0b3J5UGF0aCkpIHtcbiAgICAgICAgICBkaXJlY3RvcnlDaGFuZ2VzLnNldChlbnRyeURpcmVjdG9yeVBhdGgsIFtdKTtcbiAgICAgICAgfVxuICAgICAgICBkaXJlY3RvcnlDaGFuZ2VzLmdldChlbnRyeURpcmVjdG9yeVBhdGgpLnB1c2goZW50cnkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgW3dhdGNoZWREaXJlY3RvcnlQYXRoLCBjaGFuZ2VzXSBvZiBkaXJlY3RvcnlDaGFuZ2VzKSB7XG4gICAgY29uc3Qge2V2ZW50RW1pdHRlcn0gPSB3YXRjaGVkRGlyZWN0b3JpZXMuZ2V0KHdhdGNoZWREaXJlY3RvcnlQYXRoKTtcbiAgICBldmVudEVtaXR0ZXIuZW1pdChDSEFOR0VfRVZFTlRfTkFNRSwgY2hhbmdlcyk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gdW53YXRjaERpcmVjdG9yeVJlY3Vyc2l2ZShkaXJlY3RvcnlQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgYXdhaXQgZ2V0V2F0Y2htYW5DbGllbnQoKS51bndhdGNoKGRpcmVjdG9yeVBhdGgpO1xufVxuIl19
