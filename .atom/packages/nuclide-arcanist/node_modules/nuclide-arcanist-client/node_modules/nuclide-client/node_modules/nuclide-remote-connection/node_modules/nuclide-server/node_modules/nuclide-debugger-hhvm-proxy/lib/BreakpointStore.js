Object.defineProperty(exports, '__esModule', {
  value: true
});

var _slicedToArray = (function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i['return']) _i['return'](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError('Invalid attempt to destructure non-iterable instance'); } }; })();

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _utils = require('./utils');

'use babel';

var PAUSE_ALL_EXCEPTION_NAME = '*';
var EXCEPTION_PAUSE_STATE_ALL = 'all';

var _require = require('./DbgpSocket');

var STATUS_STOPPED = _require.STATUS_STOPPED;
var STATUS_ERROR = _require.STATUS_ERROR;
var STATUS_END = _require.STATUS_END;

// Stores breakpoints and connections.
//
// Added breakpoints are given a unique id and are added to all available connections.
//
// Breakpoints may be added before any connections.
//
// Care is taken to ensure that operations are atomic in the face of async turns.
// Specifically, removing a breakpoint removes it from all connection's maps
// before returning.

var BreakpointStore = (function () {
  function BreakpointStore() {
    _classCallCheck(this, BreakpointStore);

    this._breakpointCount = 0;
    this._connections = new Map();
    this._breakpoints = new Map();
    this._pauseAllExceptionBreakpointId = null;
  }

  _createClass(BreakpointStore, [{
    key: 'setBreakpoint',
    value: function setBreakpoint(filename, lineNumber) {
      this._breakpointCount++;
      var storeId = String(this._breakpointCount);
      this._breakpoints.set(storeId, { storeId: storeId, filename: filename, lineNumber: lineNumber });
      for (var entry of this._connections.entries()) {
        var _entry = _slicedToArray(entry, 2);

        var connection = _entry[0];
        var map = _entry[1];

        map.set(storeId, connection.setBreakpoint(filename, lineNumber));
      }
      return storeId;
    }
  }, {
    key: 'removeBreakpoint',
    value: _asyncToGenerator(function* (breakpointId) {
      this._breakpoints['delete'](breakpointId);
      return yield this._removeBreakpointFromConnections(breakpointId);
    })

    /**
     * TODO[jeffreytan]: look into unhandled exception support.
     * Dbgp protocol does not seem to support uncaught exception handling
     * so we only support 'all' and treat all other states as 'none'.
     */
  }, {
    key: 'setPauseOnExceptions',
    value: _asyncToGenerator(function* (state) {
      if (state === EXCEPTION_PAUSE_STATE_ALL) {
        this._breakpointCount++;
        var breakpiontId = String(this._breakpointCount);
        this._pauseAllExceptionBreakpointId = breakpiontId;

        for (var entry of this._connections.entries()) {
          var _entry2 = _slicedToArray(entry, 2);

          var connection = _entry2[0];
          var map = _entry2[1];

          map.set(breakpiontId, connection.setExceptionBreakpoint(PAUSE_ALL_EXCEPTION_NAME));
        }
      } else {
        // Try to remove any existing exception breakpoint.
        yield this._removePauseAllExceptionBreakpointIfNeeded();
      }
    })
  }, {
    key: '_removePauseAllExceptionBreakpointIfNeeded',
    value: _asyncToGenerator(function* () {
      if (this._pauseAllExceptionBreakpointId !== null) {
        var breakpointId = this._pauseAllExceptionBreakpointId;
        this._pauseAllExceptionBreakpointId = null;
        return yield this._removeBreakpointFromConnections(breakpointId);
      } else {
        // This can happen if users switch between 'none' and 'uncaught' states.
        (0, _utils.log)('No exception breakpoint to remove.');
        return Promise.resolve();
      }
    })
  }, {
    key: '_removeBreakpointFromConnections',
    value: _asyncToGenerator(function* (breakpointId) {
      return Promise.all(require('nuclide-commons').array.from(this._connections.entries()).map(function (entry) {
        var _entry3 = _slicedToArray(entry, 2);

        var connection = _entry3[0];
        var map = _entry3[1];

        if (map.has(breakpointId)) {
          var _ret = (function () {
            var connectionIdPromise = map.get(breakpointId);
            map['delete'](breakpointId);
            // Ensure we've removed from the connection's map before awaiting.
            return {
              v: _asyncToGenerator(function* () {
                return connection.removeBreakpoint((yield connectionIdPromise));
              })()
            };
          })();

          if (typeof _ret === 'object') return _ret.v;
        } else {
          return Promise.resolve();
        }
      }));
    })
  }, {
    key: 'addConnection',
    value: function addConnection(connection) {
      var _this = this;

      var map = new Map();
      this._breakpoints.forEach(function (breakpoint) {
        map.set(breakpoint.storeId, connection.setBreakpoint(breakpoint.filename, breakpoint.lineNumber));
      });
      if (this._pauseAllExceptionBreakpointId) {
        map.set(this._pauseAllExceptionBreakpointId, connection.setExceptionBreakpoint(PAUSE_ALL_EXCEPTION_NAME));
      }

      this._connections.set(connection, map);
      connection.onStatus(function (status) {
        switch (status) {
          case STATUS_STOPPED:
          case STATUS_ERROR:
          case STATUS_END:
            _this._removeConnection(connection);
        }
      });
    }
  }, {
    key: '_removeConnection',
    value: function _removeConnection(connection) {
      if (this._connections.has(connection)) {
        this._connections['delete'](connection);
      }
    }
  }]);

  return BreakpointStore;
})();

exports.BreakpointStore = BreakpointStore;

// For each connection a map from the Store's Breakpoint Id to the
// Promise of the Connection's Breakpoint Id.
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL0JyZWFrcG9pbnRTdG9yZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztxQkFVa0IsU0FBUzs7QUFWM0IsV0FBVyxDQUFDOztBQXFCWixJQUFNLHdCQUF3QixHQUFHLEdBQUcsQ0FBQztBQUNyQyxJQUFNLHlCQUF5QixHQUFHLEtBQUssQ0FBQzs7ZUFNcEMsT0FBTyxDQUFDLGNBQWMsQ0FBQzs7SUFIekIsY0FBYyxZQUFkLGNBQWM7SUFDZCxZQUFZLFlBQVosWUFBWTtJQUNaLFVBQVUsWUFBVixVQUFVOzs7Ozs7Ozs7Ozs7SUFZQyxlQUFlO0FBUWYsV0FSQSxlQUFlLEdBUVo7MEJBUkgsZUFBZTs7QUFTeEIsUUFBSSxDQUFDLGdCQUFnQixHQUFHLENBQUMsQ0FBQztBQUMxQixRQUFJLENBQUMsWUFBWSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFDOUIsUUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQzlCLFFBQUksQ0FBQyw4QkFBOEIsR0FBRyxJQUFJLENBQUM7R0FDNUM7O2VBYlUsZUFBZTs7V0FlYix1QkFBQyxRQUFnQixFQUFFLFVBQWtCLEVBQWdCO0FBQ2hFLFVBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0FBQ3hCLFVBQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUM5QyxVQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsRUFBQyxPQUFPLEVBQVAsT0FBTyxFQUFFLFFBQVEsRUFBUixRQUFRLEVBQUUsVUFBVSxFQUFWLFVBQVUsRUFBQyxDQUFDLENBQUM7QUFDaEUsV0FBSyxJQUFNLEtBQUssSUFBSSxJQUFJ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QUFDSCxVQUFJLElBQUksQ0FBQyw4QkFBOEIsRUFBRTtBQUN2QyxXQUFHLENBQUMsR0FBRyxDQUNMLElBQUksQ0FBQyw4QkFBOEIsRUFDbkMsVUFBVSxDQUFDLHNCQUFzQixDQUFDLHdCQUF3QixDQUFDLENBQzVELENBQUM7T0FDSDs7QUFFRCxVQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDdkMsZ0JBQVUsQ0FBQyxRQUFRLENBQUMsVUFBQSxNQUFNLEVBQUk7QUFDNUIsZ0JBQVEsTUFBTTtBQUNaLGVBQUssY0FBYyxDQUFDO0FBQ3BCLGVBQUssWUFBWSxDQUFDO0FBQ2xCLGVBQUssVUFBVTtBQUNiLGtCQUFLLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQUEsU0FDdEM7T0FDRixDQUFDLENBQUM7S0FDSjs7O1dBRWdCLDJCQUFDLFVBQXNCLEVBQVE7QUFDOUMsVUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBRTtBQUNyQyxZQUFJLENBQUMsWUFBWSxVQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7T0FDdEM7S0FDRjs7O1NBaEhVLGVBQWUiLCJmaWxlIjoiL3Zhci9mb2xkZXJzL3hmL3JzcGg0X2M1NzMxNXJzNTd4eHNkc2tyeG52MzZ0MC9UL3RtcHBmbDUybnB1Ymxpc2hfcGFja2FnZXMvbnBtL251Y2xpZGUtZGVidWdnZXItaGh2bS1wcm94eS9saWIvQnJlYWtwb2ludFN0b3JlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cbmltcG9ydCB7bG9nfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB0eXBlIHtDb25uZWN0aW9ufSBmcm9tICcuL0Nvbm5lY3Rpb24nO1xuXG50eXBlIEJyZWFrcG9pbnRJZCA9IHN0cmluZztcbnR5cGUgQnJlYWtwb2ludCA9IHtcbiAgc3RvcmVJZDogQnJlYWtwb2ludElkO1xuICBmaWxlbmFtZTogc3RyaW5nO1xuICBsaW5lTnVtYmVyOiBudW1iZXI7XG59O1xudHlwZSBFeGNlcHRpb25TdGF0ZSA9ICdub25lJyB8ICd1bmNhdWdodCcgfCAnYWxsJztcblxuY29uc3QgUEFVU0VfQUxMX0VYQ0VQVElPTl9OQU1FID0gJyonO1xuY29uc3QgRVhDRVBUSU9OX1BBVVNFX1NUQVRFX0FMTCA9ICdhbGwnO1xuXG5jb25zdCB7XG4gIFNUQVRVU19TVE9QUEVELFxuICBTVEFUVVNfRVJST1IsXG4gIFNUQVRVU19FTkQsXG59ID0gcmVxdWlyZSgnLi9EYmdwU29ja2V0Jyk7XG5cbi8vIFN0b3JlcyBicmVha3BvaW50cyBhbmQgY29ubmVjdGlvbnMuXG4vL1xuLy8gQWRkZWQgYnJlYWtwb2ludHMgYXJlIGdpdmVuIGEgdW5pcXVlIGlkIGFuZCBhcmUgYWRkZWQgdG8gYWxsIGF2YWlsYWJsZSBjb25uZWN0aW9ucy5cbi8vXG4vLyBCcmVha3BvaW50cyBtYXkgYmUgYWRkZWQgYmVmb3JlIGFueSBjb25uZWN0aW9ucy5cbi8vXG4vLyBDYXJlIGlzIHRha2VuIHRvIGVuc3VyZSB0aGF0IG9wZXJhdGlvbnMgYXJlIGF0b21pYyBpbiB0aGUgZmFjZSBvZiBhc3luYyB0dXJucy5cbi8vIFNwZWNpZmljYWxseSwgcmVtb3ZpbmcgYSBicmVha3BvaW50IHJlbW92ZXMgaXQgZnJvbSBhbGwgY29ubmVjdGlvbidzIG1hcHNcbi8vIGJlZm9yZSByZXR1cm5pbmcuXG5leHBvcnQgY2xhc3MgQnJlYWtwb2ludFN0b3JlIHtcbiAgX2JyZWFrcG9pbnRDb3VudDogbnVtYmVyO1xuICAvLyBGb3IgZWFjaCBjb25uZWN0aW9uIGEgbWFwIGZyb20gdGhlIFN0b3JlJ3MgQnJlYWtwb2ludCBJZCB0byB0aGVcbiAgLy8gUHJvbWlzZSBvZiB0aGUgQ29ubmVjdGlvbidzIEJyZWFrcG9pbnQgSWQuXG4gIF9jb25uZWN0aW9uczogTWFwPENvbm5lY3Rpb24sIE1hcDxCcmVha3BvaW50SWQsIFByb21pc2U8QnJlYWtwb2ludElkPj4+O1xuICBfYnJlYWtwb2ludHM6IE1hcDxCcmVha3BvaW50SWQsIEJyZWFrcG9pbnQ+O1xuICBfcGF1c2VBbGxFeGNlcHRpb25CcmVha3BvaW50SWQ6ID9CcmVha3BvaW50SWQ7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5fYnJlYWtwb2ludENvdW50ID0gMDtcbiAgICB0aGlzLl9jb25uZWN0aW9ucyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLl9icmVha3BvaW50cyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLl9wYXVzZUFsbEV4Y2VwdGlvbkJyZWFrcG9pbnRJZCA9IG51bGw7XG4gIH1cblxuICBzZXRCcmVha3BvaW50KGZpbGVuYW1lOiBzdHJpbmcsIGxpbmVOdW1iZXI6IG51bWJlcik6IEJyZWFrcG9pbnRJZCB7XG4gICAgdGhpcy5fYnJlYWtwb2ludENvdW50Kys7XG4gICAgY29uc3Qgc3RvcmVJZCA9IFN0cmluZyh0aGlzLl9icmVha3BvaW50Q291bnQpO1xuICAgIHRoaXMuX2JyZWFrcG9pbnRzLnNldChzdG9yZUlkLCB7c3RvcmVJZCwgZmlsZW5hbWUsIGxpbmVOdW1iZXJ9KTtcbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIHRoaXMuX2Nvbm5lY3Rpb25zLmVudHJpZXMoKSkge1xuICAgICAgY29uc3QgW2Nvbm5lY3Rpb24sIG1hcF0gPSBlbnRyeTtcbiAgICAgIG1hcC5zZXQoc3RvcmVJZCwgY29ubmVjdGlvbi5zZXRCcmVha3BvaW50KGZpbGVuYW1lLCBsaW5lTnVtYmVyKSk7XG4gICAgfVxuICAgIHJldHVybiBzdG9yZUlkO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlQnJlYWtwb2ludChicmVha3BvaW50SWQ6IHN0cmluZyk6IFByb21pc2Uge1xuICAgIHRoaXMuX2JyZWFrcG9pbnRzLmRlbGV0ZShicmVha3BvaW50SWQpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLl9yZW1vdmVCcmVha3BvaW50RnJvbUNvbm5lY3Rpb25zKGJyZWFrcG9pbnRJZCk7XG4gIH1cblxuICAvKipcbiAgICogVE9ET1tqZWZmcmV5dGFuXTogbG9vayBpbnRvIHVuaGFuZGxlZCBleGNlcHRpb24gc3VwcG9ydC5cbiAgICogRGJncCBwcm90b2NvbCBkb2VzIG5vdCBzZWVtIHRvIHN1cHBvcnQgdW5jYXVnaHQgZXhjZXB0aW9uIGhhbmRsaW5nXG4gICAqIHNvIHdlIG9ubHkgc3VwcG9ydCAnYWxsJyBhbmQgdHJlYXQgYWxsIG90aGVyIHN0YXRlcyBhcyAnbm9uZScuXG4gICAqL1xuICBhc3luYyBzZXRQYXVzZU9uRXhjZXB0aW9ucyhzdGF0ZTogRXhjZXB0aW9uU3RhdGUpOiBQcm9taXNlIHtcbiAgICBpZiAoc3RhdGUgPT09IEVYQ0VQVElPTl9QQVVTRV9TVEFURV9BTEwpIHtcbiAgICAgIHRoaXMuX2JyZWFrcG9pbnRDb3VudCsrO1xuICAgICAgY29uc3QgYnJlYWtwaW9udElkID0gU3RyaW5nKHRoaXMuX2JyZWFrcG9pbnRDb3VudCk7XG4gICAgICB0aGlzLl9wYXVzZUFsbEV4Y2VwdGlvbkJyZWFrcG9pbnRJZCA9IGJyZWFrcGlvbnRJZDtcblxuICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiB0aGlzLl9jb25uZWN0aW9ucy5lbnRyaWVzKCkpIHtcbiAgICAgICAgY29uc3QgW2Nvbm5lY3Rpb24sIG1hcF0gPSBlbnRyeTtcbiAgICAgICAgbWFwLnNldChcbiAgICAgICAgICBicmVha3Bpb250SWQsXG4gICAgICAgICAgY29ubmVjdGlvbi5zZXRFeGNlcHRpb25CcmVha3BvaW50KFBBVVNFX0FMTF9FWENFUFRJT05fTkFNRSlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVHJ5IHRvIHJlbW92ZSBhbnkgZXhpc3RpbmcgZXhjZXB0aW9uIGJyZWFrcG9pbnQuXG4gICAgICBhd2FpdCB0aGlzLl9yZW1vdmVQYXVzZUFsbEV4Y2VwdGlvbkJyZWFrcG9pbnRJZk5lZWRlZCgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIF9yZW1vdmVQYXVzZUFsbEV4Y2VwdGlvbkJyZWFrcG9pbnRJZk5lZWRlZCgpOiBQcm9taXNlIHtcbiAgICBpZiAodGhpcy5fcGF1c2VBbGxFeGNlcHRpb25CcmVha3BvaW50SWQgIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGJyZWFrcG9pbnRJZCA9IHRoaXMuX3BhdXNlQWxsRXhjZXB0aW9uQnJlYWtwb2ludElkO1xuICAgICAgdGhpcy5fcGF1c2VBbGxFeGNlcHRpb25CcmVha3BvaW50SWQgPSBudWxsO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3JlbW92ZUJyZWFrcG9pbnRGcm9tQ29ubmVjdGlvbnMoYnJlYWtwb2ludElkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVGhpcyBjYW4gaGFwcGVuIGlmIHVzZXJzIHN3aXRjaCBiZXR3ZWVuICdub25lJyBhbmQgJ3VuY2F1Z2h0JyBzdGF0ZXMuXG4gICAgICBsb2coJ05vIGV4Y2VwdGlvbiBicmVha3BvaW50IHRvIHJlbW92ZS4nKTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBfcmVtb3ZlQnJlYWtwb2ludEZyb21Db25uZWN0aW9ucyhicmVha3BvaW50SWQ6IHN0cmluZyk6IFByb21pc2Uge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChyZXF1aXJlKCdudWNsaWRlLWNvbW1vbnMnKS5hcnJheS5mcm9tKHRoaXMuX2Nvbm5lY3Rpb25zLmVudHJpZXMoKSlcbiAgICAgIC5tYXAoZW50cnkgPT4ge1xuICAgICAgICBjb25zdCBbY29ubmVjdGlvbiwgbWFwXSA9IGVudHJ5O1xuICAgICAgICBpZiAobWFwLmhhcyhicmVha3BvaW50SWQpKSB7XG4gICAgICAgICAgY29uc3QgY29ubmVjdGlvbklkUHJvbWlzZSA9IG1hcC5nZXQoYnJlYWtwb2ludElkKTtcbiAgICAgICAgICBtYXAuZGVsZXRlKGJyZWFrcG9pbnRJZCk7XG4gICAgICAgICAgLy8gRW5zdXJlIHdlJ3ZlIHJlbW92ZWQgZnJvbSB0aGUgY29ubmVjdGlvbidzIG1hcCBiZWZvcmUgYXdhaXRpbmcuXG4gICAgICAgICAgcmV0dXJuIChhc3luYyAoKSA9PiBjb25uZWN0aW9uLnJlbW92ZUJyZWFrcG9pbnQoYXdhaXQgY29ubmVjdGlvbklkUHJvbWlzZSkpKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgICB9KSk7XG4gIH1cblxuICBhZGRDb25uZWN0aW9uKGNvbm5lY3Rpb246IENvbm5lY3Rpb24pOiB2b2lkIHtcbiAgICBjb25zdCBtYXAgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5fYnJlYWtwb2ludHMuZm9yRWFjaChicmVha3BvaW50ID0+IHtcbiAgICAgIG1hcC5zZXQoXG4gICAgICAgIGJyZWFrcG9pbnQuc3RvcmVJZCxcbiAgICAgICAgY29ubmVjdGlvbi5zZXRCcmVha3BvaW50KGJyZWFrcG9pbnQuZmlsZW5hbWUsIGJyZWFrcG9pbnQubGluZU51bWJlcilcbiAgICAgICk7XG4gICAgfSk7XG4gICAgaWYgKHRoaXMuX3BhdXNlQWxsRXhjZXB0aW9uQnJlYWtwb2ludElkKSB7XG4gICAgICBtYXAuc2V0KFxuICAgICAgICB0aGlzLl9wYXVzZUFsbEV4Y2VwdGlvbkJyZWFrcG9pbnRJZCxcbiAgICAgICAgY29ubmVjdGlvbi5zZXRFeGNlcHRpb25CcmVha3BvaW50KFBBVVNFX0FMTF9FWENFUFRJT05fTkFNRSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5fY29ubmVjdGlvbnMuc2V0KGNvbm5lY3Rpb24sIG1hcCk7XG4gICAgY29ubmVjdGlvbi5vblN0YXR1cyhzdGF0dXMgPT4ge1xuICAgICAgc3dpdGNoIChzdGF0dXMpIHtcbiAgICAgICAgY2FzZSBTVEFUVVNfU1RPUFBFRDpcbiAgICAgICAgY2FzZSBTVEFUVVNfRVJST1I6XG4gICAgICAgIGNhc2UgU1RBVFVTX0VORDpcbiAgICAgICAgICB0aGlzLl9yZW1vdmVDb25uZWN0aW9uKGNvbm5lY3Rpb24pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgX3JlbW92ZUNvbm5lY3Rpb24oY29ubmVjdGlvbjogQ29ubmVjdGlvbik6IHZvaWQge1xuICAgIGlmICh0aGlzLl9jb25uZWN0aW9ucy5oYXMoY29ubmVjdGlvbikpIHtcbiAgICAgIHRoaXMuX2Nvbm5lY3Rpb25zLmRlbGV0ZShjb25uZWN0aW9uKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==
