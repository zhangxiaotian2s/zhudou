Object.defineProperty(exports, '__esModule', {
  value: true
});

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _path = require('path');

'use babel';

var NON_UPPERCASE_CHARS_REGEXP = /[^a-z0-9]/g;
/**
 * Returns the score of the common subsequence between `needle` and `haystack` or -1 if there is
 * no common subsequence.
 * A lower number means `needle` is more relevant to `haystack`.
 */
function scoreCommonSubsequence(needle, haystack) {
  haystack = haystack.toLowerCase();
  haystack = haystack.replace(NON_UPPERCASE_CHARS_REGEXP, '');
  if (needle.length === haystack.length) {
    return needle === haystack ? 0 : -1;
  }

  var needleIndex = 0;
  var haystackIndex = 0;
  var score = 0;
  var inGap = false;

  while (needleIndex < needle.length && haystackIndex < haystack.length) {
    if (needle[needleIndex] === haystack[haystackIndex]) {
      needleIndex++;
      haystackIndex++;
      inGap = false;
    } else {
      haystackIndex++;
      score += inGap ? 2 : 20;
      inGap = true;
    }
  }
  if (needleIndex >= needle.length) {
    return score + haystack.length + haystackIndex;
  }
  return -1;
}

var NOT_CAPITAL_LETTERS_REGEXP = /[^A-Z]/g;
/**
 * Checks if `needle` matches exactly the first character followed by all uppercase letters in
 * `haystack`.  E.g. 'fbide' matches 'FaceBookIntegratedDevelopmentEnvironment' and
 *                                   'faceBookIntegratedDevelopmentEnvironment'.
 */
function checkIfMatchesCamelCaseLetters(needle, haystack) {
  var uppercase = haystack.substring(0, 1) + haystack.substring(1).replace(NOT_CAPITAL_LETTERS_REGEXP, '');
  return needle.toLowerCase() === uppercase.toLowerCase();
}

var CAPITAL_LETTERS_REGEXP = /[A-Z]/;
var IMPORTANT_DELIMITERS_REGEXP = /[_\-.]/;
function isLetterImportant(index, name) {
  if (index <= 1) {
    return true;
  }
  if (CAPITAL_LETTERS_REGEXP.test(name[index])) {
    return true;
  }
  var previousCharacter = name[index - 1];
  if (IMPORTANT_DELIMITERS_REGEXP.test(previousCharacter)) {
    return true;
  }
  return false;
}
/**
 * FBIDE indexes each filepath by important characters it contains.
 * This is a temporary workaround that allow calculating important characters on the fly rather
 * than relying on the index. Once the index is implemented, consumers of this need to be updated.
 */
// TODO(jxg): replace with "important characters" index.
function importantCharactersForString(str) {
  var importantCharacters = new Set();
  for (var index = 0; index < str.length; index++) {
    var char = str[index];
    if (!importantCharacters.has(char) && isLetterImportant(index, str)) {
      importantCharacters.add(char);
    }
  }
  return importantCharacters;
}

var __test__ = {
  checkIfMatchesCamelCaseLetters: checkIfMatchesCamelCaseLetters,
  isLetterImportant: isLetterImportant,
  importantCharactersForString: importantCharactersForString,
  scoreCommonSubsequence: scoreCommonSubsequence
};

exports.__test__ = __test__;

var QueryItem = (function () {
  function QueryItem(filepath) {
    _classCallCheck(this, QueryItem);

    this._filepath = filepath;
    this._filepathLowercase = filepath.toLowerCase();
    this._filename = (0, _path.basename)(this._filepathLowercase);
    this._importantCharacters = importantCharactersForString(this._filename);
  }

  /**
   * Scores this object's string against the query given.
   *
   * To search:
   * a.) Cut the first letter off the query
   * b.) Lookup the list of terms which contain that letter (we indexed it earlier)
   * c.) Compare our query against each term in that list
   * d.) If our query is a common subsequence of one of the terms, add it to the results list
   * e.) While we compare our query, we keep track of a score:
   *     i.) The more gaps there are between matching characters, the higher the score
   *     ii.) The more letters which are the incorrect case, the higher the score
   *     iii.) Direct matches have a score of 0.
   *     iv.) The later we find out that we've matched, the higher the score
   *     v.) Longer terms have higher scores
   *     - The more your query is spreads out across the result,
   *       the less likely it is what you're looking for.
   *     - The shorter the result, the closer the length is to what you searched for,
   *       so it's more likely.
   *     - The earlier we find the match, the more likely it is to be what you're looking for.
   *     - The more cases of the characters that match, the more likely it is to be what you want.
   * f.) Sort the results by the score
   */

  _createClass(QueryItem, [{
    key: 'score',
    value: function score(query) {
      var score = this._getScoreFor(query);
      return score == null ? null : { score: score, value: this._filepath, matchIndexes: [] };
    }
  }, {
    key: '_getScoreFor',
    value: function _getScoreFor(query) {
      // Purely defensive, as query is guaranteed to be non-empty.
      if (query.length === 0) {
        return null;
      }
      // Check if this a "possible result".
      // TODO consider building a directory-level index from important_character -> QueryItem,
      // akin to FBIDE's implementation.
      var firstChar = query[0].toLowerCase();
      if (!this._importantCharacters.has(firstChar)) {
        return null;
      }
      if (query.length >= 3 && checkIfMatchesCamelCaseLetters(query, this._filename)) {
        // If we match the uppercase characters of the filename, we should be ranked the highest
        return 0;
      } else {
        var sub = this._filepathLowercase.indexOf(query.toLowerCase());
        if (sub !== -1 && query.length < this._filename.length) {
          /**
           * We add the length of the term so we can be ranked alongside the
           * scores generated by `scoreCommonSubsequence` which also factors in the
           * length.
           * This way when you search for `EdisonController`,
           * EdisonController scores 0
           * EdixxsonController scores 40 (from `scoreCommonSubsequence` scoring)
           * SomethingBlahBlahEdisonController scores 50 from substring scoring
           * WebDecisionController scores 52 (from `scoreCommonSubsequence` scoring)
           */
          return sub + this._filename.length;
        } else {
          // TODO(jxg): Investigate extending scoreCommonSubsequence to consider subsequences
          // bidirectionally, or use (some proxy for) edit distance.
          var score = scoreCommonSubsequence(query, this._filename);
          if (score !== -1) {
            return score;
          }
        }
      }
      return null;
    }
  }]);

  return QueryItem;
})();

exports['default'] = QueryItem;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXBhdGgtc2VhcmNoL2xpYi9RdWVyeUl0ZW0uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztvQkFXdUIsTUFBTTs7QUFYN0IsV0FBVyxDQUFDOztBQWVaLElBQU0sMEJBQTBCLEdBQUcsWUFBWSxDQUFDOzs7Ozs7QUFNaEQsU0FBUyxzQkFBc0IsQ0FBQyxNQUFjLEVBQUUsUUFBZ0IsRUFBVTtBQUN4RSxVQUFRLEdBQUcsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQ2xDLFVBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLDBCQUEwQixFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQzVELE1BQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxRQUFRLENBQUMsTUFBTSxFQUFFO0FBQ3JDLFdBQU8sTUFBTSxLQUFLLFFBQVEsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7R0FDckM7O0FBRUQsTUFBSSxXQUFtQixHQUFHLENBQUMsQ0FBQztBQUM1QixNQUFJLGFBQXFCLEdBQUcsQ0FBQyxDQUFDO0FBQzlCLE1BQUksS0FBYSxHQUFHLENBQUMsQ0FBQztBQUN0QixNQUFJLEtBQWMsR0FBRyxLQUFLLENBQUM7O0FBRTNCLFNBQU8sV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLElBQUksYUFBYSxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUU7QUFDckUsUUFBSSxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssUUFBUSxDQUFDLGFBQWEsQ0FBQyxFQUFFO0FBQ25ELGlCQUFXLEVBQUUsQ0FBQztBQUNkLG1CQUFhLEVBQUUsQ0FBQztBQUNoQixXQUFLLEdBQUcsS0FBSyxDQUFDO0tBQ2YsTUFBTTtBQUNMLG1CQUFhLEVBQUUsQ0FBQztBQUNoQixXQUFLLElBQUssS0FBSyxHQUFHLENBQUMs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O1NBL0VrQixTQUFTOzs7cUJBQVQsU0FBUyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wcGZsNTJucHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1wYXRoLXNlYXJjaC9saWIvUXVlcnlJdGVtLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuaW1wb3J0IHtiYXNlbmFtZX0gZnJvbSAncGF0aCc7XG5cbmltcG9ydCB0eXBlIHtRdWVyeVNjb3JlfSBmcm9tICcuL1F1ZXJ5U2NvcmUnO1xuXG5jb25zdCBOT05fVVBQRVJDQVNFX0NIQVJTX1JFR0VYUCA9IC9bXmEtejAtOV0vZztcbi8qKlxuICogUmV0dXJucyB0aGUgc2NvcmUgb2YgdGhlIGNvbW1vbiBzdWJzZXF1ZW5jZSBiZXR3ZWVuIGBuZWVkbGVgIGFuZCBgaGF5c3RhY2tgIG9yIC0xIGlmIHRoZXJlIGlzXG4gKiBubyBjb21tb24gc3Vic2VxdWVuY2UuXG4gKiBBIGxvd2VyIG51bWJlciBtZWFucyBgbmVlZGxlYCBpcyBtb3JlIHJlbGV2YW50IHRvIGBoYXlzdGFja2AuXG4gKi9cbmZ1bmN0aW9uIHNjb3JlQ29tbW9uU3Vic2VxdWVuY2UobmVlZGxlOiBzdHJpbmcsIGhheXN0YWNrOiBzdHJpbmcpOiBudW1iZXIge1xuICBoYXlzdGFjayA9IGhheXN0YWNrLnRvTG93ZXJDYXNlKCk7XG4gIGhheXN0YWNrID0gaGF5c3RhY2sucmVwbGFjZShOT05fVVBQRVJDQVNFX0NIQVJTX1JFR0VYUCwgJycpO1xuICBpZiAobmVlZGxlLmxlbmd0aCA9PT0gaGF5c3RhY2subGVuZ3RoKSB7XG4gICAgcmV0dXJuIG5lZWRsZSA9PT0gaGF5c3RhY2sgPyAwIDogLTE7XG4gIH1cblxuICBsZXQgbmVlZGxlSW5kZXg6IG51bWJlciA9IDA7XG4gIGxldCBoYXlzdGFja0luZGV4OiBudW1iZXIgPSAwO1xuICBsZXQgc2NvcmU6IG51bWJlciA9IDA7XG4gIGxldCBpbkdhcDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIHdoaWxlIChuZWVkbGVJbmRleCA8IG5lZWRsZS5sZW5ndGggJiYgaGF5c3RhY2tJbmRleCA8IGhheXN0YWNrLmxlbmd0aCkge1xuICAgIGlmIChuZWVkbGVbbmVlZGxlSW5kZXhdID09PSBoYXlzdGFja1toYXlzdGFja0luZGV4XSkge1xuICAgICAgbmVlZGxlSW5kZXgrKztcbiAgICAgIGhheXN0YWNrSW5kZXgrKztcbiAgICAgIGluR2FwID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIGhheXN0YWNrSW5kZXgrKztcbiAgICAgIHNjb3JlICs9IChpbkdhcCA/IDIgOiAyMCk7XG4gICAgICBpbkdhcCA9IHRydWU7XG4gICAgfVxuICB9XG4gIGlmIChuZWVkbGVJbmRleCA+PSBuZWVkbGUubGVuZ3RoKSB7XG4gICAgcmV0dXJuIHNjb3JlICsgaGF5c3RhY2subGVuZ3RoICsgaGF5c3RhY2tJbmRleDtcbiAgfVxuICByZXR1cm4gLTE7XG59XG5cbmNvbnN0IE5PVF9DQVBJVEFMX0xFVFRFUlNfUkVHRVhQID0gL1teQS1aXS9nO1xuLyoqXG4gKiBDaGVja3MgaWYgYG5lZWRsZWAgbWF0Y2hlcyBleGFjdGx5IHRoZSBmaXJzdCBjaGFyYWN0ZXIgZm9sbG93ZWQgYnkgYWxsIHVwcGVyY2FzZSBsZXR0ZXJzIGluXG4gKiBgaGF5c3RhY2tgLiAgRS5nLiAnZmJpZGUnIG1hdGNoZXMgJ0ZhY2VCb29rSW50ZWdyYXRlZERldmVsb3BtZW50RW52aXJvbm1lbnQnIGFuZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmYWNlQm9va0ludGVncmF0ZWREZXZlbG9wbWVudEVudmlyb25tZW50Jy5cbiAqL1xuZnVuY3Rpb24gY2hlY2tJZk1hdGNoZXNDYW1lbENhc2VMZXR0ZXJzKG5lZWRsZTogc3RyaW5nLCBoYXlzdGFjazogc3RyaW5nKTogYm9vbGVhbiB7XG4gIGNvbnN0IHVwcGVyY2FzZSA9IGhheXN0YWNrLnN1YnN0cmluZygwLCAxKSArXG4gICAgaGF5c3RhY2suc3Vic3RyaW5nKDEpLnJlcGxhY2UoTk9UX0NBUElUQUxfTEVUVEVSU19SRUdFWFAsICcnKTtcbiAgcmV0dXJuIG5lZWRsZS50b0xvd2VyQ2FzZSgpID09PSB1cHBlcmNhc2UudG9Mb3dlckNhc2UoKTtcbn1cblxuY29uc3QgQ0FQSVRBTF9MRVRURVJTX1JFR0VYUCA9IC9bQS1aXS87XG5jb25zdCBJTVBPUlRBTlRfREVMSU1JVEVSU19SRUdFWFAgPSAvW19cXC0uXS87XG5mdW5jdGlvbiBpc0xldHRlckltcG9ydGFudChpbmRleDogbnVtYmVyLCBuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgaWYgKGluZGV4IDw9IDEpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBpZiAoQ0FQSVRBTF9MRVRURVJTX1JFR0VYUC50ZXN0KG5hbWVbaW5kZXhdKSkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIGNvbnN0IHByZXZpb3VzQ2hhcmFjdGVyID0gbmFtZVtpbmRleCAtIDFdO1xuICBpZiAoSU1QT1JUQU5UX0RFTElNSVRFUlNfUkVHRVhQLnRlc3QocHJldmlvdXNDaGFyYWN0ZXIpKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuLyoqXG4gKiBGQklERSBpbmRleGVzIGVhY2ggZmlsZXBhdGggYnkgaW1wb3J0YW50IGNoYXJhY3RlcnMgaXQgY29udGFpbnMuXG4gKiBUaGlzIGlzIGEgdGVtcG9yYXJ5IHdvcmthcm91bmQgdGhhdCBhbGxvdyBjYWxjdWxhdGluZyBpbXBvcnRhbnQgY2hhcmFjdGVycyBvbiB0aGUgZmx5IHJhdGhlclxuICogdGhhbiByZWx5aW5nIG9uIHRoZSBpbmRleC4gT25jZSB0aGUgaW5kZXggaXMgaW1wbGVtZW50ZWQsIGNvbnN1bWVycyBvZiB0aGlzIG5lZWQgdG8gYmUgdXBkYXRlZC5cbiAqL1xuLy8gVE9ETyhqeGcpOiByZXBsYWNlIHdpdGggXCJpbXBvcnRhbnQgY2hhcmFjdGVyc1wiIGluZGV4LlxuZnVuY3Rpb24gaW1wb3J0YW50Q2hhcmFjdGVyc0ZvclN0cmluZyhzdHI6IHN0cmluZyk6IFNldDxzdHJpbmc+IHtcbiAgY29uc3QgaW1wb3J0YW50Q2hhcmFjdGVycyA9IG5ldyBTZXQoKTtcbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHN0ci5sZW5ndGg7IGluZGV4KyspIHtcbiAgICBjb25zdCBjaGFyID0gc3RyW2luZGV4XTtcbiAgICBpZiAoXG4gICAgICAhaW1wb3J0YW50Q2hhcmFjdGVycy5oYXMoY2hhcikgJiZcbiAgICAgIGlzTGV0dGVySW1wb3J0YW50KGluZGV4LCBzdHIpXG4gICAgKSB7XG4gICAgICBpbXBvcnRhbnRDaGFyYWN0ZXJzLmFkZChjaGFyKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGltcG9ydGFudENoYXJhY3RlcnM7XG59XG5cbmV4cG9ydCBjb25zdCBfX3Rlc3RfXyA9IHtcbiAgY2hlY2tJZk1hdGNoZXNDYW1lbENhc2VMZXR0ZXJzLFxuICBpc0xldHRlckltcG9ydGFudCxcbiAgaW1wb3J0YW50Q2hhcmFjdGVyc0ZvclN0cmluZyxcbiAgc2NvcmVDb21tb25TdWJzZXF1ZW5jZSxcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFF1ZXJ5SXRlbSB7XG4gIF9maWxlcGF0aDogc3RyaW5nO1xuICBfZmlsZXBhdGhMb3dlcmNhc2U6IHN0cmluZztcbiAgX2ZpbGVuYW1lOiBzdHJpbmc7XG4gIF9pbXBvcnRhbnRDaGFyYWN0ZXJzOiBTZXQ8c3RyaW5nPjtcblxuICBjb25zdHJ1Y3RvcihmaWxlcGF0aDogc3RyaW5nKSB7XG4gICAgdGhpcy5fZmlsZXBhdGggPSBmaWxlcGF0aDtcbiAgICB0aGlzLl9maWxlcGF0aExvd2VyY2FzZSA9IGZpbGVwYXRoLnRvTG93ZXJDYXNlKCk7XG4gICAgdGhpcy5fZmlsZW5hbWUgPSBiYXNlbmFtZSh0aGlzLl9maWxlcGF0aExvd2VyY2FzZSk7XG4gICAgdGhpcy5faW1wb3J0YW50Q2hhcmFjdGVycyA9IGltcG9ydGFudENoYXJhY3RlcnNGb3JTdHJpbmcodGhpcy5fZmlsZW5hbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNjb3JlcyB0aGlzIG9iamVjdCdzIHN0cmluZyBhZ2FpbnN0IHRoZSBxdWVyeSBnaXZlbi5cbiAgICpcbiAgICogVG8gc2VhcmNoOlxuICAgKiBhLikgQ3V0IHRoZSBmaXJzdCBsZXR0ZXIgb2ZmIHRoZSBxdWVyeVxuICAgKiBiLikgTG9va3VwIHRoZSBsaXN0IG9mIHRlcm1zIHdoaWNoIGNvbnRhaW4gdGhhdCBsZXR0ZXIgKHdlIGluZGV4ZWQgaXQgZWFybGllcilcbiAgICogYy4pIENvbXBhcmUgb3VyIHF1ZXJ5IGFnYWluc3QgZWFjaCB0ZXJtIGluIHRoYXQgbGlzdFxuICAgKiBkLikgSWYgb3VyIHF1ZXJ5IGlzIGEgY29tbW9uIHN1YnNlcXVlbmNlIG9mIG9uZSBvZiB0aGUgdGVybXMsIGFkZCBpdCB0byB0aGUgcmVzdWx0cyBsaXN0XG4gICAqIGUuKSBXaGlsZSB3ZSBjb21wYXJlIG91ciBxdWVyeSwgd2Uga2VlcCB0cmFjayBvZiBhIHNjb3JlOlxuICAgKiAgICAgaS4pIFRoZSBtb3JlIGdhcHMgdGhlcmUgYXJlIGJldHdlZW4gbWF0Y2hpbmcgY2hhcmFjdGVycywgdGhlIGhpZ2hlciB0aGUgc2NvcmVcbiAgICogICAgIGlpLikgVGhlIG1vcmUgbGV0dGVycyB3aGljaCBhcmUgdGhlIGluY29ycmVjdCBjYXNlLCB0aGUgaGlnaGVyIHRoZSBzY29yZVxuICAgKiAgICAgaWlpLikgRGlyZWN0IG1hdGNoZXMgaGF2ZSBhIHNjb3JlIG9mIDAuXG4gICAqICAgICBpdi4pIFRoZSBsYXRlciB3ZSBmaW5kIG91dCB0aGF0IHdlJ3ZlIG1hdGNoZWQsIHRoZSBoaWdoZXIgdGhlIHNjb3JlXG4gICAqICAgICB2LikgTG9uZ2VyIHRlcm1zIGhhdmUgaGlnaGVyIHNjb3Jlc1xuICAgKiAgICAgLSBUaGUgbW9yZSB5b3VyIHF1ZXJ5IGlzIHNwcmVhZHMgb3V0IGFjcm9zcyB0aGUgcmVzdWx0LFxuICAgKiAgICAgICB0aGUgbGVzcyBsaWtlbHkgaXQgaXMgd2hhdCB5b3UncmUgbG9va2luZyBmb3IuXG4gICAqICAgICAtIFRoZSBzaG9ydGVyIHRoZSByZXN1bHQsIHRoZSBjbG9zZXIgdGhlIGxlbmd0aCBpcyB0byB3aGF0IHlvdSBzZWFyY2hlZCBmb3IsXG4gICAqICAgICAgIHNvIGl0J3MgbW9yZSBsaWtlbHkuXG4gICAqICAgICAtIFRoZSBlYXJsaWVyIHdlIGZpbmQgdGhlIG1hdGNoLCB0aGUgbW9yZSBsaWtlbHkgaXQgaXMgdG8gYmUgd2hhdCB5b3UncmUgbG9va2luZyBmb3IuXG4gICAqICAgICAtIFRoZSBtb3JlIGNhc2VzIG9mIHRoZSBjaGFyYWN0ZXJzIHRoYXQgbWF0Y2gsIHRoZSBtb3JlIGxpa2VseSBpdCBpcyB0byBiZSB3aGF0IHlvdSB3YW50LlxuICAgKiBmLikgU29ydCB0aGUgcmVzdWx0cyBieSB0aGUgc2NvcmVcbiAgICovXG4gIHNjb3JlKHF1ZXJ5OiBzdHJpbmcpOiA/UXVlcnlTY29yZSB7XG4gICAgY29uc3Qgc2NvcmUgPSB0aGlzLl9nZXRTY29yZUZvcihxdWVyeSk7XG4gICAgcmV0dXJuIHNjb3JlID09IG51bGwgPyBudWxsIDoge3Njb3JlLCB2YWx1ZTogdGhpcy5fZmlsZXBhdGgsIG1hdGNoSW5kZXhlczogW119O1xuICB9XG5cbiAgX2dldFNjb3JlRm9yKHF1ZXJ5OiBzdHJpbmcpOiA/bnVtYmVyIHtcbiAgICAvLyBQdXJlbHkgZGVmZW5zaXZlLCBhcyBxdWVyeSBpcyBndWFyYW50ZWVkIHRvIGJlIG5vbi1lbXB0eS5cbiAgICBpZiAocXVlcnkubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgLy8gQ2hlY2sgaWYgdGhpcyBhIFwicG9zc2libGUgcmVzdWx0XCIuXG4gICAgLy8gVE9ETyBjb25zaWRlciBidWlsZGluZyBhIGRpcmVjdG9yeS1sZXZlbCBpbmRleCBmcm9tIGltcG9ydGFudF9jaGFyYWN0ZXIgLT4gUXVlcnlJdGVtLFxuICAgIC8vIGFraW4gdG8gRkJJREUncyBpbXBsZW1lbnRhdGlvbi5cbiAgICBjb25zdCBmaXJzdENoYXIgPSBxdWVyeVswXS50b0xvd2VyQ2FzZSgpO1xuICAgIGlmICghdGhpcy5faW1wb3J0YW50Q2hhcmFjdGVycy5oYXMoZmlyc3RDaGFyKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGlmIChxdWVyeS5sZW5ndGggPj0gMyAmJiBjaGVja0lmTWF0Y2hlc0NhbWVsQ2FzZUxldHRlcnMocXVlcnksIHRoaXMuX2ZpbGVuYW1lKSkge1xuICAgICAgLy8gSWYgd2UgbWF0Y2ggdGhlIHVwcGVyY2FzZSBjaGFyYWN0ZXJzIG9mIHRoZSBmaWxlbmFtZSwgd2Ugc2hvdWxkIGJlIHJhbmtlZCB0aGUgaGlnaGVzdFxuICAgICAgcmV0dXJuIDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHN1YiA9IHRoaXMuX2ZpbGVwYXRoTG93ZXJjYXNlLmluZGV4T2YocXVlcnkudG9Mb3dlckNhc2UoKSk7XG4gICAgICBpZiAoc3ViICE9PSAtMSAmJiBxdWVyeS5sZW5ndGggPCB0aGlzLl9maWxlbmFtZS5sZW5ndGgpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFdlIGFkZCB0aGUgbGVuZ3RoIG9mIHRoZSB0ZXJtIHNvIHdlIGNhbiBiZSByYW5rZWQgYWxvbmdzaWRlIHRoZVxuICAgICAgICAgKiBzY29yZXMgZ2VuZXJhdGVkIGJ5IGBzY29yZUNvbW1vblN1YnNlcXVlbmNlYCB3aGljaCBhbHNvIGZhY3RvcnMgaW4gdGhlXG4gICAgICAgICAqIGxlbmd0aC5cbiAgICAgICAgICogVGhpcyB3YXkgd2hlbiB5b3Ugc2VhcmNoIGZvciBgRWRpc29uQ29udHJvbGxlcmAsXG4gICAgICAgICAqIEVkaXNvbkNvbnRyb2xsZXIgc2NvcmVzIDBcbiAgICAgICAgICogRWRpeHhzb25Db250cm9sbGVyIHNjb3JlcyA0MCAoZnJvbSBgc2NvcmVDb21tb25TdWJzZXF1ZW5jZWAgc2NvcmluZylcbiAgICAgICAgICogU29tZXRoaW5nQmxhaEJsYWhFZGlzb25Db250cm9sbGVyIHNjb3JlcyA1MCBmcm9tIHN1YnN0cmluZyBzY29yaW5nXG4gICAgICAgICAqIFdlYkRlY2lzaW9uQ29udHJvbGxlciBzY29yZXMgNTIgKGZyb20gYHNjb3JlQ29tbW9uU3Vic2VxdWVuY2VgIHNjb3JpbmcpXG4gICAgICAgICAqL1xuICAgICAgICByZXR1cm4gc3ViICsgdGhpcy5fZmlsZW5hbWUubGVuZ3RoO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVE9ETyhqeGcpOiBJbnZlc3RpZ2F0ZSBleHRlbmRpbmcgc2NvcmVDb21tb25TdWJzZXF1ZW5jZSB0byBjb25zaWRlciBzdWJzZXF1ZW5jZXNcbiAgICAgICAgLy8gYmlkaXJlY3Rpb25hbGx5LCBvciB1c2UgKHNvbWUgcHJveHkgZm9yKSBlZGl0IGRpc3RhbmNlLlxuICAgICAgICBjb25zdCBzY29yZSA9IHNjb3JlQ29tbW9uU3Vic2VxdWVuY2UocXVlcnksIHRoaXMuX2ZpbGVuYW1lKTtcbiAgICAgICAgaWYgKHNjb3JlICE9PSAtMSkge1xuICAgICAgICAgIHJldHVybiBzY29yZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG59XG4iXX0=
