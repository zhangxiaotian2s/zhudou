Object.defineProperty(exports, '__esModule', {
  value: true
});

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var _QueryItem = require('./QueryItem');

var _QueryItem2 = _interopRequireDefault(_QueryItem);

var _PathSet = require('./PathSet');

var _PathSet2 = _interopRequireDefault(_PathSet);

var _TopScores = require('./TopScores');

var _TopScores2 = _interopRequireDefault(_TopScores);

'use babel';

var PATH_SEARCH_TIMEOUT_MS = 60 * 1000;
var MAX_RESULTS_COUNT = 50;

/**
 * Manages multiple simultaneous queries against a PathSet. The PathSearch is
 * responsible for deciding which queries to cancel based on newer queries.
 */

var PathSearch = (function () {

  /**
   * @param pathSet that keeps itself in sync with whatever directory it
   *     represents.
   */

  function PathSearch(pathSet) {
    _classCallCheck(this, PathSearch);

    this._pathSet = pathSet;
    this._activeQueries = {};
    this._queryItemForPath = {}; // It might be more efficient to store this in PathSet.
  }

  _createClass(PathSearch, [{
    key: '_doFuzzyFilenameSearch',
    value: function _doFuzzyFilenameSearch(query, topScores) {
      var _this = this;

      var processor = function processor(path) {
        var queryItem = _this._queryItemForPath[path];
        if (!queryItem) {
          queryItem = new _QueryItem2['default'](path);
          // Currently, nothing is ever removed from _queryItemForPath. It's
          // unclear if the additional complexity in bookkeeping effort would
          // merit the memory savings.
          _this._queryItemForPath[path] = queryItem;
        }
        var alphanumericQuery = query.replace(/[^a-z0-9/]/g, '');
        var scoredItem = queryItem.score(alphanumericQuery);
        if (scoredItem != null) {
          topScores.insert(scoredItem);
        }
      };
      return this._pathSet.submit(processor);
    }

    // `query` is assumed to be a lower-case string.
  }, {
    key: '_doPathSearch',
    value: function _doPathSearch(query, topScores) {
      var _this2 = this;

      var processor = function processor(path) {
        if (topScores.getSize() < MAX_RESULTS_COUNT && path.toLowerCase().indexOf(query) !== -1) {
          topScores.insert({
            matchIndexes: [],
            score: 0,
            value: path
          });
        }
      };
      var pathSetJob = this._pathSet.submit(processor);
      var nextJob = pathSetJob.then(function () {
        if (topScores.getSize() === 0 && query.indexOf('/') !== -1) {
          return _this2._doPathSearch(query.substring(query.indexOf('/') + 1), topScores);
        }
        return pathSetJob;
      });
      // The cancelJob expando property needs to be forwarded manually.
      // This is also the reason we cannot use `await` in this logic, since it's not possible to pass
      // cancelJob to the resulting auto-boxed Promise.
      // $FlowFixMe: Remove the cancelJob expando off the promise.
      nextJob.cancelJob = pathSetJob.cancelJob;
      return nextJob;
    }

    /**
     * @param query Is expected to be what the user has typed in a path-matching
     *     typeahead UI.
     * @return Promise that resolves to an empty ResultSet if it is canceled.
     */
  }, {
    key: 'doQuery',
    value: function doQuery(query) {
      var _this3 = this;

      query = query.toLowerCase();
      if (query.length === 0) {
        return Promise.resolve({ query: '', results: [] });
      }

      // See if a request for this query is already in flight.
      var activeQuery = this._activeQueries[query];
      if (activeQuery) {
        return activeQuery;
      }

      // If any of the existing queries are a prefix of this new query, cancel
      // them. Here, we are assuming this is used to power a typeahead, so the
      // results of the old queries will no longer be of interest.
      var keysToRemove = [];
      for (var _key in this._activeQueries) {
        if (query.startsWith(_key)) {
          keysToRemove.push(_key);
        }
      }

      // Because cancelJob() will call removePromise(), which will modify
      // this._activeQueries, we cannot call cancelJob() while iterating
      // this._activeQueries in the for/in loop above because that could interfere
      // with the iteration.
      if (keysToRemove.length) {
        // $FlowFixMe: Remove the cancelJob expando off the promise.
        keysToRemove.forEach(function (key) {
          return _this3._activeQueries[key].cancelJob();
        });
      }

      var topScores = new _TopScores2['default']( /* capacity */MAX_RESULTS_COUNT);

      // If there is a slash in the query, we assume we're searching paths instead of filenames
      // and therefore we won't remove special characters, and won't use the fuzzy search logic
      var shouldSearchPaths = query.indexOf('/') !== -1;
      var promise = shouldSearchPaths ? this._doPathSearch(query, topScores) : this._doFuzzyFilenameSearch(query, topScores);

      var promiseForQuery = undefined;
      var removePromise = function removePromise() {
        var entry = _this3._activeQueries[query];
        // Remove the entry only if it has not been replaced by a more recent one.
        if (entry === promiseForQuery) {
          delete _this3._activeQueries[query];
        }
      };

      promiseForQuery = promise.then(function () {
        var results = topScores.getTopScores();
        // Do the deletion in a timeout in case the user types backspace,
        // effectively asking for the previous results again.
        setTimeout(removePromise, PATH_SEARCH_TIMEOUT_MS);
        var result = { query: query, results: results };
        return result;
      }, function (error) {
        removePromise();
        if (error.errorCode === _PathSet2['default'].ERROR_CODE_CANCELED) {
          // This request was canceled: resolve to an empty ResultSet.
          return {
            query: query,
            results: []
          };
        } else {
          throw error;
        }
      });
      // $FlowFixMe: Remove the cancelJob expando off the promise.
      promiseForQuery.cancelJob = promise.cancelJob;
      this._activeQueries[query] = promiseForQuery;
      return promiseForQuery;
    }
  }]);

  return PathSearch;
})();

exports['default'] = PathSearch;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXBhdGgtc2VhcmNoL2xpYi9QYXRoU2VhcmNoLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozt5QkFZc0IsYUFBYTs7Ozt1QkFDZixXQUFXOzs7O3lCQUNULGFBQWE7Ozs7QUFkbkMsV0FBVyxDQUFDOztBQXFCWixJQUFNLHNCQUFzQixHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFDekMsSUFBTSxpQkFBaUIsR0FBRyxFQUFFLENBQUM7Ozs7Ozs7SUFNUixVQUFVOzs7Ozs7O0FBU2xCLFdBVFEsVUFBVSxDQVNqQixPQUFnQixFQUFFOzBCQVRYLFVBQVU7O0FBVTNCLFFBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDO0FBQ3hCLFFBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO0FBQ3pCLFFBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7R0FDN0I7O2VBYmtCLFVBQVU7O1dBZVAsZ0NBQUMsS0FBYSxFQUFFLFNBQW9CLEVBQWlCOzs7QUFDekUsVUFBTSxTQUFTLEdBQUcsU0FBWixTQUFTLENBQUksSUFBSSxFQUFhO0FBQ2xDLFlBQUksU0FBUyxHQUFHLE1BQUssaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDN0MsWUFBSSxDQUFDLFNBQVMsRUFBRTtBQUNkLG1CQUFTLEdBQUcsMkJBQWMsSUFBSSxDQUFDLENBQUM7Ozs7QUFJaEMsZ0JBQUssaUJBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDO1NBQzFDO0FBQ0QsWUFBTSxpQkFBaUIsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUMzRCxZQUFNLFVBQVUsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFD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QSxDQUFDO0FBQ3BCLFVBQU0sYUFBYSxHQUFHLFNBQWhCLGFBQWEsR0FBUztBQUMxQixZQUFNLEtBQUssR0FBRyxPQUFLLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQzs7QUFFekMsWUFBSSxLQUFLLEtBQUssZUFBZSxFQUFFO0FBQzdCLGlCQUFPLE9BQUssY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ25DO09BQ0YsQ0FBQzs7QUFFRixxQkFBZSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBTTtBQUNuQyxZQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUM7OztBQUd6QyxrQkFBVSxDQUFDLGFBQWEsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2xELFlBQU0sTUFBaUIsR0FBRyxFQUFDLEtBQUssRUFBTCxLQUFLLEVBQUUsT0FBTyxFQUFQLE9BQU8sRUFBQyxDQUFDO0FBQzNDLGVBQU8sTUFBTSxDQUFDO09BQ2YsRUFBRSxVQUFDLEtBQUssRUFBWTtBQUNuQixxQkFBYSxFQUFFLENBQUM7QUFDaEIsWUFBSSxLQUFLLENBQUMsU0FBUyxLQUFLLHFCQUFRLG1CQUFtQixFQUFFOztBQUVuRCxpQkFBTztBQUNMLGlCQUFLLEVBQUwsS0FBSztBQUNMLG1CQUFPLEVBQUUsRUFBRTtXQUNaLENBQUM7U0FDSCxNQUFNO0FBQ0wsZ0JBQU0sS0FBSyxDQUFDO1NBQ2I7T0FDRixDQUFDLENBQUM7O0FBRUgscUJBQWUsQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQztBQUM5QyxVQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxHQUFHLGVBQWUsQ0FBQztBQUM3QyxhQUFPLGVBQWUsQ0FBQztLQUN4Qjs7O1NBMUlrQixVQUFVOzs7cUJBQVYsVUFBVSIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wcGZsNTJucHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1wYXRoLXNlYXJjaC9saWIvUGF0aFNlYXJjaC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbmltcG9ydCB0eXBlIHtRdWVyeVNjb3JlfSBmcm9tICcuL1F1ZXJ5U2NvcmUnO1xuaW1wb3J0IFF1ZXJ5SXRlbSBmcm9tICcuL1F1ZXJ5SXRlbSc7XG5pbXBvcnQgUGF0aFNldCBmcm9tICcuL1BhdGhTZXQnO1xuaW1wb3J0IFRvcFNjb3JlcyBmcm9tICcuL1RvcFNjb3Jlcyc7XG5cbnR5cGUgUmVzdWx0U2V0ID0ge1xuICBxdWVyeTogc3RyaW5nO1xuICByZXN1bHRzOiBBcnJheTxRdWVyeVNjb3JlPjtcbn07XG5cbmNvbnN0IFBBVEhfU0VBUkNIX1RJTUVPVVRfTVMgPSA2MCAqIDEwMDA7XG5jb25zdCBNQVhfUkVTVUxUU19DT1VOVCA9IDUwO1xuXG4vKipcbiAqIE1hbmFnZXMgbXVsdGlwbGUgc2ltdWx0YW5lb3VzIHF1ZXJpZXMgYWdhaW5zdCBhIFBhdGhTZXQuIFRoZSBQYXRoU2VhcmNoIGlzXG4gKiByZXNwb25zaWJsZSBmb3IgZGVjaWRpbmcgd2hpY2ggcXVlcmllcyB0byBjYW5jZWwgYmFzZWQgb24gbmV3ZXIgcXVlcmllcy5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGF0aFNlYXJjaCB7XG4gIF9wYXRoU2V0OiBQYXRoU2V0O1xuICBfYWN0aXZlUXVlcmllczoge1trZXk6IHN0cmluZ106IFByb21pc2U8UmVzdWx0U2V0Pn07XG4gIF9xdWVyeUl0ZW1Gb3JQYXRoOiB7W2tleTogc3RyaW5nXTogUXVlcnlJdGVtfTtcblxuICAvKipcbiAgICogQHBhcmFtIHBhdGhTZXQgdGhhdCBrZWVwcyBpdHNlbGYgaW4gc3luYyB3aXRoIHdoYXRldmVyIGRpcmVjdG9yeSBpdFxuICAgKiAgICAgcmVwcmVzZW50cy5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHBhdGhTZXQ6IFBhdGhTZXQpIHtcbiAgICB0aGlzLl9wYXRoU2V0ID0gcGF0aFNldDtcbiAgICB0aGlzLl9hY3RpdmVRdWVyaWVzID0ge307XG4gICAgdGhpcy5fcXVlcnlJdGVtRm9yUGF0aCA9IHt9OyAvLyBJdCBtaWdodCBiZSBtb3JlIGVmZmljaWVudCB0byBzdG9yZSB0aGlzIGluIFBhdGhTZXQuXG4gIH1cblxuICBfZG9GdXp6eUZpbGVuYW1lU2VhcmNoKHF1ZXJ5OiBzdHJpbmcsIHRvcFNjb3JlczogVG9wU2NvcmVzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcHJvY2Vzc29yID0gKHBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgbGV0IHF1ZXJ5SXRlbSA9IHRoaXMuX3F1ZXJ5SXRlbUZvclBhdGhbcGF0aF07XG4gICAgICBpZiAoIXF1ZXJ5SXRlbSkge1xuICAgICAgICBxdWVyeUl0ZW0gPSBuZXcgUXVlcnlJdGVtKHBhdGgpO1xuICAgICAgICAvLyBDdXJyZW50bHksIG5vdGhpbmcgaXMgZXZlciByZW1vdmVkIGZyb20gX3F1ZXJ5SXRlbUZvclBhdGguIEl0J3NcbiAgICAgICAgLy8gdW5jbGVhciBpZiB0aGUgYWRkaXRpb25hbCBjb21wbGV4aXR5IGluIGJvb2trZWVwaW5nIGVmZm9ydCB3b3VsZFxuICAgICAgICAvLyBtZXJpdCB0aGUgbWVtb3J5IHNhdmluZ3MuXG4gICAgICAgIHRoaXMuX3F1ZXJ5SXRlbUZvclBhdGhbcGF0aF0gPSBxdWVyeUl0ZW07XG4gICAgICB9XG4gICAgICBjb25zdCBhbHBoYW51bWVyaWNRdWVyeSA9IHF1ZXJ5LnJlcGxhY2UoL1teYS16MC05L10vZywgJycpO1xuICAgICAgY29uc3Qgc2NvcmVkSXRlbSA9IHF1ZXJ5SXRlbS5zY29yZShhbHBoYW51bWVyaWNRdWVyeSk7XG4gICAgICBpZiAoc2NvcmVkSXRlbSAhPSBudWxsKSB7XG4gICAgICAgIHRvcFNjb3Jlcy5pbnNlcnQoc2NvcmVkSXRlbSk7XG4gICAgICB9XG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5fcGF0aFNldC5zdWJtaXQocHJvY2Vzc29yKTtcbiAgfVxuXG4gIC8vIGBxdWVyeWAgaXMgYXNzdW1lZCB0byBiZSBhIGxvd2VyLWNhc2Ugc3RyaW5nLlxuICBfZG9QYXRoU2VhcmNoKHF1ZXJ5OiBzdHJpbmcsIHRvcFNjb3JlczogVG9wU2NvcmVzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcHJvY2Vzc29yID0gKHBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKHRvcFNjb3Jlcy5nZXRTaXplKCkgPCBNQVhfUkVTVUxUU19DT1VOVCAmJiBwYXRoLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihxdWVyeSkgIT09IC0xKSB7XG4gICAgICAgIHRvcFNjb3Jlcy5pbnNlcnQoe1xuICAgICAgICAgIG1hdGNoSW5kZXhlczogW10sXG4gICAgICAgICAgc2NvcmU6IDAsXG4gICAgICAgICAgdmFsdWU6IHBhdGgsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH07XG4gICAgY29uc3QgcGF0aFNldEpvYiA9IHRoaXMuX3BhdGhTZXQuc3VibWl0KHByb2Nlc3Nvcik7XG4gICAgY29uc3QgbmV4dEpvYiA9IHBhdGhTZXRKb2IudGhlbigoKSA9PiB7XG4gICAgICBpZiAodG9wU2NvcmVzLmdldFNpemUoKSA9PT0gMCAmJiBxdWVyeS5pbmRleE9mKCcvJykgIT09IC0xKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kb1BhdGhTZWFyY2gocXVlcnkuc3Vic3RyaW5nKHF1ZXJ5LmluZGV4T2YoJy8nKSArIDEpLCB0b3BTY29yZXMpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHBhdGhTZXRKb2I7XG4gICAgfSk7XG4gICAgLy8gVGhlIGNhbmNlbEpvYiBleHBhbmRvIHByb3BlcnR5IG5lZWRzIHRvIGJlIGZvcndhcmRlZCBtYW51YWxseS5cbiAgICAvLyBUaGlzIGlzIGFsc28gdGhlIHJlYXNvbiB3ZSBjYW5ub3QgdXNlIGBhd2FpdGAgaW4gdGhpcyBsb2dpYywgc2luY2UgaXQncyBub3QgcG9zc2libGUgdG8gcGFzc1xuICAgIC8vIGNhbmNlbEpvYiB0byB0aGUgcmVzdWx0aW5nIGF1dG8tYm94ZWQgUHJvbWlzZS5cbiAgICAvLyAkRmxvd0ZpeE1lOiBSZW1vdmUgdGhlIGNhbmNlbEpvYiBleHBhbmRvIG9mZiB0aGUgcHJvbWlzZS5cbiAgICBuZXh0Sm9iLmNhbmNlbEpvYiA9IHBhdGhTZXRKb2IuY2FuY2VsSm9iO1xuICAgIHJldHVybiBuZXh0Sm9iO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSBxdWVyeSBJcyBleHBlY3RlZCB0byBiZSB3aGF0IHRoZSB1c2VyIGhhcyB0eXBlZCBpbiBhIHBhdGgtbWF0Y2hpbmdcbiAgICogICAgIHR5cGVhaGVhZCBVSS5cbiAgICogQHJldHVybiBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gYW4gZW1wdHkgUmVzdWx0U2V0IGlmIGl0IGlzIGNhbmNlbGVkLlxuICAgKi9cbiAgZG9RdWVyeShxdWVyeTogc3RyaW5nKTogUHJvbWlzZTxSZXN1bHRTZXQ+IHtcbiAgICBxdWVyeSA9IHF1ZXJ5LnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKHF1ZXJ5Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7cXVlcnk6ICcnLCByZXN1bHRzOiBbXX0pO1xuICAgIH1cblxuICAgIC8vIFNlZSBpZiBhIHJlcXVlc3QgZm9yIHRoaXMgcXVlcnkgaXMgYWxyZWFkeSBpbiBmbGlnaHQuXG4gICAgY29uc3QgYWN0aXZlUXVlcnkgPSB0aGlzLl9hY3RpdmVRdWVyaWVzW3F1ZXJ5XTtcbiAgICBpZiAoYWN0aXZlUXVlcnkpIHtcbiAgICAgIHJldHVybiBhY3RpdmVRdWVyeTtcbiAgICB9XG5cbiAgICAvLyBJZiBhbnkgb2YgdGhlIGV4aXN0aW5nIHF1ZXJpZXMgYXJlIGEgcHJlZml4IG9mIHRoaXMgbmV3IHF1ZXJ5LCBjYW5jZWxcbiAgICAvLyB0aGVtLiBIZXJlLCB3ZSBhcmUgYXNzdW1pbmcgdGhpcyBpcyB1c2VkIHRvIHBvd2VyIGEgdHlwZWFoZWFkLCBzbyB0aGVcbiAgICAvLyByZXN1bHRzIG9mIHRoZSBvbGQgcXVlcmllcyB3aWxsIG5vIGxvbmdlciBiZSBvZiBpbnRlcmVzdC5cbiAgICBjb25zdCBrZXlzVG9SZW1vdmUgPSBbXTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLl9hY3RpdmVRdWVyaWVzKSB7XG4gICAgICBpZiAocXVlcnkuc3RhcnRzV2l0aChrZXkpKSB7XG4gICAgICAgIGtleXNUb1JlbW92ZS5wdXNoKGtleSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQmVjYXVzZSBjYW5jZWxKb2IoKSB3aWxsIGNhbGwgcmVtb3ZlUHJvbWlzZSgpLCB3aGljaCB3aWxsIG1vZGlmeVxuICAgIC8vIHRoaXMuX2FjdGl2ZVF1ZXJpZXMsIHdlIGNhbm5vdCBjYWxsIGNhbmNlbEpvYigpIHdoaWxlIGl0ZXJhdGluZ1xuICAgIC8vIHRoaXMuX2FjdGl2ZVF1ZXJpZXMgaW4gdGhlIGZvci9pbiBsb29wIGFib3ZlIGJlY2F1c2UgdGhhdCBjb3VsZCBpbnRlcmZlcmVcbiAgICAvLyB3aXRoIHRoZSBpdGVyYXRpb24uXG4gICAgaWYgKGtleXNUb1JlbW92ZS5sZW5ndGgpIHtcbiAgICAgIC8vICRGbG93Rml4TWU6IFJlbW92ZSB0aGUgY2FuY2VsSm9iIGV4cGFuZG8gb2ZmIHRoZSBwcm9taXNlLlxuICAgICAga2V5c1RvUmVtb3ZlLmZvckVhY2goa2V5ID0+IHRoaXMuX2FjdGl2ZVF1ZXJpZXNba2V5XS5jYW5jZWxKb2IoKSk7XG4gICAgfVxuXG5cbiAgICBjb25zdCB0b3BTY29yZXMgPSBuZXcgVG9wU2NvcmVzKC8qIGNhcGFjaXR5ICovIE1BWF9SRVNVTFRTX0NPVU5UKTtcblxuICAgIC8vIElmIHRoZXJlIGlzIGEgc2xhc2ggaW4gdGhlIHF1ZXJ5LCB3ZSBhc3N1bWUgd2UncmUgc2VhcmNoaW5nIHBhdGhzIGluc3RlYWQgb2YgZmlsZW5hbWVzXG4gICAgLy8gYW5kIHRoZXJlZm9yZSB3ZSB3b24ndCByZW1vdmUgc3BlY2lhbCBjaGFyYWN0ZXJzLCBhbmQgd29uJ3QgdXNlIHRoZSBmdXp6eSBzZWFyY2ggbG9naWNcbiAgICBjb25zdCBzaG91bGRTZWFyY2hQYXRocyA9IHF1ZXJ5LmluZGV4T2YoJy8nKSAhPT0gLTE7XG4gICAgY29uc3QgcHJvbWlzZSA9IHNob3VsZFNlYXJjaFBhdGhzXG4gICAgICA/IHRoaXMuX2RvUGF0aFNlYXJjaChxdWVyeSwgdG9wU2NvcmVzKVxuICAgICAgOiB0aGlzLl9kb0Z1enp5RmlsZW5hbWVTZWFyY2gocXVlcnksIHRvcFNjb3Jlcyk7XG5cbiAgICBsZXQgcHJvbWlzZUZvclF1ZXJ5O1xuICAgIGNvbnN0IHJlbW92ZVByb21pc2UgPSAoKSA9PiB7XG4gICAgICBjb25zdCBlbnRyeSA9IHRoaXMuX2FjdGl2ZVF1ZXJpZXNbcXVlcnldO1xuICAgICAgLy8gUmVtb3ZlIHRoZSBlbnRyeSBvbmx5IGlmIGl0IGhhcyBub3QgYmVlbiByZXBsYWNlZCBieSBhIG1vcmUgcmVjZW50IG9uZS5cbiAgICAgIGlmIChlbnRyeSA9PT0gcHJvbWlzZUZvclF1ZXJ5KSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9hY3RpdmVRdWVyaWVzW3F1ZXJ5XTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJvbWlzZUZvclF1ZXJ5ID0gcHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSB0b3BTY29yZXMuZ2V0VG9wU2NvcmVzKCk7XG4gICAgICAvLyBEbyB0aGUgZGVsZXRpb24gaW4gYSB0aW1lb3V0IGluIGNhc2UgdGhlIHVzZXIgdHlwZXMgYmFja3NwYWNlLFxuICAgICAgLy8gZWZmZWN0aXZlbHkgYXNraW5nIGZvciB0aGUgcHJldmlvdXMgcmVzdWx0cyBhZ2Fpbi5cbiAgICAgIHNldFRpbWVvdXQocmVtb3ZlUHJvbWlzZSwgUEFUSF9TRUFSQ0hfVElNRU9VVF9NUyk7XG4gICAgICBjb25zdCByZXN1bHQ6IFJlc3VsdFNldCA9IHtxdWVyeSwgcmVzdWx0c307XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sIChlcnJvcjogRXJyb3IpID0+IHtcbiAgICAgIHJlbW92ZVByb21pc2UoKTtcbiAgICAgIGlmIChlcnJvci5lcnJvckNvZGUgPT09IFBhdGhTZXQuRVJST1JfQ09ERV9DQU5DRUxFRCkge1xuICAgICAgICAvLyBUaGlzIHJlcXVlc3Qgd2FzIGNhbmNlbGVkOiByZXNvbHZlIHRvIGFuIGVtcHR5IFJlc3VsdFNldC5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBxdWVyeSxcbiAgICAgICAgICByZXN1bHRzOiBbXSxcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgIH0pO1xuICAgIC8vICRGbG93Rml4TWU6IFJlbW92ZSB0aGUgY2FuY2VsSm9iIGV4cGFuZG8gb2ZmIHRoZSBwcm9taXNlLlxuICAgIHByb21pc2VGb3JRdWVyeS5jYW5jZWxKb2IgPSBwcm9taXNlLmNhbmNlbEpvYjtcbiAgICB0aGlzLl9hY3RpdmVRdWVyaWVzW3F1ZXJ5XSA9IHByb21pc2VGb3JRdWVyeTtcbiAgICByZXR1cm4gcHJvbWlzZUZvclF1ZXJ5O1xuICB9XG5cbn1cbiJdfQ==
