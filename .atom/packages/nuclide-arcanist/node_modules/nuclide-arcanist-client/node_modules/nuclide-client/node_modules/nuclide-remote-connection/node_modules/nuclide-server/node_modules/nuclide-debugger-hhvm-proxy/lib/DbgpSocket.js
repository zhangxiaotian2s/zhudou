var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var _DbgpMessageHandler = require('./DbgpMessageHandler');

// Responses to the DBGP 'status' command
'use babel';

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _require = require('./utils');

var log = _require.log;
var logError = _require.logError;

var _require2 = require('events');

var EventEmitter = _require2.EventEmitter;
var STATUS_STARTING = 'starting';
var STATUS_STOPPING = 'stopping';
var STATUS_STOPPED = 'stopped';
var STATUS_RUNNING = 'running';
var STATUS_BREAK = 'break';
// Error and End are not dbgp status codes, they relate to socket states.
var STATUS_ERROR = 'error';
var STATUS_END = 'end';

// Valid continuation commands
var COMMAND_RUN = 'run';
var COMMAND_STEP_INTO = 'step_into';
var COMMAND_STEP_OVER = 'step_over';
var COMMAND_STEP_OUT = 'step_out';
var COMMAND_STOP = 'stop';
var COMMAND_DETACH = 'detach';

var DBGP_SOCKET_STATUS_EVENT = 'dbgp-socket-status';

/**
 * Handles sending and recieving dbgp messages over a net Socket.
 * Dbgp documentation can be found at http://xdebug.org/docs-dbgp.php
 */

var DbgpSocket = (function () {
  function DbgpSocket(socket) {
    _classCallCheck(this, DbgpSocket);

    this._socket = socket;
    this._transactionId = 0;
    this._calls = new Map();
    this._emitter = new EventEmitter();
    this._isClosed = false;
    this._messageHandler = (0, _DbgpMessageHandler.getDbgpMessageHandlerInstance)();

    this._socket.on('end', this._onEnd.bind(this));
    this._socket.on('error', this._onError.bind(this));
    this._socket.on('data', this._onData.bind(this));
  }

  _createClass(DbgpSocket, [{
    key: 'onStatus',
    value: function onStatus(callback) {
      return require('nuclide-commons').event.attachEvent(this._emitter, DBGP_SOCKET_STATUS_EVENT, callback);
    }
  }, {
    key: '_onError',
    value: function _onError(error) {
      // Not sure if hhvm is alive or not
      // do not set _isClosed flag so that detach will be sent before dispose().
      logError('socket error ' + error.code);
      this._emitStatus(STATUS_ERROR);
    }
  }, {
    key: '_onEnd',
    value: function _onEnd() {
      this._isClosed = true;
      this.dispose();
      this._emitStatus(STATUS_END);
    }
  }, {
    key: '_onData',
    value: function _onData(data) {
      var _this = this;

      var message = data.toString();
      log('Recieved data: ' + message);
      var responses = this._messageHandler.parseMessages(message);
      responses.forEach(function (r) {
        var response = r.response;
        if (response) {
          var responseAttributes = response.$;
          var _command = responseAttributes.command;
          var transaction_id = responseAttributes.transaction_id;

          var transactionId = Number(transaction_id);
          var call = _this._calls.get(transactionId);
          if (!call) {
            logError('Missing call for response: ' + message);
            return;
          }
          _this._calls['delete'](transactionId);

          if (call.command !== _command) {
            logError('Bad command in response. Found ' + _command + '. expected ' + call.command);
            return;
          }
          try {
            log('Completing call: ' + message);
            call.complete(response);
          } catch (e) {
            logError('Exception: ' + e.toString() + ' handling call: ' + message);
          }
        } else {
          logError('Unexpected socket message: ' + message);
        }
      });
    }
  }, {
    key: 'getStackFrames',
    value: function getStackFrames() {
      return this._callDebugger('stack_get');
    }
  }, {
    key: 'getContextsForFrame',
    value: _asyncToGenerator(function* (frameIndex) {
      var result = yield this._callDebugger('context_names', '-d ' + frameIndex);
      return result.context.map(function (context) {
        return context.$;
      });
    })
  }, {
    key: 'getContextProperties',
    value: _asyncToGenerator(function* (frameIndex, contextId) {
      var result = yield this._callDebugger('context_get', '-d ' + frameIndex + ' -c ' + contextId);
      // 0 results yields missing 'property' member
      return result.property || [];
    })
  }, {
    key: 'getPropertiesByFullname',
    value: _asyncToGenerator(function* (frameIndex, contextId, fullname, page) {
      var result = yield this._callDebugger('property_value', '-d ' + frameIndex + ' -c ' + contextId + ' -n ' + fullname + ' -p ' + page);
      // property_value returns the outer property, we want the children ...
      // 0 results yields missing 'property' member
      return result.property[0].property || [];
    })
  }, {
    key: 'getPropertiesByFullnameAllConexts',
    value: _asyncToGenerator(function* (frameIndex, fullname, page) {
      // Pass zero as contextId to search all contexts.
      return yield this.getPropertiesByFullname(frameIndex, /*contextId*/'0', fullname, page);
    })
  }, {
    key: 'evaluateOnCallFrame',
    value: _asyncToGenerator(function* (frameIndex, expression) {
      // Escape any double quote in the expression.
      var escapedExpression = expression.replace(/"/g, '\\"');
      // Quote the input expression so that we can support expression with
      // space in it(e.g. function evaluation).
      var result = yield this._callDebugger('property_value', '-d ' + frameIndex + ' -n "' + escapedExpression + '"');
      if (result.error && result.error.length > 0) {
        return {
          error: result.error[0],
          wasThrown: true
        };
      }
      return {
        result: result.property[0] || [],
        wasThrown: false
      };
    })

    // Returns one of:
    //  starting, stopping, stopped, running, break
  }, {
    key: 'getStatus',
    value: _asyncToGenerator(function* () {
      var response = yield this._callDebugger('status');
      // TODO: Do we ever care about response.$.reason?
      return response.$.status;
    })

    // Continuation commands get a response, but that response
    // is a status message which occurs after execution stops.
  }, {
    key: 'sendContinuationCommand',
    value: _asyncToGenerator(function* (command) {
      this._emitStatus(STATUS_RUNNING);
      var response = yield this._callDebugger(command);
      var status = response.$.status;
      this._emitStatus(status);
      return status;
    })
  }, {
    key: 'sendBreakCommand',
    value: _asyncToGenerator(function* () {
      var response = yield this._callDebugger('break');
      return response.$.success !== '0';
    })

    /**
     * Returns the exception breakpoint id.
     */
  }, {
    key: 'setExceptionBreakpoint',
    value: _asyncToGenerator(function* (exceptionName) {
      var response = yield this._callDebugger('breakpoint_set', '-t exception -x ' + exceptionName);
      if (response.error) {
        throw new Error('Error from setPausedOnExceptions: ' + JSON.stringify(response));
      }
      // TODO: Validate that response.$.state === 'enabled'
      return response.$.id;
    })

    /**
     * Returns a breakpoint id
     */
  }, {
    key: 'setBreakpoint',
    value: _asyncToGenerator(function* (filename, lineNumber) {
      var response = yield this._callDebugger('breakpoint_set', '-t line -f ' + filename + ' -n ' + lineNumber);
      if (response.error) {
        throw new Error('Error setting breakpoint: ' + JSON.stringify(response));
      }
      // TODO: Validate that response.$.state === 'enabled'
      return response.$.id;
    })
  }, {
    key: 'removeBreakpoint',
    value: _asyncToGenerator(function* (breakpointId) {
      var response = yield this._callDebugger('breakpoint_remove', '-d ' + breakpointId);
      if (response.error) {
        throw new Error('Error removing breakpoint: ' + JSON.stringify(response));
      }
    })

    // Sends command to hhvm.
    // Returns an object containing the resulting attributes.
  }, {
    key: '_callDebugger',
    value: function _callDebugger(command, params) {
      var _this2 = this;

      var transactionId = this._sendCommand(command, params);
      return new Promise(function (resolve, reject) {
        _this2._calls.set(transactionId, {
          command: command,
          complete: function complete(result) {
            return resolve(result);
          }
        });
      });
    }
  }, {
    key: '_sendCommand',
    value: function _sendCommand(command, params) {
      var id = ++this._transactionId;
      var message = command + ' -i ' + id;
      if (params) {
        message += ' ' + params;
      }
      this._sendMessage(message);
      return id;
    }
  }, {
    key: '_sendMessage',
    value: function _sendMessage(message) {
      if (this._socket) {
        log('Sending message: ' + message);
        this._socket.write(message + '\x00');
      } else {
        logError('Attempt to send message after dispose: ' + message);
      }
    }
  }, {
    key: '_emitStatus',
    value: function _emitStatus(status) {
      log('Emitting status: ' + status);
      this._emitter.emit(DBGP_SOCKET_STATUS_EVENT, status);
    }
  }, {
    key: 'dispose',
    value: function dispose() {
      if (!this._isClosed) {
        // TODO[jeffreytan]: workaround a crash(t8181538) in hhvm
        this.sendContinuationCommand(COMMAND_DETACH);
      }

      if (this._socket) {
        // end - Sends the FIN packet and closes writing.
        // destroy - closes for reading and writing.
        this._socket.end();
        this._socket.destroy();
        this._socket = null;
        this._isClosed = true;
      }
    }
  }]);

  return DbgpSocket;
})();

module.exports = {
  DbgpSocket: DbgpSocket,
  STATUS_STARTING: STATUS_STARTING,
  STATUS_STOPPING: STATUS_STOPPING,
  STATUS_STOPPED: STATUS_STOPPED,
  STATUS_RUNNING: STATUS_RUNNING,
  STATUS_BREAK: STATUS_BREAK,
  STATUS_ERROR: STATUS_ERROR,
  STATUS_END: STATUS_END,
  COMMAND_RUN: COMMAND_RUN,
  COMMAND_STEP_INTO: COMMAND_STEP_INTO,
  COMMAND_STEP_OVER: COMMAND_STEP_OVER,
  COMMAND_STEP_OUT: COMMAND_STEP_OUT,
  COMMAND_STOP: COMMAND_STOP,
  COMMAND_DETACH: COMMAND_DETACH
};

// array or object

// string

// Value if present, subject to encoding if present

// array or object members

// Maps from transactionId -> call
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL0RiZ3BTb2NrZXQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O2tDQWNnRSxzQkFBc0I7OztBQWR0RixXQUFXLENBQUM7Ozs7Ozs7Ozs7ZUFZWSxPQUFPLENBQUMsU0FBUyxDQUFDOztJQUFuQyxHQUFHLFlBQUgsR0FBRztJQUFFLFFBQVEsWUFBUixRQUFROztnQkFDRyxPQUFPLENBQUMsUUFBUSxDQUFDOztJQUFqQyxZQUFZLGFBQVosWUFBWTtBQU1uQixJQUFNLGVBQWUsR0FBRyxVQUFVLENBQUM7QUFDbkMsSUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFDO0FBQ25DLElBQU0sY0FBYyxHQUFHLFNBQVMsQ0FBQztBQUNqQyxJQUFNLGNBQWMsR0FBRyxTQUFTLENBQUM7QUFDakMsSUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDOztBQUU3QixJQUFNLFlBQVksR0FBRyxPQUFPLENBQUM7QUFDN0IsSUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDOzs7QUFHekIsSUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDO0FBQzFCLElBQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDO0FBQ3RDLElBQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDO0FBQ3RDLElBQU0sZ0JBQWdCLEdBQUcsVUFBVSxDQUFDO0FBQ3BDLElBQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQztBQUM1QixJQUFNLGNBQWMsR0FBRyxRQUFRLENBQUM7O0FBRWhDLElBQU0sd0JBQXdCLEdBQUcsb0JBQW9CLENBQUM7Ozs7Ozs7SUF5Q2hELFVBQVU7QUFTSCxXQVRQLFVBQVUsQ0FTRixNQUFjLEVBQUU7MEJBVHhCLFVBQVU7O0FBVVosUUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7QUFDdEIsUUFBSSxDQUFDLGNB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LG1CQUFTO0FBQ2QsVUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7O0FBRW5CLFlBQUksQ0FBQyx1QkFBdUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztPQUM5Qzs7QUFFRCxVQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7OztBQUdoQixZQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ25CLFlBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDdkIsWUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7QUFDcEIsWUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7T0FDdkI7S0FDRjs7O1NBbk9HLFVBQVU7OztBQXNPaEIsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNmLFlBQVUsRUFBVixVQUFVO0FBQ1YsaUJBQWUsRUFBZixlQUFlO0FBQ2YsaUJBQWUsRUFBZixlQUFlO0FBQ2YsZ0JBQWMsRUFBZCxjQUFjO0FBQ2QsZ0JBQWMsRUFBZCxjQUFjO0FBQ2QsY0FBWSxFQUFaLFlBQVk7QUFDWixjQUFZLEVBQVosWUFBWTtBQUNaLFlBQVUsRUFBVixVQUFVO0FBQ1YsYUFBVyxFQUFYLFdBQVc7QUFDWCxtQkFBaUIsRUFBakIsaUJBQWlCO0FBQ2pCLG1CQUFpQixFQUFqQixpQkFBaUI7QUFDakIsa0JBQWdCLEVBQWhCLGdCQUFnQjtBQUNoQixjQUFZLEVBQVosWUFBWTtBQUNaLGdCQUFjLEVBQWQsY0FBYztDQUNmLENBQUMiLCJmaWxlIjoiL3Zhci9mb2xkZXJzL3hmL3JzcGg0X2M1NzMxNXJzNTd4eHNkc2tyeG52MzZ0MC9UL3RtcHBmbDUybnB1Ymxpc2hfcGFja2FnZXMvbnBtL251Y2xpZGUtZGVidWdnZXItaGh2bS1wcm94eS9saWIvRGJncFNvY2tldC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cblxuY29uc3Qge2xvZywgbG9nRXJyb3J9ID0gcmVxdWlyZSgnLi91dGlscycpO1xuY29uc3Qge0V2ZW50RW1pdHRlcn0gPSByZXF1aXJlKCdldmVudHMnKTtcbmltcG9ydCB7RGJncE1lc3NhZ2VIYW5kbGVyLCBnZXREYmdwTWVzc2FnZUhhbmRsZXJJbnN0YW5jZX0gZnJvbSAnLi9EYmdwTWVzc2FnZUhhbmRsZXInO1xuaW1wb3J0IHR5cGUge0Rpc3Bvc2FibGV9IGZyb20gJ251Y2xpZGUtY29tbW9ucyc7XG5pbXBvcnQgdHlwZSB7U29ja2V0fSBmcm9tICduZXQnO1xuXG4vLyBSZXNwb25zZXMgdG8gdGhlIERCR1AgJ3N0YXR1cycgY29tbWFuZFxuY29uc3QgU1RBVFVTX1NUQVJUSU5HID0gJ3N0YXJ0aW5nJztcbmNvbnN0IFNUQVRVU19TVE9QUElORyA9ICdzdG9wcGluZyc7XG5jb25zdCBTVEFUVVNfU1RPUFBFRCA9ICdzdG9wcGVkJztcbmNvbnN0IFNUQVRVU19SVU5OSU5HID0gJ3J1bm5pbmcnO1xuY29uc3QgU1RBVFVTX0JSRUFLID0gJ2JyZWFrJztcbi8vIEVycm9yIGFuZCBFbmQgYXJlIG5vdCBkYmdwIHN0YXR1cyBjb2RlcywgdGhleSByZWxhdGUgdG8gc29ja2V0IHN0YXRlcy5cbmNvbnN0IFNUQVRVU19FUlJPUiA9ICdlcnJvcic7XG5jb25zdCBTVEFUVVNfRU5EID0gJ2VuZCc7XG5cbi8vIFZhbGlkIGNvbnRpbnVhdGlvbiBjb21tYW5kc1xuY29uc3QgQ09NTUFORF9SVU4gPSAncnVuJztcbmNvbnN0IENPTU1BTkRfU1RFUF9JTlRPID0gJ3N0ZXBfaW50byc7XG5jb25zdCBDT01NQU5EX1NURVBfT1ZFUiA9ICdzdGVwX292ZXInO1xuY29uc3QgQ09NTUFORF9TVEVQX09VVCA9ICdzdGVwX291dCc7XG5jb25zdCBDT01NQU5EX1NUT1AgPSAnc3RvcCc7XG5jb25zdCBDT01NQU5EX0RFVEFDSCA9ICdkZXRhY2gnO1xuXG5jb25zdCBEQkdQX1NPQ0tFVF9TVEFUVVNfRVZFTlQgPSAnZGJncC1zb2NrZXQtc3RhdHVzJztcblxudHlwZSBEYmdwQ29udGV4dCA9IHtcbiAgbmFtZTogc3RyaW5nO1xuICBpZDogc3RyaW5nO1xufTtcblxudHlwZSBEYmdwUHJvcGVydHkgPSB7XG4gICQ6IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgZnVsbG5hbWU6IHN0cmluZztcbiAgICBhZGRyZXNzOiBzdHJpbmc7XG4gICAgdHlwZTogc3RyaW5nO1xuXG4gICAgLy8gYXJyYXkgb3Igb2JqZWN0XG4gICAgY2hpbGRyZW4/OiBib29sZWFuO1xuICAgIG51bUNoaWxkcmVuPzogbnVtYmVyO1xuICAgIHBhZ2U/OiBudW1iZXI7XG4gICAgcGFnZXNpemU/OiBudW1iZXI7XG5cbiAgICAvLyBzdHJpbmdcbiAgICBzaXplPzogbnVtYmVyO1xuICAgIGVuY29kaW5nPzogc3RyaW5nO1xuICB9O1xuXG4gIC8vIFZhbHVlIGlmIHByZXNlbnQsIHN1YmplY3QgdG8gZW5jb2RpbmcgaWYgcHJlc2VudFxuICBfPzogc3RyaW5nO1xuXG4gIC8vIGFycmF5IG9yIG9iamVjdCBtZW1iZXJzXG4gIHByb3BlcnR5PzogQXJyYXk8RGJncFByb3BlcnR5Pjtcbn07XG5cbnR5cGUgRXZhbHVhdGlvblJlc3VsdCA9IHtcbiAgcmVzdWx0OiA/RGJncFByb3BlcnR5O1xuICB3YXNUaHJvd246IGJvb2xlYW47XG59O1xuXG4vKipcbiAqIEhhbmRsZXMgc2VuZGluZyBhbmQgcmVjaWV2aW5nIGRiZ3AgbWVzc2FnZXMgb3ZlciBhIG5ldCBTb2NrZXQuXG4gKiBEYmdwIGRvY3VtZW50YXRpb24gY2FuIGJlIGZvdW5kIGF0IGh0dHA6Ly94ZGVidWcub3JnL2RvY3MtZGJncC5waHBcbiAqL1xuY2xhc3MgRGJncFNvY2tldCB7XG4gIF9zb2NrZXQ6ID9Tb2NrZXQ7XG4gIF90cmFuc2FjdGlvbklkOiBudW1iZXI7XG4gIC8vIE1hcHMgZnJvbSB0cmFuc2FjdGlvbklkIC0+IGNhbGxcbiAgX2NhbGxzOiBNYXA8bnVtYmVyLCB7Y29tbWFuZDogc3RyaW5nOyBjb21wbGV0ZTogKHJlc3VsdHM6IE9iamVjdCkgPT4gdm9pZH0+O1xuICBfZW1pdHRlcjogRXZlbnRFbWl0dGVyO1xuICBfaXNDbG9zZWQ6IGJvb2xlYW47XG4gIF9tZXNzYWdlSGFuZGxlcjogRGJncE1lc3NhZ2VIYW5kbGVyO1xuXG4gIGNvbnN0cnVjdG9yKHNvY2tldDogU29ja2V0KSB7XG4gICAgdGhpcy5fc29ja2V0ID0gc29ja2V0O1xuICAgIHRoaXMuX3RyYW5zYWN0aW9uSWQgPSAwO1xuICAgIHRoaXMuX2NhbGxzID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuX2VtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgdGhpcy5faXNDbG9zZWQgPSBmYWxzZTtcbiAgICB0aGlzLl9tZXNzYWdlSGFuZGxlciA9IGdldERiZ3BNZXNzYWdlSGFuZGxlckluc3RhbmNlKCk7XG5cbiAgICB0aGlzLl9zb2NrZXQub24oJ2VuZCcsIHRoaXMuX29uRW5kLmJpbmQodGhpcykpO1xuICAgIHRoaXMuX3NvY2tldC5vbignZXJyb3InLCB0aGlzLl9vbkVycm9yLmJpbmQodGhpcykpO1xuICAgIHRoaXMuX3NvY2tldC5vbignZGF0YScsIHRoaXMuX29uRGF0YS5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIG9uU3RhdHVzKGNhbGxiYWNrOiAoc3RhdHVzOiBzdHJpbmcpID0+IG1peGVkKTogRGlzcG9zYWJsZSB7XG4gICAgcmV0dXJuIHJlcXVpcmUoJ251Y2xpZGUtY29tbW9ucycpLmV2ZW50LmF0dGFjaEV2ZW50KHRoaXMuX2VtaXR0ZXIsIERCR1BfU09DS0VUX1NUQVRVU19FVkVOVCwgY2FsbGJhY2spO1xuICB9XG5cbiAgX29uRXJyb3IoZXJyb3I6IEVycm9yKTogdm9pZCB7XG4gICAgLy8gTm90IHN1cmUgaWYgaGh2bSBpcyBhbGl2ZSBvciBub3RcbiAgICAvLyBkbyBub3Qgc2V0IF9pc0Nsb3NlZCBmbGFnIHNvIHRoYXQgZGV0YWNoIHdpbGwgYmUgc2VudCBiZWZvcmUgZGlzcG9zZSgpLlxuICAgIGxvZ0Vycm9yKCdzb2NrZXQgZXJyb3IgJyArIGVycm9yLmNvZGUpO1xuICAgIHRoaXMuX2VtaXRTdGF0dXMoU1RBVFVTX0VSUk9SKTtcbiAgfVxuXG4gIF9vbkVuZCgpOiB2b2lkIHtcbiAgICB0aGlzLl9pc0Nsb3NlZCA9IHRydWU7XG4gICAgdGhpcy5kaXNwb3NlKCk7XG4gICAgdGhpcy5fZW1pdFN0YXR1cyhTVEFUVVNfRU5EKTtcbiAgfVxuXG4gIF9vbkRhdGEoZGF0YTogQnVmZmVyIHwgc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgbWVzc2FnZSA9IGRhdGEudG9TdHJpbmcoKTtcbiAgICBsb2coJ1JlY2lldmVkIGRhdGE6ICcgKyBtZXNzYWdlKTtcbiAgICBjb25zdCByZXNwb25zZXMgPSB0aGlzLl9tZXNzYWdlSGFuZGxlci5wYXJzZU1lc3NhZ2VzKG1lc3NhZ2UpO1xuICAgIHJlc3BvbnNlcy5mb3JFYWNoKHIgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSByLnJlc3BvbnNlO1xuICAgICAgaWYgKHJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlQXR0cmlidXRlcyA9IHJlc3BvbnNlLiQ7XG4gICAgICAgIGNvbnN0IHtjb21tYW5kLCB0cmFuc2FjdGlvbl9pZH0gPSByZXNwb25zZUF0dHJpYnV0ZXM7XG4gICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uSWQgPSBOdW1iZXIodHJhbnNhY3Rpb25faWQpO1xuICAgICAgICBjb25zdCBjYWxsID0gdGhpcy5fY2FsbHMuZ2V0KHRyYW5zYWN0aW9uSWQpO1xuICAgICAgICBpZiAoIWNhbGwpIHtcbiAgICAgICAgICBsb2dFcnJvcignTWlzc2luZyBjYWxsIGZvciByZXNwb25zZTogJyArIG1lc3NhZ2UpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9jYWxscy5kZWxldGUodHJhbnNhY3Rpb25JZCk7XG5cbiAgICAgICAgaWYgKGNhbGwuY29tbWFuZCAhPT0gY29tbWFuZCkge1xuICAgICAgICAgIGxvZ0Vycm9yKCdCYWQgY29tbWFuZCBpbiByZXNwb25zZS4gRm91bmQgJyArIGNvbW1hbmQgKyAnLiBleHBlY3RlZCAnICsgY2FsbC5jb21tYW5kKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBsb2coJ0NvbXBsZXRpbmcgY2FsbDogJyArIG1lc3NhZ2UpO1xuICAgICAgICAgIGNhbGwuY29tcGxldGUocmVzcG9uc2UpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgbG9nRXJyb3IoJ0V4Y2VwdGlvbjogJyArIGUudG9TdHJpbmcoKSArICcgaGFuZGxpbmcgY2FsbDogJyArIG1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dFcnJvcignVW5leHBlY3RlZCBzb2NrZXQgbWVzc2FnZTogJyArIG1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0U3RhY2tGcmFtZXMoKTogUHJvbWlzZTxBcnJheTxPYmplY3Q+PiB7XG4gICAgcmV0dXJuIHRoaXMuX2NhbGxEZWJ1Z2dlcignc3RhY2tfZ2V0Jyk7XG4gIH1cblxuICBhc3luYyBnZXRDb250ZXh0c0ZvckZyYW1lKGZyYW1lSW5kZXg6IG51bWJlcik6IFByb21pc2U8QXJyYXk8RGJncENvbnRleHQ+PiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5fY2FsbERlYnVnZ2VyKCdjb250ZXh0X25hbWVzJywgYC1kICR7ZnJhbWVJbmRleH1gKTtcbiAgICByZXR1cm4gcmVzdWx0LmNvbnRleHQubWFwKGNvbnRleHQgPT4gY29udGV4dC4kKTtcbiAgfVxuXG4gIGFzeW5jIGdldENvbnRleHRQcm9wZXJ0aWVzKGZyYW1lSW5kZXg6IG51bWJlciwgY29udGV4dElkOiBzdHJpbmcpOiBQcm9taXNlPEFycmF5PERiZ3BQcm9wZXJ0eT4+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLl9jYWxsRGVidWdnZXIoJ2NvbnRleHRfZ2V0JywgYC1kICR7ZnJhbWVJbmRleH0gLWMgJHtjb250ZXh0SWR9YCk7XG4gICAgLy8gMCByZXN1bHRzIHlpZWxkcyBtaXNzaW5nICdwcm9wZXJ0eScgbWVtYmVyXG4gICAgcmV0dXJuIHJlc3VsdC5wcm9wZXJ0eSB8fCBbXTtcbiAgfVxuXG4gIGFzeW5jIGdldFByb3BlcnRpZXNCeUZ1bGxuYW1lKGZyYW1lSW5kZXg6IG51bWJlciwgY29udGV4dElkOiBzdHJpbmcsIGZ1bGxuYW1lOiBzdHJpbmcsXG4gICAgICBwYWdlOiBudW1iZXIpOiBQcm9taXNlPEFycmF5PERiZ3BQcm9wZXJ0eT4+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLl9jYWxsRGVidWdnZXIoXG4gICAgICAncHJvcGVydHlfdmFsdWUnLCBgLWQgJHtmcmFtZUluZGV4fSAtYyAke2NvbnRleHRJZH0gLW4gJHtmdWxsbmFtZX0gLXAgJHtwYWdlfWApO1xuICAgIC8vIHByb3BlcnR5X3ZhbHVlIHJldHVybnMgdGhlIG91dGVyIHByb3BlcnR5LCB3ZSB3YW50IHRoZSBjaGlsZHJlbiAuLi5cbiAgICAvLyAwIHJlc3VsdHMgeWllbGRzIG1pc3NpbmcgJ3Byb3BlcnR5JyBtZW1iZXJcbiAgICByZXR1cm4gcmVzdWx0LnByb3BlcnR5WzBdLnByb3BlcnR5IHx8IFtdO1xuICB9XG5cbiAgYXN5bmMgZ2V0UHJvcGVydGllc0J5RnVsbG5hbWVBbGxDb25leHRzKGZyYW1lSW5kZXg6IG51bWJlciwgZnVsbG5hbWU6IHN0cmluZyxcbiAgICAgIHBhZ2U6IG51bWJlcik6IFByb21pc2U8QXJyYXk8RGJncFByb3BlcnR5Pj4ge1xuICAgIC8vIFBhc3MgemVybyBhcyBjb250ZXh0SWQgdG8gc2VhcmNoIGFsbCBjb250ZXh0cy5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRQcm9wZXJ0aWVzQnlGdWxsbmFtZShmcmFtZUluZGV4LCAvKmNvbnRleHRJZCovJzAnLCBmdWxsbmFtZSwgcGFnZSk7XG4gIH1cblxuICBhc3luYyBldmFsdWF0ZU9uQ2FsbEZyYW1lKGZyYW1lSW5kZXg6IG51bWJlciwgZXhwcmVzc2lvbjogc3RyaW5nKTogUHJvbWlzZTxFdmFsdWF0aW9uUmVzdWx0PiB7XG4gICAgLy8gRXNjYXBlIGFueSBkb3VibGUgcXVvdGUgaW4gdGhlIGV4cHJlc3Npb24uXG4gICAgY29uc3QgZXNjYXBlZEV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2UoL1wiL2csICdcXFxcXCInKTtcbiAgICAvLyBRdW90ZSB0aGUgaW5wdXQgZXhwcmVzc2lvbiBzbyB0aGF0IHdlIGNhbiBzdXBwb3J0IGV4cHJlc3Npb24gd2l0aFxuICAgIC8vIHNwYWNlIGluIGl0KGUuZy4gZnVuY3Rpb24gZXZhbHVhdGlvbikuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5fY2FsbERlYnVnZ2VyKFxuICAgICAgJ3Byb3BlcnR5X3ZhbHVlJyxcbiAgICAgIGAtZCAke2ZyYW1lSW5kZXh9IC1uIFwiJHtlc2NhcGVkRXhwcmVzc2lvbn1cImBcbiAgICApO1xuICAgIGlmIChyZXN1bHQuZXJyb3IgJiYgcmVzdWx0LmVycm9yLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGVycm9yOiByZXN1bHQuZXJyb3JbMF0sXG4gICAgICAgIHdhc1Rocm93bjogdHJ1ZSxcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICByZXN1bHQ6IHJlc3VsdC5wcm9wZXJ0eVswXSB8fCBbXSxcbiAgICAgIHdhc1Rocm93bjogZmFsc2UsXG4gICAgfTtcbiAgfVxuXG4gIC8vIFJldHVybnMgb25lIG9mOlxuICAvLyAgc3RhcnRpbmcsIHN0b3BwaW5nLCBzdG9wcGVkLCBydW5uaW5nLCBicmVha1xuICBhc3luYyBnZXRTdGF0dXMoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuX2NhbGxEZWJ1Z2dlcignc3RhdHVzJyk7XG4gICAgLy8gVE9ETzogRG8gd2UgZXZlciBjYXJlIGFib3V0IHJlc3BvbnNlLiQucmVhc29uP1xuICAgIHJldHVybiByZXNwb25zZS4kLnN0YXR1cztcbiAgfVxuXG4gIC8vIENvbnRpbnVhdGlvbiBjb21tYW5kcyBnZXQgYSByZXNwb25zZSwgYnV0IHRoYXQgcmVzcG9uc2VcbiAgLy8gaXMgYSBzdGF0dXMgbWVzc2FnZSB3aGljaCBvY2N1cnMgYWZ0ZXIgZXhlY3V0aW9uIHN0b3BzLlxuICBhc3luYyBzZW5kQ29udGludWF0aW9uQ29tbWFuZChjb21tYW5kOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHRoaXMuX2VtaXRTdGF0dXMoU1RBVFVTX1JVTk5JTkcpO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5fY2FsbERlYnVnZ2VyKGNvbW1hbmQpO1xuICAgIGNvbnN0IHN0YXR1cyA9IHJlc3BvbnNlLiQuc3RhdHVzO1xuICAgIHRoaXMuX2VtaXRTdGF0dXMoc3RhdHVzKTtcbiAgICByZXR1cm4gc3RhdHVzO1xuICB9XG5cbiAgYXN5bmMgc2VuZEJyZWFrQ29tbWFuZCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuX2NhbGxEZWJ1Z2dlcignYnJlYWsnKTtcbiAgICByZXR1cm4gcmVzcG9uc2UuJC5zdWNjZXNzICE9PSAnMCc7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZXhjZXB0aW9uIGJyZWFrcG9pbnQgaWQuXG4gICAqL1xuICBhc3luYyBzZXRFeGNlcHRpb25CcmVha3BvaW50KGV4Y2VwdGlvbk5hbWU6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9jYWxsRGVidWdnZXIoJ2JyZWFrcG9pbnRfc2V0JywgYC10IGV4Y2VwdGlvbiAteCAke2V4Y2VwdGlvbk5hbWV9YCk7XG4gICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yIGZyb20gc2V0UGF1c2VkT25FeGNlcHRpb25zOiAnICsgSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcbiAgICB9XG4gICAgLy8gVE9ETzogVmFsaWRhdGUgdGhhdCByZXNwb25zZS4kLnN0YXRlID09PSAnZW5hYmxlZCdcbiAgICByZXR1cm4gcmVzcG9uc2UuJC5pZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgYnJlYWtwb2ludCBpZFxuICAgKi9cbiAgYXN5bmMgc2V0QnJlYWtwb2ludChmaWxlbmFtZTogc3RyaW5nLCBsaW5lTnVtYmVyOiBudW1iZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5fY2FsbERlYnVnZ2VyKCdicmVha3BvaW50X3NldCcsIGAtdCBsaW5lIC1mICR7ZmlsZW5hbWV9IC1uICR7bGluZU51bWJlcn1gKTtcbiAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRXJyb3Igc2V0dGluZyBicmVha3BvaW50OiAnICsgSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcbiAgICB9XG4gICAgLy8gVE9ETzogVmFsaWRhdGUgdGhhdCByZXNwb25zZS4kLnN0YXRlID09PSAnZW5hYmxlZCdcbiAgICByZXR1cm4gcmVzcG9uc2UuJC5pZDtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUJyZWFrcG9pbnQoYnJlYWtwb2ludElkOiBzdHJpbmcpOiBQcm9taXNlIHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuX2NhbGxEZWJ1Z2dlcignYnJlYWtwb2ludF9yZW1vdmUnLCBgLWQgJHticmVha3BvaW50SWR9YCk7XG4gICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yIHJlbW92aW5nIGJyZWFrcG9pbnQ6ICcgKyBKU09OLnN0cmluZ2lmeShyZXNwb25zZSkpO1xuICAgIH1cbiAgfVxuXG4gIC8vIFNlbmRzIGNvbW1hbmQgdG8gaGh2bS5cbiAgLy8gUmV0dXJucyBhbiBvYmplY3QgY29udGFpbmluZyB0aGUgcmVzdWx0aW5nIGF0dHJpYnV0ZXMuXG4gIF9jYWxsRGVidWdnZXIoY29tbWFuZDogc3RyaW5nLCBwYXJhbXM6ID9zdHJpbmcpOiBQcm9taXNlPE9iamVjdD4ge1xuICAgIGNvbnN0IHRyYW5zYWN0aW9uSWQgPSB0aGlzLl9zZW5kQ29tbWFuZChjb21tYW5kLCBwYXJhbXMpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLl9jYWxscy5zZXQodHJhbnNhY3Rpb25JZCwge1xuICAgICAgICBjb21tYW5kLFxuICAgICAgICBjb21wbGV0ZTogcmVzdWx0ID0+IHJlc29sdmUocmVzdWx0KSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgX3NlbmRDb21tYW5kKGNvbW1hbmQ6IHN0cmluZywgcGFyYW1zOiA/c3RyaW5nKTogbnVtYmVyIHtcbiAgICBjb25zdCBpZCA9ICsrdGhpcy5fdHJhbnNhY3Rpb25JZDtcbiAgICBsZXQgbWVzc2FnZSA9IGAke2NvbW1hbmR9IC1pICR7aWR9YDtcbiAgICBpZiAocGFyYW1zKSB7XG4gICAgICBtZXNzYWdlICs9ICcgJyArIHBhcmFtcztcbiAgICB9XG4gICAgdGhpcy5fc2VuZE1lc3NhZ2UobWVzc2FnZSk7XG4gICAgcmV0dXJuIGlkO1xuICB9XG5cbiAgX3NlbmRNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9zb2NrZXQpIHtcbiAgICAgIGxvZygnU2VuZGluZyBtZXNzYWdlOiAnICsgbWVzc2FnZSk7XG4gICAgICB0aGlzLl9zb2NrZXQud3JpdGUobWVzc2FnZSArICdcXHgwMCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dFcnJvcignQXR0ZW1wdCB0byBzZW5kIG1lc3NhZ2UgYWZ0ZXIgZGlzcG9zZTogJyArIG1lc3NhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIF9lbWl0U3RhdHVzKHN0YXR1czogc3RyaW5nKTogdm9pZCB7XG4gICAgbG9nKCdFbWl0dGluZyBzdGF0dXM6ICcgKyBzdGF0dXMpO1xuICAgIHRoaXMuX2VtaXR0ZXIuZW1pdChEQkdQX1NPQ0tFVF9TVEFUVVNfRVZFTlQsIHN0YXR1cyk7XG4gIH1cblxuICBkaXNwb3NlKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5faXNDbG9zZWQpIHtcbiAgICAgIC8vIFRPRE9bamVmZnJleXRhbl06IHdvcmthcm91bmQgYSBjcmFzaCh0ODE4MTUzOCkgaW4gaGh2bVxuICAgICAgdGhpcy5zZW5kQ29udGludWF0aW9uQ29tbWFuZChDT01NQU5EX0RFVEFDSCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX3NvY2tldCkge1xuICAgICAgLy8gZW5kIC0gU2VuZHMgdGhlIEZJTiBwYWNrZXQgYW5kIGNsb3NlcyB3cml0aW5nLlxuICAgICAgLy8gZGVzdHJveSAtIGNsb3NlcyBmb3IgcmVhZGluZyBhbmQgd3JpdGluZy5cbiAgICAgIHRoaXMuX3NvY2tldC5lbmQoKTtcbiAgICAgIHRoaXMuX3NvY2tldC5kZXN0cm95KCk7XG4gICAgICB0aGlzLl9zb2NrZXQgPSBudWxsO1xuICAgICAgdGhpcy5faXNDbG9zZWQgPSB0cnVlO1xuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgRGJncFNvY2tldCxcbiAgU1RBVFVTX1NUQVJUSU5HLFxuICBTVEFUVVNfU1RPUFBJTkcsXG4gIFNUQVRVU19TVE9QUEVELFxuICBTVEFUVVNfUlVOTklORyxcbiAgU1RBVFVTX0JSRUFLLFxuICBTVEFUVVNfRVJST1IsXG4gIFNUQVRVU19FTkQsXG4gIENPTU1BTkRfUlVOLFxuICBDT01NQU5EX1NURVBfSU5UTyxcbiAgQ09NTUFORF9TVEVQX09WRVIsXG4gIENPTU1BTkRfU1RFUF9PVVQsXG4gIENPTU1BTkRfU1RPUCxcbiAgQ09NTUFORF9ERVRBQ0gsXG59O1xuIl19
