Object.defineProperty(exports, '__esModule', {
  value: true
});

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

'use babel';

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _require = require('./utils');

var log = _require.log;
var logErrorAndThrow = _require.logErrorAndThrow;

var _require2 = require('./ObjectId');

var remoteObjectIdOfObjectId = _require2.remoteObjectIdOfObjectId;
var createContextObjectId = _require2.createContextObjectId;
var isContextObjectId = _require2.isContextObjectId;
var isPagedObjectId = _require2.isPagedObjectId;
var getWatchContextObjectId = _require2.getWatchContextObjectId;
var isWatchContextObjectId = _require2.isWatchContextObjectId;

var _require3 = require('./properties.js');

var convertProperties = _require3.convertProperties;
var getPagedProperties = _require3.getPagedProperties;

var _require4 = require('./values.js');

var convertValue = _require4.convertValue;

// TODO: Move these Chrome types to a shared package.

// description wins over value in display

// scope.object.description shows on RHS
// [ "catch" , "closure" , "global" , "local" , "with" ]

var _require5 = require('./DbgpSocket');

var STATUS_BREAK = _require5.STATUS_BREAK;

/**
 * Handles data value tracking between Chrome and Dbgp.
 *
 * Maps Dbgp properties to/from Chrome RemoteObjects.
 * RemoteObjects are only valid while the debuggee is paused.
 * Once the debuggee resumes, all RemoteObjects become invalid.
 */

var DataCache = (function () {
  function DataCache(socket) {
    _classCallCheck(this, DataCache);

    this._socket = socket;
    this._enableCount = 0;
    this._enabled = false;
    socket.onStatus(this._onStatusChanged.bind(this));
  }

  _createClass(DataCache, [{
    key: '_onStatusChanged',
    value: function _onStatusChanged(status) {
      switch (status) {
        case STATUS_BREAK:
          this._enable();
          break;
        default:
          this._disable();
          break;
      }
    }
  }, {
    key: '_disable',
    value: function _disable() {
      this._enabled = false;
    }
  }, {
    key: 'isEnabled',
    value: function isEnabled() {
      return this._enabled;
    }
  }, {
    key: '_enable',
    value: function _enable() {
      this._enableCount += 1;
      this._enabled = true;
    }
  }, {
    key: 'getScopesForFrame',
    value: _asyncToGenerator(function* (frameIndex) {
      var _this = this;

      if (!this.isEnabled()) {
        throw new Error('Must be enabled to get scopes.');
      }
      var contexts = yield this._socket.getContextsForFrame(frameIndex);
      return contexts.map(function (context) {
        return {
          object: _this._remoteObjectOfContext(frameIndex, context),
          type: contextNameToScopeType(context.name)
        };
      });
    })
  }, {
    key: 'evaluateOnCallFrame',
    value: _asyncToGenerator(function* (frameIndex, expression) {
      if (!this.isEnabled()) {
        throw new Error('Must be enabled to evaluate expression.');
      }

      var evaluatedResult = yield this._socket.evaluateOnCallFrame(frameIndex, expression);
      if (evaluatedResult.wasThrown) {
        return evaluatedResult;
      }
      var id = getWatchContextObjectId(this._enableCount, frameIndex);
      var result = convertValue(id, evaluatedResult.result);
      return {
        result: result,
        wasThrown: false
      };
    })
  }, {
    key: '_remoteObjectOfContext',
    value: function _remoteObjectOfContext(frameIndex, context) {
      return {
        description: context.name,
        type: 'object',
        objectId: remoteObjectIdOfObjectId(this._objectIdOfContext(frameIndex, context))
      };
    }
  }, {
    key: '_objectIdOfContext',
    value: function _objectIdOfContext(frameIndex, context) {
      return createContextObjectId(this._enableCount, frameIndex, context.id);
    }
  }, {
    key: 'getProperties',
    value: _asyncToGenerator(function* (remoteId) {
      var id = JSON.parse(remoteId);
      if (id.enableCount !== this._enableCount) {
        logErrorAndThrow('Got request for stale RemoteObjectId ' + remoteId);
      }

      // context and single paged ids require getting children from the debuggee and converting
      // them from dbgp to chrome format.
      if (isContextObjectId(id)) {
        return yield this._getContextProperties(id);
      } else if (isPagedObjectId(id)) {
        // Paged id's children are constructed directly in chrome format from the contents of the
        // object id. Does not require going to the debuggee.
        return getPagedProperties(id);
      } else {
        return yield this._getSinglePageOfProperties(id);
      }
    })
  }, {
    key: '_getSinglePageOfProperties',
    value: _asyncToGenerator(function* (id) {
      var properties = null;
      if (isWatchContextObjectId(id)) {
        properties = yield this._socket.getPropertiesByFullnameAllConexts(id.frameIndex, id.fullname, id.page);
      } else {
        properties = yield this._socket.getPropertiesByFullname(id.frameIndex, id.contextId, id.fullname, id.page);
      }
      return convertProperties(id, properties);
    })
  }, {
    key: '_getContextProperties',
    value: _asyncToGenerator(function* (id) {
      var properties = yield this._socket.getContextProperties(id.frameIndex, id.contextId);
      return convertProperties(id, properties);
    })
  }]);

  return DataCache;
})();

exports.DataCache = DataCache;

function contextNameToScopeType(name) {
  switch (name) {
    case 'Locals':
      return 'local';
    case 'Superglobals':
      return 'global';
    case 'User defined constants':
      return 'global';
    // TODO: Verify this ...
    default:
      log('Unexpected context name: ' + name);
      return 'closure';
  }
}
// [ "array" , "date" , "node" , "null" , "regexp" ]
// [ "boolean" , "function" , "number" , "object" , "string" , "undefined" ]
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL0RhdGFDYWNoZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsV0FBVyxDQUFDOzs7Ozs7Ozs7O2VBWW9CLE9BQU8sQ0FBQyxTQUFTLENBQUM7O0lBQTNDLEdBQUcsWUFBSCxHQUFHO0lBQUUsZ0JBQWdCLFlBQWhCLGdCQUFnQjs7Z0JBUXhCLE9BQU8sQ0FBQyxZQUFZLENBQUM7O0lBTnZCLHdCQUF3QixhQUF4Qix3QkFBd0I7SUFDeEIscUJBQXFCLGFBQXJCLHFCQUFxQjtJQUNyQixpQkFBaUIsYUFBakIsaUJBQWlCO0lBQ2pCLGVBQWUsYUFBZixlQUFlO0lBQ2YsdUJBQXVCLGFBQXZCLHVCQUF1QjtJQUN2QixzQkFBc0IsYUFBdEIsc0JBQXNCOztnQkFNcEIsT0FBTyxDQUFDLGlCQUFpQixDQUFDOztJQUY1QixpQkFBaUIsYUFBakIsaUJBQWlCO0lBQ2pCLGtCQUFrQixhQUFsQixrQkFBa0I7O2dCQUdHLE9BQU8sQ0FBQyxhQUFhLENBQUM7O0lBQXRDLFlBQVksYUFBWixZQUFZOzs7Ozs7Ozs7Z0JBa0NJLE9BQU8sQ0FBQyxjQUFjLENBQUM7O0lBQXZDLFlBQVksYUFBWixZQUFZOzs7Ozs7Ozs7O0lBU04sU0FBUztBQUtULFdBTEEsU0FBUyxDQUtSLE1BQWtCLEVBQUU7MEJBTHJCLFNBQVM7O0FBTWxCLFFBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO0FBQ3RCLFFBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ3RCLFFBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO0FBQ3RCLFVBQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0dB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QUEsQUFDbEIsU0FBSyx3QkFBd0I7QUFDM0IsYUFBTyxRQUFRLENBQUM7QUFBQTtBQUVsQjtBQUNFLFNBQUcsK0JBQTZCLElBQUksQ0FBRyxDQUFDO0FBQ3hDLGFBQU8sU0FBUyxDQUFDO0FBQUEsR0FDcEI7Q0FDRiIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wcGZsNTJucHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1kZWJ1Z2dlci1oaHZtLXByb3h5L2xpYi9EYXRhQ2FjaGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG5cbmNvbnN0IHtsb2csIGxvZ0Vycm9yQW5kVGhyb3d9ID0gcmVxdWlyZSgnLi91dGlscycpO1xuY29uc3Qge1xuICByZW1vdGVPYmplY3RJZE9mT2JqZWN0SWQsXG4gIGNyZWF0ZUNvbnRleHRPYmplY3RJZCxcbiAgaXNDb250ZXh0T2JqZWN0SWQsXG4gIGlzUGFnZWRPYmplY3RJZCxcbiAgZ2V0V2F0Y2hDb250ZXh0T2JqZWN0SWQsXG4gIGlzV2F0Y2hDb250ZXh0T2JqZWN0SWQsXG59ID0gcmVxdWlyZSgnLi9PYmplY3RJZCcpO1xuXG5jb25zdCB7XG4gIGNvbnZlcnRQcm9wZXJ0aWVzLFxuICBnZXRQYWdlZFByb3BlcnRpZXMsXG59ID0gcmVxdWlyZSgnLi9wcm9wZXJ0aWVzLmpzJyk7XG5cbmNvbnN0IHtjb252ZXJ0VmFsdWV9ID0gcmVxdWlyZSgnLi92YWx1ZXMuanMnKTtcblxuLy8gVE9ETzogTW92ZSB0aGVzZSBDaHJvbWUgdHlwZXMgdG8gYSBzaGFyZWQgcGFja2FnZS5cbnR5cGUgUmVtb3RlT2JqZWN0SWQgPSBzdHJpbmc7XG5cbi8vIGRlc2NyaXB0aW9uIHdpbnMgb3ZlciB2YWx1ZSBpbiBkaXNwbGF5XG50eXBlIFJlbW90ZU9iamVjdCA9IHtcbiAgY2xhc3NOYW1lPzogc3RyaW5nO1xuICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgb2JqZWN0SWQ/OiBSZW1vdGVPYmplY3RJZDtcbiAgc3VidHlwZT86IHN0cmluZzsgLy8gWyBcImFycmF5XCIgLCBcImRhdGVcIiAsIFwibm9kZVwiICwgXCJudWxsXCIgLCBcInJlZ2V4cFwiIF1cbiAgdHlwZTogc3RyaW5nOyAvLyBbIFwiYm9vbGVhblwiICwgXCJmdW5jdGlvblwiICwgXCJudW1iZXJcIiAsIFwib2JqZWN0XCIgLCBcInN0cmluZ1wiICwgXCJ1bmRlZmluZWRcIiBdXG4gIHZhbHVlPzogYW55O1xufTtcblxuLy8gc2NvcGUub2JqZWN0LmRlc2NyaXB0aW9uIHNob3dzIG9uIFJIU1xudHlwZSBTY29wZSA9IHtcbiAgb2JqZWN0OiBSZW1vdGVPYmplY3Q7XG4gIHR5cGU6IHN0cmluZzsgLy8gWyBcImNhdGNoXCIgLCBcImNsb3N1cmVcIiAsIFwiZ2xvYmFsXCIgLCBcImxvY2FsXCIgLCBcIndpdGhcIiBdXG59O1xuXG50eXBlIFByb3BlcnR5RGVzY3JpcHRvciA9IHtcbiAgY29uZmlndXJhYmxlOiBib29sZWFuO1xuICBlbnVtZXJhYmxlOiBib29sZWFuO1xuICBnZXQ/OiBSZW1vdGVPYmplY3Q7XG4gIG5hbWU6IHN0cmluZztcbiAgc2V0PzogUmVtb3RlT2JqZWN0O1xuICB2YWx1ZT86IFJlbW90ZU9iamVjdDtcbiAgd2FzVGhyb3duPzogYm9vbGVhbjtcbiAgd3JpdGFibGU/OiBib29sZWFuO1xufTtcblxuaW1wb3J0IHR5cGUge0RiZ3BTb2NrZXR9IGZyb20gJy4vRGJncFNvY2tldCc7XG5cbmNvbnN0IHtTVEFUVVNfQlJFQUt9ID0gcmVxdWlyZSgnLi9EYmdwU29ja2V0Jyk7XG5cbi8qKlxuICogSGFuZGxlcyBkYXRhIHZhbHVlIHRyYWNraW5nIGJldHdlZW4gQ2hyb21lIGFuZCBEYmdwLlxuICpcbiAqIE1hcHMgRGJncCBwcm9wZXJ0aWVzIHRvL2Zyb20gQ2hyb21lIFJlbW90ZU9iamVjdHMuXG4gKiBSZW1vdGVPYmplY3RzIGFyZSBvbmx5IHZhbGlkIHdoaWxlIHRoZSBkZWJ1Z2dlZSBpcyBwYXVzZWQuXG4gKiBPbmNlIHRoZSBkZWJ1Z2dlZSByZXN1bWVzLCBhbGwgUmVtb3RlT2JqZWN0cyBiZWNvbWUgaW52YWxpZC5cbiAqL1xuZXhwb3J0IGNsYXNzIERhdGFDYWNoZSB7XG4gIF9zb2NrZXQ6IERiZ3BTb2NrZXQ7XG4gIF9lbmFibGVkOiBib29sZWFuO1xuICBfZW5hYmxlQ291bnQ6IG51bWJlcjtcblxuICBjb25zdHJ1Y3Rvcihzb2NrZXQ6IERiZ3BTb2NrZXQpIHtcbiAgICB0aGlzLl9zb2NrZXQgPSBzb2NrZXQ7XG4gICAgdGhpcy5fZW5hYmxlQ291bnQgPSAwO1xuICAgIHRoaXMuX2VuYWJsZWQgPSBmYWxzZTtcbiAgICBzb2NrZXQub25TdGF0dXModGhpcy5fb25TdGF0dXNDaGFuZ2VkLmJpbmQodGhpcykpO1xuICB9XG5cbiAgX29uU3RhdHVzQ2hhbmdlZChzdGF0dXM6IHN0cmluZyk6IHZvaWQge1xuICAgIHN3aXRjaCAoc3RhdHVzKSB7XG4gICAgICBjYXNlIFNUQVRVU19CUkVBSzpcbiAgICAgICAgdGhpcy5fZW5hYmxlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhpcy5fZGlzYWJsZSgpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBfZGlzYWJsZSgpOiB2b2lkIHtcbiAgICB0aGlzLl9lbmFibGVkID0gZmFsc2U7XG4gIH1cblxuICBpc0VuYWJsZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2VuYWJsZWQ7XG4gIH1cblxuICBfZW5hYmxlKCk6IHZvaWQge1xuICAgIHRoaXMuX2VuYWJsZUNvdW50ICs9IDE7XG4gICAgdGhpcy5fZW5hYmxlZCA9IHRydWU7XG4gIH1cblxuICBhc3luYyBnZXRTY29wZXNGb3JGcmFtZShmcmFtZUluZGV4OiBudW1iZXIpOiBQcm9taXNlPFNjb3BlPiB7XG4gICAgaWYgKCF0aGlzLmlzRW5hYmxlZCgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgYmUgZW5hYmxlZCB0byBnZXQgc2NvcGVzLicpO1xuICAgIH1cbiAgICBjb25zdCBjb250ZXh0cyA9IGF3YWl0IHRoaXMuX3NvY2tldC5nZXRDb250ZXh0c0ZvckZyYW1lKGZyYW1lSW5kZXgpO1xuICAgIHJldHVybiBjb250ZXh0cy5tYXAoY29udGV4dCA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBvYmplY3Q6IHRoaXMuX3JlbW90ZU9iamVjdE9mQ29udGV4dChmcmFtZUluZGV4LCBjb250ZXh0KSxcbiAgICAgICAgdHlwZTogY29udGV4dE5hbWVUb1Njb3BlVHlwZShjb250ZXh0Lm5hbWUpLFxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGV2YWx1YXRlT25DYWxsRnJhbWUoZnJhbWVJbmRleDogbnVtYmVyLCBleHByZXNzaW9uOiBzdHJpbmcpOiBQcm9taXNlPE9iamVjdD4ge1xuICAgIGlmICghdGhpcy5pc0VuYWJsZWQoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNdXN0IGJlIGVuYWJsZWQgdG8gZXZhbHVhdGUgZXhwcmVzc2lvbi4nKTtcbiAgICB9XG5cbiAgICBjb25zdCBldmFsdWF0ZWRSZXN1bHQgPSBhd2FpdCB0aGlzLl9zb2NrZXQuZXZhbHVhdGVPbkNhbGxGcmFtZShmcmFtZUluZGV4LCBleHByZXNzaW9uKTtcbiAgICBpZiAoZXZhbHVhdGVkUmVzdWx0Lndhc1Rocm93bikge1xuICAgICAgcmV0dXJuIGV2YWx1YXRlZFJlc3VsdDtcbiAgICB9XG4gICAgY29uc3QgaWQgPSBnZXRXYXRjaENvbnRleHRPYmplY3RJZCh0aGlzLl9lbmFibGVDb3VudCwgZnJhbWVJbmRleCk7XG4gICAgY29uc3QgcmVzdWx0ID0gY29udmVydFZhbHVlKGlkLCBldmFsdWF0ZWRSZXN1bHQucmVzdWx0KTtcbiAgICByZXR1cm4ge1xuICAgICAgcmVzdWx0LFxuICAgICAgd2FzVGhyb3duOiBmYWxzZSxcbiAgICB9O1xuICB9XG5cbiAgX3JlbW90ZU9iamVjdE9mQ29udGV4dChmcmFtZUluZGV4OiBudW1iZXIsIGNvbnRleHQ6IERiZ3BDb250ZXh0KTogUmVtb3RlT2JqZWN0IHtcbiAgICByZXR1cm4ge1xuICAgICAgZGVzY3JpcHRpb246IGNvbnRleHQubmFtZSxcbiAgICAgIHR5cGU6ICdvYmplY3QnLFxuICAgICAgb2JqZWN0SWQ6IHJlbW90ZU9iamVjdElkT2ZPYmplY3RJZCh0aGlzLl9vYmplY3RJZE9mQ29udGV4dChmcmFtZUluZGV4LCBjb250ZXh0KSksXG4gICAgfTtcbiAgfVxuXG4gIF9vYmplY3RJZE9mQ29udGV4dChmcmFtZUluZGV4OiBudW1iZXIsIGNvbnRleHQ6IERiZ3BDb250ZXh0KTogT2JqZWN0SWQge1xuICAgIHJldHVybiBjcmVhdGVDb250ZXh0T2JqZWN0SWQodGhpcy5fZW5hYmxlQ291bnQsIGZyYW1lSW5kZXgsIGNvbnRleHQuaWQpO1xuICB9XG5cbiAgYXN5bmMgZ2V0UHJvcGVydGllcyhyZW1vdGVJZDogUmVtb3RlT2JqZWN0SWQpOiBQcm9taXNlPEFycmF5PFByb3BlcnR5RGVzY3JpcHRvcj4+IHtcbiAgICBjb25zdCBpZCA9IEpTT04ucGFyc2UocmVtb3RlSWQpO1xuICAgIGlmIChpZC5lbmFibGVDb3VudCAhPT0gdGhpcy5fZW5hYmxlQ291bnQpIHtcbiAgICAgIGxvZ0Vycm9yQW5kVGhyb3coYEdvdCByZXF1ZXN0IGZvciBzdGFsZSBSZW1vdGVPYmplY3RJZCAke3JlbW90ZUlkfWApO1xuICAgIH1cblxuICAgIC8vIGNvbnRleHQgYW5kIHNpbmdsZSBwYWdlZCBpZHMgcmVxdWlyZSBnZXR0aW5nIGNoaWxkcmVuIGZyb20gdGhlIGRlYnVnZ2VlIGFuZCBjb252ZXJ0aW5nXG4gICAgLy8gdGhlbSBmcm9tIGRiZ3AgdG8gY2hyb21lIGZvcm1hdC5cbiAgICBpZiAoaXNDb250ZXh0T2JqZWN0SWQoaWQpKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0Q29udGV4dFByb3BlcnRpZXMoaWQpO1xuICAgIH0gZWxzZSBpZiAoaXNQYWdlZE9iamVjdElkKGlkKSl7XG4gICAgICAvLyBQYWdlZCBpZCdzIGNoaWxkcmVuIGFyZSBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBjaHJvbWUgZm9ybWF0IGZyb20gdGhlIGNvbnRlbnRzIG9mIHRoZVxuICAgICAgLy8gb2JqZWN0IGlkLiBEb2VzIG5vdCByZXF1aXJlIGdvaW5nIHRvIHRoZSBkZWJ1Z2dlZS5cbiAgICAgIHJldHVybiBnZXRQYWdlZFByb3BlcnRpZXMoaWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U2luZ2xlUGFnZU9mUHJvcGVydGllcyhpZCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgX2dldFNpbmdsZVBhZ2VPZlByb3BlcnRpZXMoaWQ6IE9iamVjdElkKTogUHJvbWlzZTxBcnJheTxQcm9wZXJ0eURlc2NyaXB0b3I+PiB7XG4gICAgbGV0IHByb3BlcnRpZXMgPSBudWxsO1xuICAgIGlmIChpc1dhdGNoQ29udGV4dE9iamVjdElkKGlkKSkge1xuICAgICAgcHJvcGVydGllcyA9IGF3YWl0IHRoaXMuX3NvY2tldC5nZXRQcm9wZXJ0aWVzQnlGdWxsbmFtZUFsbENvbmV4dHMoaWQuZnJhbWVJbmRleCwgaWQuZnVsbG5hbWUsIGlkLnBhZ2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcm9wZXJ0aWVzID0gYXdhaXQgdGhpcy5fc29ja2V0LmdldFByb3BlcnRpZXNCeUZ1bGxuYW1lKGlkLmZyYW1lSW5kZXgsIGlkLmNvbnRleHRJZCwgaWQuZnVsbG5hbWUsIGlkLnBhZ2UpO1xuICAgIH1cbiAgICByZXR1cm4gY29udmVydFByb3BlcnRpZXMoaWQsIHByb3BlcnRpZXMpO1xuICB9XG5cbiAgYXN5bmMgX2dldENvbnRleHRQcm9wZXJ0aWVzKGlkOiBPYmplY3RJZCk6IFByb21pc2U8QXJyYXk8UHJvcGVydHlEZXNjcmlwdG9yPj4ge1xuICAgIGNvbnN0IHByb3BlcnRpZXMgPSBhd2FpdCB0aGlzLl9zb2NrZXQuZ2V0Q29udGV4dFByb3BlcnRpZXMoaWQuZnJhbWVJbmRleCwgaWQuY29udGV4dElkKTtcbiAgICByZXR1cm4gY29udmVydFByb3BlcnRpZXMoaWQsIHByb3BlcnRpZXMpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbnRleHROYW1lVG9TY29wZVR5cGUobmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgc3dpdGNoIChuYW1lKSB7XG4gICAgY2FzZSAnTG9jYWxzJzpcbiAgICAgIHJldHVybiAnbG9jYWwnO1xuICAgIGNhc2UgJ1N1cGVyZ2xvYmFscyc6XG4gICAgICByZXR1cm4gJ2dsb2JhbCc7XG4gICAgY2FzZSAnVXNlciBkZWZpbmVkIGNvbnN0YW50cyc6XG4gICAgICByZXR1cm4gJ2dsb2JhbCc7XG4gIC8vIFRPRE86IFZlcmlmeSB0aGlzIC4uLlxuICAgIGRlZmF1bHQ6XG4gICAgICBsb2coYFVuZXhwZWN0ZWQgY29udGV4dCBuYW1lOiAke25hbWV9YCk7XG4gICAgICByZXR1cm4gJ2Nsb3N1cmUnO1xuICB9XG59XG4iXX0=
