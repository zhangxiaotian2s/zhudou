
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

Object.defineProperty(exports, '__esModule', {
  value: true
});
var path = require('path');

/**
 * This function returns HgRepositoryDescription filled with a repoPath and
 * originURL iff it finds that the given directory is within an Hg repository.
 */
function findHgRepository(directoryPath) {
  var fs = require('fs-plus');
  var workingDirectoryPath = directoryPath;
  var repoPath = null;
  var originURL = null;
  /*eslint-disable no-constant-condition */
  while (true) {
    var dirToTest = path.join(workingDirectoryPath, '.hg');
    if (fs.isDirectorySync(dirToTest) && fs.isFileSync(path.join(dirToTest, 'hgrc'))) {
      var ini = require('ini');
      // I'm not quite sure why this header is required, but I copied this
      // from the npm page to make things work: https://www.npmjs.com/package/ini.
      var header = 'scope = global\n';
      var config = ini.parse(header + fs.readFileSync(path.join(dirToTest, 'hgrc')));
      if (typeof config.paths['default'] === 'string') {
        repoPath = dirToTest;
        originURL = config.paths['default'];
        break;
      }
    }

    if (isRootDir(workingDirectoryPath)) {
      break;
    } else {
      workingDirectoryPath = getParentDir(workingDirectoryPath);
    }
  }
  /*eslint-enable no-constant-condition */
  return { repoPath: repoPath, originURL: originURL, workingDirectoryPath: workingDirectoryPath };
}

function isRootDir(directoryPath) {
  var isRoot = require('nuclide-commons').fsPromise.isRoot;

  return isRoot(directoryPath);
}

function getParentDir(directoryPath) {
  return path.resolve(directoryPath, '..');
}

module.exports = findHgRepository;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXNvdXJjZS1jb250cm9sLWhlbHBlcnMvbGliL2hnLXJlcG9zaXRvcnkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFDOzs7Ozs7Ozs7Ozs7O0FBV1osSUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDOzs7Ozs7QUFZN0IsU0FBUyxnQkFBZ0IsQ0FBQyxhQUFxQixFQUEyQjtBQUN4RSxNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDOUIsTUFBSSxvQkFBb0IsR0FBRyxhQUFhLENBQUM7QUFDekMsTUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDO0FBQ3BCLE1BQUksU0FBUyxHQUFHLElBQUksQ0FBQzs7QUFFckIsU0FBTyxJQUFJLEVBQUU7QUFDWCxRQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ3pELFFBQUksRUFBRSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsSUFDN0IsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQyxFQUFFO0FBQy9DLFVBQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQzs7O0FBRzNCLFVBQU0sTUFBTSxHQUFHLGtCQUFrQixDQUFDO0FBQ2xDLFVBQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUMzQixFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuRCxVQUFJLE9BQU8sTUFBTSxDQUFDLEtBQUssV0FBUSxLQUFLLFFBQVEsRUFBRTtBQUM1QyxnQkFBUSxHQUFHLFNBQVMsQ0FBQztBQUNyQixpQkFBUyxHQUFHLE1BQU0sQ0FBQyxLQUFLLFdBQVEsQ0FBQztBQUNqQyxjQUFNO09BQ1A7S0FDRjs7QUFFRCxRQUFJLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFO0FBQ25DLFlBQU07S0FDUCxNQUFNO0FBQ0wsMEJBQW9CLEdBQUcsWUFBWSxDQUFDLG9CQUFvQixDQUFDLENBQUM7S0FDM0Q7R0FDRjs7QUFFRCxTQUFPLEVBQUMsUUFBUSxFQUFSLFFBQVEsRUFBRSxTQUFTLEVBQVQsU0FBUyxFQUFFLG9CQUFvQixFQUFwQixvQkFBb0IsRUFBQyxDQUFDO0NBQ3BEOztBQUVELFNBQVMsU0FBUyxDQUFDLGFBQXFCLEVBQVc7TUFDMUMsTUFBTSxHQUFJLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFNBQVMsQ0FBOUMsTUFBTTs7QUFDYixTQUFPLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztDQUM5Qjs7QUFFRCxTQUFTLFlBQVksQ0FBQyxhQUFxQixFQUFVO0FBQ25ELFNBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7Q0FDMUM7O0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxnQkFBZ0IsQ0FBQyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wcGZsNTJucHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1zb3VyY2UtY29udHJvbC1oZWxwZXJzL2xpYi9oZy1yZXBvc2l0b3J5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuZXhwb3J0IHR5cGUgSGdSZXBvc2l0b3J5RGVzY3JpcHRpb24gPSB7XG4gIHJlcG9QYXRoOiA/c3RyaW5nO1xuICBvcmlnaW5VUkw6ID9zdHJpbmc7XG4gIHdvcmtpbmdEaXJlY3RvcnlQYXRoOiBzdHJpbmc7XG59O1xuXG4vKipcbiAqIFRoaXMgZnVuY3Rpb24gcmV0dXJucyBIZ1JlcG9zaXRvcnlEZXNjcmlwdGlvbiBmaWxsZWQgd2l0aCBhIHJlcG9QYXRoIGFuZFxuICogb3JpZ2luVVJMIGlmZiBpdCBmaW5kcyB0aGF0IHRoZSBnaXZlbiBkaXJlY3RvcnkgaXMgd2l0aGluIGFuIEhnIHJlcG9zaXRvcnkuXG4gKi9cbmZ1bmN0aW9uIGZpbmRIZ1JlcG9zaXRvcnkoZGlyZWN0b3J5UGF0aDogc3RyaW5nKTogSGdSZXBvc2l0b3J5RGVzY3JpcHRpb24ge1xuICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzLXBsdXMnKTtcbiAgbGV0IHdvcmtpbmdEaXJlY3RvcnlQYXRoID0gZGlyZWN0b3J5UGF0aDtcbiAgbGV0IHJlcG9QYXRoID0gbnVsbDtcbiAgbGV0IG9yaWdpblVSTCA9IG51bGw7XG4gIC8qZXNsaW50LWRpc2FibGUgbm8tY29uc3RhbnQtY29uZGl0aW9uICovXG4gIHdoaWxlICh0cnVlKSB7XG4gICAgY29uc3QgZGlyVG9UZXN0ID0gcGF0aC5qb2luKHdvcmtpbmdEaXJlY3RvcnlQYXRoLCAnLmhnJyk7XG4gICAgaWYgKGZzLmlzRGlyZWN0b3J5U3luYyhkaXJUb1Rlc3QpICYmXG4gICAgICAgIGZzLmlzRmlsZVN5bmMocGF0aC5qb2luKGRpclRvVGVzdCwgJ2hncmMnKSkpIHtcbiAgICAgIGNvbnN0IGluaSA9IHJlcXVpcmUoJ2luaScpO1xuICAgICAgLy8gSSdtIG5vdCBxdWl0ZSBzdXJlIHdoeSB0aGlzIGhlYWRlciBpcyByZXF1aXJlZCwgYnV0IEkgY29waWVkIHRoaXNcbiAgICAgIC8vIGZyb20gdGhlIG5wbSBwYWdlIHRvIG1ha2UgdGhpbmdzIHdvcms6IGh0dHBzOi8vd3d3Lm5wbWpzLmNvbS9wYWNrYWdlL2luaS5cbiAgICAgIGNvbnN0IGhlYWRlciA9ICdzY29wZSA9IGdsb2JhbFxcbic7XG4gICAgICBjb25zdCBjb25maWcgPSBpbmkucGFyc2UoaGVhZGVyICtcbiAgICAgICAgICBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKGRpclRvVGVzdCwgJ2hncmMnKSkpO1xuICAgICAgaWYgKHR5cGVvZiBjb25maWcucGF0aHMuZGVmYXVsdCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmVwb1BhdGggPSBkaXJUb1Rlc3Q7XG4gICAgICAgIG9yaWdpblVSTCA9IGNvbmZpZy5wYXRocy5kZWZhdWx0O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoaXNSb290RGlyKHdvcmtpbmdEaXJlY3RvcnlQYXRoKSkge1xuICAgICAgYnJlYWs7XG4gICAgfSBlbHNlIHtcbiAgICAgIHdvcmtpbmdEaXJlY3RvcnlQYXRoID0gZ2V0UGFyZW50RGlyKHdvcmtpbmdEaXJlY3RvcnlQYXRoKTtcbiAgICB9XG4gIH1cbiAgLyplc2xpbnQtZW5hYmxlIG5vLWNvbnN0YW50LWNvbmRpdGlvbiAqL1xuICByZXR1cm4ge3JlcG9QYXRoLCBvcmlnaW5VUkwsIHdvcmtpbmdEaXJlY3RvcnlQYXRofTtcbn1cblxuZnVuY3Rpb24gaXNSb290RGlyKGRpcmVjdG9yeVBhdGg6IHN0cmluZyk6IGJvb2xlYW4ge1xuICBjb25zdCB7aXNSb290fSA9IHJlcXVpcmUoJ251Y2xpZGUtY29tbW9ucycpLmZzUHJvbWlzZTtcbiAgcmV0dXJuIGlzUm9vdChkaXJlY3RvcnlQYXRoKTtcbn1cblxuZnVuY3Rpb24gZ2V0UGFyZW50RGlyKGRpcmVjdG9yeVBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBwYXRoLnJlc29sdmUoZGlyZWN0b3J5UGF0aCwgJy4uJyk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZmluZEhnUmVwb3NpdG9yeTtcbiJdfQ==
