Object.defineProperty(exports, '__esModule', {
  value: true
});

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

var newFileSearch = _asyncToGenerator(function* (directoryUri) {
  var _require = require('nuclide-task');

  var createTask = _require.createTask;

  var task = createTask();
  yield task.invokeRemoteMethod({
    file: require.resolve('./FileSearch'),
    method: 'initFileSearchForDirectory',
    args: [directoryUri]
  });
  return new MainProcessFileSearch(task, directoryUri);
}

/**
 * Currently, all the caller cares about is that the Promise resolves to an
 * object with a query() method.
 *
 * TODO(mbolin): Caller should also invoke dispose(), as appropriate.
 */
);

exports.fileSearchForDirectory = fileSearchForDirectory;

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

'use babel';

/**
 * This is an object that lives in the main process that delegates calls to the
 * FileSearch in the forked process.
 */

var MainProcessFileSearch = (function () {
  function MainProcessFileSearch(task, directoryUri) {
    _classCallCheck(this, MainProcessFileSearch);

    this._task = task;
    this._directoryUri = directoryUri;
  }

  _createClass(MainProcessFileSearch, [{
    key: 'query',
    value: (function (_query) {
      function query(_x) {
        return _query.apply(this, arguments);
      }

      query.toString = function () {
        return _query.toString();
      };

      return query;
    })(function (query) {
      return this._task.invokeRemoteMethod({
        file: require.resolve('./FileSearch'),
        method: 'doSearch',
        args: [this._directoryUri, query]
      });
    })
  }, {
    key: 'dispose',
    value: function dispose() {
      if (fileSearchForDirectoryUri[this._directoryUri] === this) {
        delete fileSearchForDirectoryUri[this._directoryUri];
      }
      this._task.dispose();
    }
  }]);

  return MainProcessFileSearch;
})();

var fileSearchForDirectoryUri = {};

function fileSearchForDirectory(directoryUri) {
  if (directoryUri in fileSearchForDirectoryUri) {
    return fileSearchForDirectoryUri[directoryUri];
  }

  var promise = newFileSearch(directoryUri);
  fileSearchForDirectoryUri[directoryUri] = promise;
  return promise;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXBhdGgtc2VhcmNoL2xpYi9tYWluLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0lBcURlLGFBQWEscUJBQTVCLFdBQTZCLFlBQW9CLEVBQWtDO2lCQUM1RCxPQUFPLENBQUMsY0FBYyxDQUFDOztNQUFyQyxVQUFVLFlBQVYsVUFBVTs7QUFDakIsTUFBTSxJQUFJLEdBQUcsVUFBVSxFQUFFLENBQUM7QUFDMUIsUUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUM7QUFDNUIsUUFBSSxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDO0FBQ3JDLFVBQU0sRUFBRSw0QkFBNEI7QUFDcEMsUUFBSSxFQUFFLENBQUMsWUFBWSxDQUFDO0dBQ3JCLENBQUMsQ0FBQztBQUNILFNBQU8sSUFBSSxxQkFBcUIsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7Q0FDdEQ7Ozs7Ozs7Ozs7Ozs7Ozs7QUE5REQsV0FBVyxDQUFDOzs7Ozs7O0lBMEJOLHFCQUFxQjtBQUlkLFdBSlAscUJBQXFCLENBSWIsSUFBVSxFQUFFLFlBQTBCLEVBQUU7MEJBSmhELHFCQUFxQjs7QUFLdkIsUUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7QUFDbEIsUUFBSSxDQUFDLGFBQWEsR0FBRyxZQUFZLENBQUM7R0FDbkM7O2VBUEcscUJBQXFCOzs7Ozs7Ozs7Ozs7T0FTcEIsVUFBQyxLQUFhLEVBQW9DO0FBQ3JELGFBQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQztBQUNuQyxZQUFJLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUM7QUFDckMsY0FBTSxFQUFFLFVBQVU7QUFDbEIsWUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUM7T0FDbEMsQ0FBQyxDQUFDO0tBQ0o7OztXQUVNLG1CQUFHO0FBQ1IsVUFBSSx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssSUFBSSxFQUFFO0FBQzFELGVBQU8seUJBQXlCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO09BQ3REO0FBQ0QsVUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztLQUN0Qjs7O1NBdEJHLHFCQUFxQjs7O0FBeUIzQixJQUFNLHlCQUFnRixHQUFHLEVBQUUsQ0FBQzs7QUFtQnJGLFNBQVMsc0JBQXNCLENBQUMsWUFBb0IsRUFBdUI7QUFDaEYsTUFBSSxZQUFZLElBQUkseUJBQXlCLEVBQUU7QUFDN0MsV0FBTyx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztHQUNoRDs7QUFFRCxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDNUMsMkJBQXlCLENBQUMsWUFBWSxDQUFDLEdBQUcsT0FBTyxDQUFDO0FBQ2xELFNBQU8sT0FBTyxDQUFDO0NBQ2hCIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXBhdGgtc2VhcmNoL2xpYi9tYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuaW1wb3J0IHR5cGUge1Rhc2t9IGZyb20gJ251Y2xpZGUtdGFzayc7XG5pbXBvcnQgdHlwZSB7RmlsZVNlYXJjaFJlc3VsdCBhcyBGaWxlU2VhcmNoUmVzdWx0VHlwZX0gZnJvbSAnLi9GaWxlU2VhcmNoJztcblxuZXhwb3J0IHR5cGUgRmlsZVNlYXJjaFJlc3VsdCA9IEZpbGVTZWFyY2hSZXN1bHRUeXBlO1xuXG50eXBlIERpcmVjdG9yeVVyaSA9IHN0cmluZztcbmV4cG9ydCB0eXBlIEZpbGVTZWFyY2ggPSB7XG4gIHF1ZXJ5OiAocXVlcnk6IHN0cmluZykgPT4gUHJvbWlzZTxBcnJheTxGaWxlU2VhcmNoUmVzdWx0Pj47XG4gIGRpc3Bvc2U6ICgpID0+IHZvaWQ7XG59O1xuXG4vKipcbiAqIFRoaXMgaXMgYW4gb2JqZWN0IHRoYXQgbGl2ZXMgaW4gdGhlIG1haW4gcHJvY2VzcyB0aGF0IGRlbGVnYXRlcyBjYWxscyB0byB0aGVcbiAqIEZpbGVTZWFyY2ggaW4gdGhlIGZvcmtlZCBwcm9jZXNzLlxuICovXG5jbGFzcyBNYWluUHJvY2Vzc0ZpbGVTZWFyY2gge1xuICBfdGFzazogVGFzaztcbiAgX2RpcmVjdG9yeVVyaTogRGlyZWN0b3J5VXJpO1xuXG4gIGNvbnN0cnVjdG9yKHRhc2s6IFRhc2ssIGRpcmVjdG9yeVVyaTogRGlyZWN0b3J5VXJpKSB7XG4gICAgdGhpcy5fdGFzayA9IHRhc2s7XG4gICAgdGhpcy5fZGlyZWN0b3J5VXJpID0gZGlyZWN0b3J5VXJpO1xuICB9XG5cbiAgcXVlcnkocXVlcnk6IHN0cmluZyk6IFByb21pc2U8QXJyYXk8RmlsZVNlYXJjaFJlc3VsdD4+IHtcbiAgICByZXR1cm4gdGhpcy5fdGFzay5pbnZva2VSZW1vdGVNZXRob2Qoe1xuICAgICAgZmlsZTogcmVxdWlyZS5yZXNvbHZlKCcuL0ZpbGVTZWFyY2gnKSxcbiAgICAgIG1ldGhvZDogJ2RvU2VhcmNoJyxcbiAgICAgIGFyZ3M6IFt0aGlzLl9kaXJlY3RvcnlVcmksIHF1ZXJ5XSxcbiAgICB9KTtcbiAgfVxuXG4gIGRpc3Bvc2UoKSB7XG4gICAgaWYgKGZpbGVTZWFyY2hGb3JEaXJlY3RvcnlVcmlbdGhpcy5fZGlyZWN0b3J5VXJpXSA9PT0gdGhpcykge1xuICAgICAgZGVsZXRlIGZpbGVTZWFyY2hGb3JEaXJlY3RvcnlVcmlbdGhpcy5fZGlyZWN0b3J5VXJpXTtcbiAgICB9XG4gICAgdGhpcy5fdGFzay5kaXNwb3NlKCk7XG4gIH1cbn1cblxuY29uc3QgZmlsZVNlYXJjaEZvckRpcmVjdG9yeVVyaToge1trZXk6IERpcmVjdG9yeVVyaV06IFByb21pc2U8TWFpblByb2Nlc3NGaWxlU2VhcmNoPn0gPSB7fTtcblxuYXN5bmMgZnVuY3Rpb24gbmV3RmlsZVNlYXJjaChkaXJlY3RvcnlVcmk6IHN0cmluZyk6IFByb21pc2U8TWFpblByb2Nlc3NGaWxlU2VhcmNoPiB7XG4gIGNvbnN0IHtjcmVhdGVUYXNrfSA9IHJlcXVpcmUoJ251Y2xpZGUtdGFzaycpO1xuICBjb25zdCB0YXNrID0gY3JlYXRlVGFzaygpO1xuICBhd2FpdCB0YXNrLmludm9rZVJlbW90ZU1ldGhvZCh7XG4gICAgZmlsZTogcmVxdWlyZS5yZXNvbHZlKCcuL0ZpbGVTZWFyY2gnKSxcbiAgICBtZXRob2Q6ICdpbml0RmlsZVNlYXJjaEZvckRpcmVjdG9yeScsXG4gICAgYXJnczogW2RpcmVjdG9yeVVyaV0sXG4gIH0pO1xuICByZXR1cm4gbmV3IE1haW5Qcm9jZXNzRmlsZVNlYXJjaCh0YXNrLCBkaXJlY3RvcnlVcmkpO1xufVxuXG4vKipcbiAqIEN1cnJlbnRseSwgYWxsIHRoZSBjYWxsZXIgY2FyZXMgYWJvdXQgaXMgdGhhdCB0aGUgUHJvbWlzZSByZXNvbHZlcyB0byBhblxuICogb2JqZWN0IHdpdGggYSBxdWVyeSgpIG1ldGhvZC5cbiAqXG4gKiBUT0RPKG1ib2xpbik6IENhbGxlciBzaG91bGQgYWxzbyBpbnZva2UgZGlzcG9zZSgpLCBhcyBhcHByb3ByaWF0ZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZpbGVTZWFyY2hGb3JEaXJlY3RvcnkoZGlyZWN0b3J5VXJpOiBzdHJpbmcpOiBQcm9taXNlPEZpbGVTZWFyY2g+IHtcbiAgaWYgKGRpcmVjdG9yeVVyaSBpbiBmaWxlU2VhcmNoRm9yRGlyZWN0b3J5VXJpKSB7XG4gICAgcmV0dXJuIGZpbGVTZWFyY2hGb3JEaXJlY3RvcnlVcmlbZGlyZWN0b3J5VXJpXTtcbiAgfVxuXG4gIGNvbnN0IHByb21pc2UgPSBuZXdGaWxlU2VhcmNoKGRpcmVjdG9yeVVyaSk7XG4gIGZpbGVTZWFyY2hGb3JEaXJlY3RvcnlVcmlbZGlyZWN0b3J5VXJpXSA9IHByb21pc2U7XG4gIHJldHVybiBwcm9taXNlO1xufVxuIl19
