
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var logger = require('nuclide-logging').getLogger();

// A cache stores services in form of '$serviceName@$cwd' => $serviceObject.
var cachedServices = new Map();

function optionsToString(options) {
  if (!options) {
    return '';
  } else if (options instanceof Array) {
    return '[' + options.map(function (item) {
      return optionsToString(item);
    }).join(', ') + ']';
  } else if (options instanceof Object) {
    var keys = Object.keys(options).sort();
    return '{' + keys.map(function (key) {
      return key + ': ' + optionsToString(options[key]);
    }).join(', ') + '}';
  } else if (typeof options === 'number' || typeof options === 'boolean' || typeof options === 'string') {
    return JSON.stringify(options);
  } else {
    throw Error('Can\'t stringify %o', options);
  }
}

/**
 * Create a new or retrieve a cached service instance by serviceName and service options.
 */
function getService(serviceName, options, localImplementationClassPath) {
  var key = serviceName + '@' + optionsToString(options);
  if (!cachedServices.has(key)) {
    logger.debug('Create service instance: ' + key);
    var serviceInstance = createLocalService(serviceName, localImplementationClassPath, options);
    cachedServices.set(key, serviceInstance);
  }
  return cachedServices.get(key);
}

function createLocalService(serviceName, localImplementationClassPath, options) {
  var serviceModule = require(localImplementationClassPath);
  var serviceClass = serviceModule[serviceName] || serviceModule;
  return new serviceClass(options);
}

function getRemoteEventName(serviceName, eventMethodName, serviceOptions) {
  return getLocalEventName(serviceName, eventMethodName) + '@' + optionsToString(serviceOptions);
}

function getLocalEventName(serviceName, eventMethodName) {
  return serviceName + '/' + eventMethodName;
}

module.exports = {
  getService: getService,
  getRemoteEventName: getRemoteEventName,
  optionsToString: optionsToString
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXNlcnZlci9saWIvc2VydmljZS1tYW5hZ2VyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7OztBQVdaLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDOzs7QUFHdEQsSUFBTSxjQUFnQyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7O0FBRW5ELFNBQVMsZUFBZSxDQUFDLE9BQWEsRUFBVTtBQUM5QyxNQUFJLENBQUMsT0FBTyxFQUFFO0FBQ1osV0FBTyxFQUFFLENBQUM7R0FDWCxNQUFNLElBQUksT0FBTyxZQUFZLEtBQUssRUFBRTtBQUNuQyxXQUFPLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUEsSUFBSTthQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUM7S0FBQSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQztHQUMxRSxNQUFNLElBQUksT0FBTyxZQUFZLE1BQU0sRUFBRTtBQUNwQyxRQUFNLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ3pDLFdBQU8sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBQSxHQUFHO2FBQUksR0FBRyxHQUFHLElBQUksR0FBRyxlQUFlLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQUEsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUM7R0FDM0YsTUFBTSxJQUFJLE9BQU8sT0FBTyxLQUFLLFFBQVEsSUFBSSxPQUFPLE9BQU8sS0FBSyxTQUFTLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO0FBQ3JHLFdBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztHQUNoQyxNQUFNO0FBQ0wsVUFBTSxLQUFLLENBQUMscUJBQXFCLEVBQUUsT0FBTyxDQUFDLENBQUM7R0FDN0M7Q0FDRjs7Ozs7QUFLRCxTQUFTLFVBQVUsQ0FBQyxXQUFtQixFQUFFLE9BQVksRUFBRSw0QkFBb0MsRUFBTztBQUNoRyxNQUFNLEdBQUcsR0FBRyxXQUFXLEdBQUcsR0FBRyxHQUFHLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN6RCxNQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUM1QixVQUFNLENBQUMsS0FBSywrQkFBNkIsR0FBRyxDQUFHLENBQUM7QUFDaEQsUUFBTSxlQUFlLEdBQUcsa0JBQWtCLENBQUMsV0FBVyxFQUFFLDRCQUE0QixFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQy9GLGtCQUFjLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxlQUFlLENBQUMsQ0FBQztHQUMxQztBQUNELFNBQU8sY0FBYyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztDQUNoQzs7QUFFRCxTQUFTLGtCQUFrQixDQUFDLFdBQW1CLEVBQUUsNEJBQW9DLEVBQUUsT0FBWSxFQUFPO0FBQ3hHLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQzVELE1BQU0sWUFBWSxHQUFHLGFBQWEsQ0FBQyxXQUFXLENBQUMsSUFBSSxhQUFhLENBQUM7QUFDakUsU0FBTyxJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztDQUNsQzs7QUFFRCxTQUFTLGtCQUFrQixDQUFDLFdBQW1CLEVBQUUsZUFBdUIsRUFBRSxjQUFtQixFQUFVO0FBQ3JHLFNBQU8saUJBQWlCLENBQUMsV0FBVyxFQUFFLGVBQWUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxlQUFlLENBQUMsY0FBYyxDQUFDLENBQUM7Q0FDaEc7O0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxXQUFtQixFQUFFLGVBQXVCLEVBQVU7QUFDL0UsU0FBTyxXQUFXLEdBQUcsR0FBRyxHQUFHLGVBQWUsQ0FBQztDQUM1Qzs7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHO0FBQ2YsWUFBVSxFQUFWLFVBQVU7QUFDVixvQkFBa0IsRUFBbEIsa0JBQWtCO0FBQ2xCLGlCQUFlLEVBQWYsZUFBZTtDQUNoQixDQUFDIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXNlcnZlci9saWIvc2VydmljZS1tYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnbnVjbGlkZS1sb2dnaW5nJykuZ2V0TG9nZ2VyKCk7XG5cbi8vIEEgY2FjaGUgc3RvcmVzIHNlcnZpY2VzIGluIGZvcm0gb2YgJyRzZXJ2aWNlTmFtZUAkY3dkJyA9PiAkc2VydmljZU9iamVjdC5cbmNvbnN0IGNhY2hlZFNlcnZpY2VzOiBNYXA8c3RyaW5nLCBhbnk+ID0gbmV3IE1hcCgpO1xuXG5mdW5jdGlvbiBvcHRpb25zVG9TdHJpbmcob3B0aW9uczogP2FueSk6IHN0cmluZyB7XG4gIGlmICghb3B0aW9ucykge1xuICAgIHJldHVybiAnJztcbiAgfSBlbHNlIGlmIChvcHRpb25zIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICByZXR1cm4gJ1snICsgb3B0aW9ucy5tYXAoaXRlbSA9PiBvcHRpb25zVG9TdHJpbmcoaXRlbSkpLmpvaW4oJywgJykgKyAnXSc7XG4gIH0gZWxzZSBpZiAob3B0aW9ucyBpbnN0YW5jZW9mIE9iamVjdCkge1xuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhvcHRpb25zKS5zb3J0KCk7XG4gICAgcmV0dXJuICd7JyArIGtleXMubWFwKGtleSA9PiBrZXkgKyAnOiAnICsgb3B0aW9uc1RvU3RyaW5nKG9wdGlvbnNba2V5XSkpLmpvaW4oJywgJykgKyAnfSc7XG4gIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdudW1iZXInIHx8IHR5cGVvZiBvcHRpb25zID09PSAnYm9vbGVhbicgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9wdGlvbnMpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IEVycm9yKCdDYW5cXCd0IHN0cmluZ2lmeSAlbycsIG9wdGlvbnMpO1xuICB9XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgbmV3IG9yIHJldHJpZXZlIGEgY2FjaGVkIHNlcnZpY2UgaW5zdGFuY2UgYnkgc2VydmljZU5hbWUgYW5kIHNlcnZpY2Ugb3B0aW9ucy5cbiAqL1xuZnVuY3Rpb24gZ2V0U2VydmljZShzZXJ2aWNlTmFtZTogc3RyaW5nLCBvcHRpb25zOiBhbnksIGxvY2FsSW1wbGVtZW50YXRpb25DbGFzc1BhdGg6IHN0cmluZyk6IGFueSB7XG4gIGNvbnN0IGtleSA9IHNlcnZpY2VOYW1lICsgJ0AnICsgb3B0aW9uc1RvU3RyaW5nKG9wdGlvbnMpO1xuICBpZiAoIWNhY2hlZFNlcnZpY2VzLmhhcyhrZXkpKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBDcmVhdGUgc2VydmljZSBpbnN0YW5jZTogJHtrZXl9YCk7XG4gICAgY29uc3Qgc2VydmljZUluc3RhbmNlID0gY3JlYXRlTG9jYWxTZXJ2aWNlKHNlcnZpY2VOYW1lLCBsb2NhbEltcGxlbWVudGF0aW9uQ2xhc3NQYXRoLCBvcHRpb25zKTtcbiAgICBjYWNoZWRTZXJ2aWNlcy5zZXQoa2V5LCBzZXJ2aWNlSW5zdGFuY2UpO1xuICB9XG4gIHJldHVybiBjYWNoZWRTZXJ2aWNlcy5nZXQoa2V5KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlTG9jYWxTZXJ2aWNlKHNlcnZpY2VOYW1lOiBzdHJpbmcsIGxvY2FsSW1wbGVtZW50YXRpb25DbGFzc1BhdGg6IHN0cmluZywgb3B0aW9uczogYW55KTogYW55IHtcbiAgY29uc3Qgc2VydmljZU1vZHVsZSA9IHJlcXVpcmUobG9jYWxJbXBsZW1lbnRhdGlvbkNsYXNzUGF0aCk7XG4gIGNvbnN0IHNlcnZpY2VDbGFzcyA9IHNlcnZpY2VNb2R1bGVbc2VydmljZU5hbWVdIHx8IHNlcnZpY2VNb2R1bGU7XG4gIHJldHVybiBuZXcgc2VydmljZUNsYXNzKG9wdGlvbnMpO1xufVxuXG5mdW5jdGlvbiBnZXRSZW1vdGVFdmVudE5hbWUoc2VydmljZU5hbWU6IHN0cmluZywgZXZlbnRNZXRob2ROYW1lOiBzdHJpbmcsIHNlcnZpY2VPcHRpb25zOiBhbnkpOiBzdHJpbmcge1xuICByZXR1cm4gZ2V0TG9jYWxFdmVudE5hbWUoc2VydmljZU5hbWUsIGV2ZW50TWV0aG9kTmFtZSkgKyAnQCcgKyBvcHRpb25zVG9TdHJpbmcoc2VydmljZU9wdGlvbnMpO1xufVxuXG5mdW5jdGlvbiBnZXRMb2NhbEV2ZW50TmFtZShzZXJ2aWNlTmFtZTogc3RyaW5nLCBldmVudE1ldGhvZE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBzZXJ2aWNlTmFtZSArICcvJyArIGV2ZW50TWV0aG9kTmFtZTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGdldFNlcnZpY2UsXG4gIGdldFJlbW90ZUV2ZW50TmFtZSxcbiAgb3B0aW9uc1RvU3RyaW5nLFxufTtcbiJdfQ==
