'use babel';

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var HackWorker = require('../lib/HackWorker');

var _require = require('events');

var EventEmitter = _require.EventEmitter;

var logger = require('nuclide-logging').getLogger();

describe('HackWorker', function () {
  describe('runWorkerTask()', function () {
    var hackWorker = undefined;
    beforeEach(function () {
      hackWorker = new HackWorker();
    });

    afterEach(function () {
      hackWorker.dispose();
    });

    it('runs a trivial function task', function () {
      var taskHandler = jasmine.createSpy();
      hackWorker.runWorkerTask({ cmd: 'parseInt', args: ['25'] }).then(taskHandler);
      waitsFor(function () {
        return taskHandler.callCount > 0;
      });
      runs(function () {
        var response = taskHandler.argsForCall[0][0];
        expect(response).toBe(25);
      });
    });

    it('fail a worker task and gets error', function () {
      var taskHandler = jasmine.createSpy();
      hackWorker.runWorkerTask({ cmd: 'nothing', args: [] })['catch'](taskHandler);
      waitsFor(function () {
        return taskHandler.callCount > 0;
      });
      runs(function () {
        var error = taskHandler.argsForCall[0][0];
        expect(error.type).toBe('error');
        expect(error.message).toBe('Uncaught TypeError: Cannot read property \'apply\' of undefined');
      });
    });
  });

  describe('simulate queueing tasks with custom worker', function () {
    var hackWorker = undefined;
    var worker = undefined;
    var workerReplyIn = function workerReplyIn(milliSeconds) {
      worker.postMessage = function (message) {
        setTimeout(function () {
          worker.emit('message', { data: message });
        }, milliSeconds);
      };
    };
    beforeEach(function () {
      worker = new EventEmitter();
      worker.addEventListener = worker.addListener;
      worker.terminate = function () {
        return 0;
      };
      workerReplyIn(5);
      hackWorker = new HackWorker({ worker: worker, webWorkerTimeout: 10, poorPerfTimeout: 20 });
    });

    afterEach(function () {
      hackWorker.dispose();
    });

    it('queues and processes two tasks in order', function () {
      var task1Handler = jasmine.createSpy();
      hackWorker.runWorkerTask('reply1').then(task1Handler);
      var task2Handler = jasmine.createSpy();
      hackWorker.runWorkerTask('reply2').then(task2Handler);
      expect(task1Handler.callCount).toBe(0);
      expect(task2Handler.callCount).toBe(0);
      window.advanceClock(6);
      waits(1);
      runs(function () {
        expect(task1Handler.callCount).toBe(1);
        expect(task1Handler.argsForCall[0][0]).toBe('reply1');
        expect(task2Handler.callCount).toBe(0);
        window.advanceClock(6);
      });
      waits(1);
      runs(function () {
        expect(task1Handler.callCount).toBe(1);
        expect(task2Handler.callCount).toBe(1);
        expect(task2Handler.argsForCall[0][0]).toBe('reply2');
      });
    });

    it('task timeout warning, then the result', function () {
      var warnHandler = logger.warn = jasmine.createSpy();
      workerReplyIn(15);
      var taskHandler = jasmine.createSpy();
      hackWorker.runWorkerTask('reply').then(taskHandler);
      window.advanceClock(11);
      waits(1);
      runs(function () {
        expect(taskHandler.callCount).toBe(0);
        expect(warnHandler.callCount).toBe(1);
        expect(warnHandler.argsForCall[0][0]).toBe('Webworker is stuck in a job!');
        window.advanceClock(5);
      });
      waits(1);
      runs(function () {
        expect(taskHandler.callCount).toBe(1);
        expect(warnHandler.callCount).toBe(1);
        expect(taskHandler.argsForCall[0][0]).toBe('reply');
      });
    });

    it('task timeout and perf warnings, then the result, then a normal task time', function () {
      var warnHandler = logger.warn = jasmine.createSpy();
      var task1Handler = jasmine.createSpy();
      var task2Handler = jasmine.createSpy();
      // schedule the first task with extraordinary response time.
      workerReplyIn(25);
      hackWorker.runWorkerTask('reply1').then(task1Handler);
      // queue another task with a normal task time.
      workerReplyIn(5);
      hackWorker.runWorkerTask('reply2').then(task2Handler);
      window.advanceClock(11);
      waits(1);
      runs(function () {
        expect(task1Handler.callCount).toBe(0);
        expect(task2Handler.callCount).toBe(0);
        expect(warnHandler.callCount).toBe(1);
        expect(warnHandler.argsForCall[0][0]).toBe('Webworker is stuck in a job!');
        window.advanceClock(11);
      });
      waits(1);
      runs(function () {
        expect(task1Handler.callCount).toBe(0);
        expect(task2Handler.callCount).toBe(0);
        expect(warnHandler.callCount).toBe(2);
        expect(warnHandler.argsForCall[1][0]).toBe('Poor Webworker Performance!');
        window.advanceClock(4);
      });
      waits(1);
      runs(function () {
        expect(task1Handler.callCount).toBe(1);
        expect(task1Handler.argsForCall[0][0]).toBe('reply1');
        expect(task2Handler.callCount).toBe(0);
        expect(warnHandler.callCount).toBe(2);
        window.advanceClock(6);
      });
      waits(1);
      runs(function () {
        expect(task2Handler.callCount).toBe(1);
        expect(task2Handler.argsForCall[0][0]).toBe('reply2');
      });
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy96aGFuZ3hpYW90aWFuLy5hdG9tL3BhY2thZ2VzL251Y2xpZGUtaGFjay9zcGVjL0hhY2tXb3JrZXItc3BlYy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxXQUFXLENBQUM7Ozs7Ozs7Ozs7QUFXWixJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQzs7ZUFDekIsT0FBTyxDQUFDLFFBQVEsQ0FBQzs7SUFBakMsWUFBWSxZQUFaLFlBQVk7O0FBQ25CLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDOztBQUV0RCxRQUFRLENBQUMsWUFBWSxFQUFFLFlBQU07QUFDM0IsVUFBUSxDQUFDLGlCQUFpQixFQUFFLFlBQU07QUFDaEMsUUFBSSxVQUFVLFlBQUEsQ0FBQztBQUNmLGNBQVUsQ0FBQyxZQUFNO0FBQ2YsZ0JBQVUsR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO0tBQy9CLENBQUMsQ0FBQzs7QUFFSCxhQUFTLENBQUMsWUFBTTtBQUNkLGdCQUFVLENBQUMsT0FBTyxFQUFFLENBQUM7S0FDdEIsQ0FBQyxDQUFDOztBQUVILE1BQUUsQ0FBQyw4QkFBOEIsRUFBRSxZQUFNO0FBQ3ZDLFVBQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztBQUN4QyxnQkFBVSxDQUFDLGFBQWEsQ0FBQyxFQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUM1RSxjQUFRLENBQUM7ZUFBTSxXQUFXLENBQUMsU0FBUyxHQUFHLENBQUM7T0FBQSxDQUFDLENBQUM7QUFDMUMsVUFBSSxDQUFDLFlBQU07QUFDVCxZQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQy9DLGNBQU0sQ0FB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eEIsQ0FBQyxDQUFDO0FBQ0gsV0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ1QsVUFBSSxDQUFDLFlBQU07QUFDVCxjQUFNLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2QyxjQUFNLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN0RCxjQUFNLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2QyxjQUFNLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0QyxjQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO09BQ3hCLENBQUMsQ0FBQztBQUNILFdBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNULFVBQUksQ0FBQyxZQUFNO0FBQ1QsY0FBTSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdkMsY0FBTSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7T0FDdkQsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6Ii9Vc2Vycy96aGFuZ3hpYW90aWFuLy5hdG9tL3BhY2thZ2VzL251Y2xpZGUtaGFjay9zcGVjL0hhY2tXb3JrZXItc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbmNvbnN0IEhhY2tXb3JrZXIgPSByZXF1aXJlKCcuLi9saWIvSGFja1dvcmtlcicpO1xuY29uc3Qge0V2ZW50RW1pdHRlcn0gPSByZXF1aXJlKCdldmVudHMnKTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJ251Y2xpZGUtbG9nZ2luZycpLmdldExvZ2dlcigpO1xuXG5kZXNjcmliZSgnSGFja1dvcmtlcicsICgpID0+IHtcbiAgZGVzY3JpYmUoJ3J1bldvcmtlclRhc2soKScsICgpID0+IHtcbiAgICBsZXQgaGFja1dvcmtlcjtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIGhhY2tXb3JrZXIgPSBuZXcgSGFja1dvcmtlcigpO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICAgIGhhY2tXb3JrZXIuZGlzcG9zZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3J1bnMgYSB0cml2aWFsIGZ1bmN0aW9uIHRhc2snLCAoKSA9PiB7XG4gICAgICBjb25zdCB0YXNrSGFuZGxlciA9IGphc21pbmUuY3JlYXRlU3B5KCk7XG4gICAgICBoYWNrV29ya2VyLnJ1bldvcmtlclRhc2soe2NtZDogJ3BhcnNlSW50JywgYXJnczogWycyNSddfSkudGhlbih0YXNrSGFuZGxlcik7XG4gICAgICB3YWl0c0ZvcigoKSA9PiB0YXNrSGFuZGxlci5jYWxsQ291bnQgPiAwKTtcbiAgICAgIHJ1bnMoKCkgPT4ge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IHRhc2tIYW5kbGVyLmFyZ3NGb3JDYWxsWzBdWzBdO1xuICAgICAgICBleHBlY3QocmVzcG9uc2UpLnRvQmUoMjUpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZmFpbCBhIHdvcmtlciB0YXNrIGFuZCBnZXRzIGVycm9yJywgKCkgPT4ge1xuICAgICAgY29uc3QgdGFza0hhbmRsZXIgPSBqYXNtaW5lLmNyZWF0ZVNweSgpO1xuICAgICAgaGFja1dvcmtlci5ydW5Xb3JrZXJUYXNrKHtjbWQ6ICdub3RoaW5nJywgYXJnczogW119KS5jYXRjaCh0YXNrSGFuZGxlcik7XG4gICAgICB3YWl0c0ZvcigoKSA9PiB0YXNrSGFuZGxlci5jYWxsQ291bnQgPiAwKTtcbiAgICAgIHJ1bnMoKCkgPT4ge1xuICAgICAgICBjb25zdCBlcnJvciA9IHRhc2tIYW5kbGVyLmFyZ3NGb3JDYWxsWzBdWzBdO1xuICAgICAgICBleHBlY3QoZXJyb3IudHlwZSkudG9CZSgnZXJyb3InKTtcbiAgICAgICAgZXhwZWN0KGVycm9yLm1lc3NhZ2UpLnRvQmUoJ1VuY2F1Z2h0IFR5cGVFcnJvcjogQ2Fubm90IHJlYWQgcHJvcGVydHkgXFwnYXBwbHlcXCcgb2YgdW5kZWZpbmVkJyk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NpbXVsYXRlIHF1ZXVlaW5nIHRhc2tzIHdpdGggY3VzdG9tIHdvcmtlcicsICgpID0+IHtcbiAgICBsZXQgaGFja1dvcmtlcjtcbiAgICBsZXQgd29ya2VyO1xuICAgIGNvbnN0IHdvcmtlclJlcGx5SW4gPSAobWlsbGlTZWNvbmRzKSA9PiB7XG4gICAgICB3b3JrZXIucG9zdE1lc3NhZ2UgPSAobWVzc2FnZSkgPT4ge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB3b3JrZXIuZW1pdCgnbWVzc2FnZScsIHtkYXRhOiBtZXNzYWdlfSk7XG4gICAgICAgIH0sIG1pbGxpU2Vjb25kcyk7XG4gICAgICB9O1xuICAgIH07XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICB3b3JrZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgICB3b3JrZXIuYWRkRXZlbnRMaXN0ZW5lciA9IHdvcmtlci5hZGRMaXN0ZW5lcjtcbiAgICAgIHdvcmtlci50ZXJtaW5hdGUgPSAoKSA9PiAwO1xuICAgICAgd29ya2VyUmVwbHlJbig1KTtcbiAgICAgIGhhY2tXb3JrZXIgPSBuZXcgSGFja1dvcmtlcih7d29ya2VyLCB3ZWJXb3JrZXJUaW1lb3V0OiAxMCwgcG9vclBlcmZUaW1lb3V0OiAyMH0pO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICAgIGhhY2tXb3JrZXIuZGlzcG9zZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3F1ZXVlcyBhbmQgcHJvY2Vzc2VzIHR3byB0YXNrcyBpbiBvcmRlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IHRhc2sxSGFuZGxlciA9IGphc21pbmUuY3JlYXRlU3B5KCk7XG4gICAgICBoYWNrV29ya2VyLnJ1bldvcmtlclRhc2soJ3JlcGx5MScpLnRoZW4odGFzazFIYW5kbGVyKTtcbiAgICAgIGNvbnN0IHRhc2sySGFuZGxlciA9IGphc21pbmUuY3JlYXRlU3B5KCk7XG4gICAgICBoYWNrV29ya2VyLnJ1bldvcmtlclRhc2soJ3JlcGx5MicpLnRoZW4odGFzazJIYW5kbGVyKTtcbiAgICAgIGV4cGVjdCh0YXNrMUhhbmRsZXIuY2FsbENvdW50KS50b0JlKDApO1xuICAgICAgZXhwZWN0KHRhc2sySGFuZGxlci5jYWxsQ291bnQpLnRvQmUoMCk7XG4gICAgICB3aW5kb3cuYWR2YW5jZUNsb2NrKDYpO1xuICAgICAgd2FpdHMoMSk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRhc2sxSGFuZGxlci5jYWxsQ291bnQpLnRvQmUoMSk7XG4gICAgICAgIGV4cGVjdCh0YXNrMUhhbmRsZXIuYXJnc0ZvckNhbGxbMF1bMF0pLnRvQmUoJ3JlcGx5MScpO1xuICAgICAgICBleHBlY3QodGFzazJIYW5kbGVyLmNhbGxDb3VudCkudG9CZSgwKTtcbiAgICAgICAgd2luZG93LmFkdmFuY2VDbG9jayg2KTtcbiAgICAgIH0pO1xuICAgICAgd2FpdHMoMSk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRhc2sxSGFuZGxlci5jYWxsQ291bnQpLnRvQmUoMSk7XG4gICAgICAgIGV4cGVjdCh0YXNrMkhhbmRsZXIuY2FsbENvdW50KS50b0JlKDEpO1xuICAgICAgICBleHBlY3QodGFzazJIYW5kbGVyLmFyZ3NGb3JDYWxsWzBdWzBdKS50b0JlKCdyZXBseTInKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Rhc2sgdGltZW91dCB3YXJuaW5nLCB0aGVuIHRoZSByZXN1bHQnLCAoKSA9PiB7XG4gICAgICBjb25zdCB3YXJuSGFuZGxlciA9IGxvZ2dlci53YXJuID0gamFzbWluZS5jcmVhdGVTcHkoKTtcbiAgICAgIHdvcmtlclJlcGx5SW4oMTUpO1xuICAgICAgY29uc3QgdGFza0hhbmRsZXIgPSBqYXNtaW5lLmNyZWF0ZVNweSgpO1xuICAgICAgaGFja1dvcmtlci5ydW5Xb3JrZXJUYXNrKCdyZXBseScpLnRoZW4odGFza0hhbmRsZXIpO1xuICAgICAgd2luZG93LmFkdmFuY2VDbG9jaygxMSk7XG4gICAgICB3YWl0cygxKTtcbiAgICAgIHJ1bnMoKCkgPT4ge1xuICAgICAgICBleHBlY3QodGFza0hhbmRsZXIuY2FsbENvdW50KS50b0JlKDApO1xuICAgICAgICBleHBlY3Qod2FybkhhbmRsZXIuY2FsbENvdW50KS50b0JlKDEpO1xuICAgICAgICBleHBlY3Qod2FybkhhbmRsZXIuYXJnc0ZvckNhbGxbMF1bMF0pLnRvQmUoJ1dlYndvcmtlciBpcyBzdHVjayBpbiBhIGpvYiEnKTtcbiAgICAgICAgd2luZG93LmFkdmFuY2VDbG9jayg1KTtcbiAgICAgIH0pO1xuICAgICAgd2FpdHMoMSk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRhc2tIYW5kbGVyLmNhbGxDb3VudCkudG9CZSgxKTtcbiAgICAgICAgZXhwZWN0KHdhcm5IYW5kbGVyLmNhbGxDb3VudCkudG9CZSgxKTtcbiAgICAgICAgZXhwZWN0KHRhc2tIYW5kbGVyLmFyZ3NGb3JDYWxsWzBdWzBdKS50b0JlKCdyZXBseScpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgndGFzayB0aW1lb3V0IGFuZCBwZXJmIHdhcm5pbmdzLCB0aGVuIHRoZSByZXN1bHQsIHRoZW4gYSBub3JtYWwgdGFzayB0aW1lJywgKCkgPT4ge1xuICAgICAgY29uc3Qgd2FybkhhbmRsZXIgPSBsb2dnZXIud2FybiA9IGphc21pbmUuY3JlYXRlU3B5KCk7XG4gICAgICBjb25zdCB0YXNrMUhhbmRsZXIgPSBqYXNtaW5lLmNyZWF0ZVNweSgpO1xuICAgICAgY29uc3QgdGFzazJIYW5kbGVyID0gamFzbWluZS5jcmVhdGVTcHkoKTtcbiAgICAgIC8vIHNjaGVkdWxlIHRoZSBmaXJzdCB0YXNrIHdpdGggZXh0cmFvcmRpbmFyeSByZXNwb25zZSB0aW1lLlxuICAgICAgd29ya2VyUmVwbHlJbigyNSk7XG4gICAgICBoYWNrV29ya2VyLnJ1bldvcmtlclRhc2soJ3JlcGx5MScpLnRoZW4odGFzazFIYW5kbGVyKTtcbiAgICAgIC8vIHF1ZXVlIGFub3RoZXIgdGFzayB3aXRoIGEgbm9ybWFsIHRhc2sgdGltZS5cbiAgICAgIHdvcmtlclJlcGx5SW4oNSk7XG4gICAgICBoYWNrV29ya2VyLnJ1bldvcmtlclRhc2soJ3JlcGx5MicpLnRoZW4odGFzazJIYW5kbGVyKTtcbiAgICAgIHdpbmRvdy5hZHZhbmNlQ2xvY2soMTEpO1xuICAgICAgd2FpdHMoMSk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRhc2sxSGFuZGxlci5jYWxsQ291bnQpLnRvQmUoMCk7XG4gICAgICAgIGV4cGVjdCh0YXNrMkhhbmRsZXIuY2FsbENvdW50KS50b0JlKDApO1xuICAgICAgICBleHBlY3Qod2FybkhhbmRsZXIuY2FsbENvdW50KS50b0JlKDEpO1xuICAgICAgICBleHBlY3Qod2FybkhhbmRsZXIuYXJnc0ZvckNhbGxbMF1bMF0pLnRvQmUoJ1dlYndvcmtlciBpcyBzdHVjayBpbiBhIGpvYiEnKTtcbiAgICAgICAgd2luZG93LmFkdmFuY2VDbG9jaygxMSk7XG4gICAgICB9KTtcbiAgICAgIHdhaXRzKDEpO1xuICAgICAgcnVucygoKSA9PiB7XG4gICAgICAgIGV4cGVjdCh0YXNrMUhhbmRsZXIuY2FsbENvdW50KS50b0JlKDApO1xuICAgICAgICBleHBlY3QodGFzazJIYW5kbGVyLmNhbGxDb3VudCkudG9CZSgwKTtcbiAgICAgICAgZXhwZWN0KHdhcm5IYW5kbGVyLmNhbGxDb3VudCkudG9CZSgyKTtcbiAgICAgICAgZXhwZWN0KHdhcm5IYW5kbGVyLmFyZ3NGb3JDYWxsWzFdWzBdKS50b0JlKCdQb29yIFdlYndvcmtlciBQZXJmb3JtYW5jZSEnKTtcbiAgICAgICAgd2luZG93LmFkdmFuY2VDbG9jayg0KTtcbiAgICAgIH0pO1xuICAgICAgd2FpdHMoMSk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRhc2sxSGFuZGxlci5jYWxsQ291bnQpLnRvQmUoMSk7XG4gICAgICAgIGV4cGVjdCh0YXNrMUhhbmRsZXIuYXJnc0ZvckNhbGxbMF1bMF0pLnRvQmUoJ3JlcGx5MScpO1xuICAgICAgICBleHBlY3QodGFzazJIYW5kbGVyLmNhbGxDb3VudCkudG9CZSgwKTtcbiAgICAgICAgZXhwZWN0KHdhcm5IYW5kbGVyLmNhbGxDb3VudCkudG9CZSgyKTtcbiAgICAgICAgd2luZG93LmFkdmFuY2VDbG9jayg2KTtcbiAgICAgIH0pO1xuICAgICAgd2FpdHMoMSk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRhc2sySGFuZGxlci5jYWxsQ291bnQpLnRvQmUoMSk7XG4gICAgICAgIGV4cGVjdCh0YXNrMkhhbmRsZXIuYXJnc0ZvckNhbGxbMF1bMF0pLnRvQmUoJ3JlcGx5MicpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=
//# sourceURL=/Users/zhangxiaotian/.atom/packages/nuclide-hack/spec/HackWorker-spec.js
